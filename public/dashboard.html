<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARCA DASHBOARD | RPG</title>

    <!-- APP ICONS & MOBILE CONFIG -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="512x512" href="assets/icon-512.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#050508">

    <link href="styles/rpg-theme.css?v=4.3.0" rel="stylesheet">
    <link href="css_patch.css?v=4.3.0" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Outfit:wght@300;400;600&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .btn-filter {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #888;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            font-family: 'Outfit', sans-serif;
            margin-left: 5px;
            transition: all 0.2s;
        }

        .btn-filter:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .btn-filter.active {
            background: var(--cyan-holo);
            color: #000;
            border-color: var(--cyan-holo);
            font-weight: bold;
        }

        /* Deposit Form Responsive */
        .deposit-form {
            display: grid;
            grid-template-columns: 150px 120px 1fr auto;
            gap: 12px;
            align-items: end;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .deposit-form {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .deposit-form .note-field {
                grid-column: span 2;
            }

            .deposit-form .submit-btn {
                grid-column: span 2;
            }
        }

        @media (max-width: 480px) {
            .deposit-form {
                grid-template-columns: 1fr;
            }

            .deposit-form .note-field,
            .deposit-form .submit-btn {
                grid-column: span 1;
            }
        }

        /* Analytics Section Responsive */
        .analytics-grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .analytics-grid-streak {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .analytics-grid-4 {
                grid-template-columns: repeat(2, 1fr);
            }

            .analytics-grid-streak {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <div class="loading-overlay" id="loading"
        style="position:fixed; inset:0; background:#050508; display:flex; align-items:center; justify-content:center; z-index:9999; transition:opacity 0.5s;">
        <div class="loader"
            style="width:50px; height:50px; border:3px solid #333; border-top-color:var(--gold-primary); border-radius:50%; animation:spin 1s infinite linear;">
        </div>
    </div>

    <div class="container" style="max-width: 1600px; margin: 0 auto; padding: 20px;">

        <!-- HEADER / PROFILE -->
        <div class="elite-card profile-hero" style="margin-bottom: 30px;">
            <div style="position: relative;">
                <div class="avatar-hex" style="width: 100px; height: 100px;">
                    <img src="assets/avatar.png" alt="Commander" class="avatar-img">
                </div>
                <div class="level-badge" id="player-lvl" style="top: auto; bottom: -10px; width: max-content;">LVL 1
                </div>
            </div>

            <div class="hero-stats" style="padding-left: 20px;">
                <span class="hero-rank" id="player-title">INICIADO</span>
                <h1 class="hero-name" style="font-size: 1.8rem;">GAROSSA</h1>
                <div style="display: flex; align-items: center; gap: 15px; margin-top: 5px; max-width: 400px;">
                    <div
                        style="flex: 1; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden;">
                        <div id="xp-fill" style="width: 0%; height: 100%; background: var(--gold-primary);"></div>
                    </div>
                    <span style="font-size: 0.7rem; color: #888;" id="xp-text">0/0 XP</span>
                </div>

                <!-- Global Status Indicator -->
                <div style="margin-top: 10px; font-size: 0.75rem; color: var(--emerald-life); font-weight: 600;">
                    <span id="global-status-text">ESPERANDO SE√ëAL...</span>
                </div>
            </div>

            <div class="quest-mini-plate"
                style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; min-width: 300px;">
                <div style="font-size: 0.7rem; color: var(--gold-dim); margin-bottom: 5px;">üìú MISI√ìN ACTIVA</div>
                <div id="quest-name" style="color: #fff; font-weight: 600;">Sincronizando...</div>
                <div id="quest-status" style="font-size: 0.65rem; color: #888; margin-top: 5px;">-</div>
                <div id="quest-reward"
                    style="font-size: 0.7rem; color: var(--gold-primary); margin-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 6px;">
                </div>
            </div>
        </div>

        <!-- HERO STATS ROW (PROTAGONISTS) -->
        <div class="hero-stats-row">
            <!-- TOTAL REALIZADO -->
            <div class="hero-card hero-gold">
                <div class="hero-icon">üí∞</div>
                <div class="hero-content">
                    <span class="hero-label">TOTAL REALIZADO</span>
                    <span class="hero-val" id="total-profit">$0.00</span>
                </div>
            </div>

            <!-- GANANCIA NETA (MAIN) -->
            <div class="hero-card hero-emerald main-hero">
                <div class="hero-icon">üíπ</div>
                <div class="hero-content">
                    <span class="hero-label">GANANCIA NETA</span>
                    <span class="hero-val" id="cap-profit">$0.00</span>
                </div>
            </div>

            <!-- BOT√çN DIARIO -->
            <div class="hero-card hero-blue">
                <div class="hero-icon">üíé</div>
                <div class="hero-content">
                    <span class="hero-label">BOT√çN DIARIO</span>
                    <span class="hero-val" id="daily-profit">$0.00</span>
                </div>
            </div>
        </div>

        <!-- GLOBAL STATS ROW -->
        <div class="stats-hex-grid"
            style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 30px;">
            <!-- Cells Moved to Hero Row -->
            <div class="stat-cell">
                <span class="stat-label">Flotante</span>
                <span class="stat-val" id="unrealized-pnl">$0.00</span>
            </div>
            <div class="stat-cell">
                <span class="stat-label">Equity Global</span>
                <span class="stat-val cyan" id="global-equity">$0.00</span>
            </div>
            <div class="stat-cell">
                <span class="stat-label">ROI Total</span>
                <span class="stat-val" id="global-roi">0%</span>
            </div>
            <div class="stat-cell">
                <span class="stat-label">APY Global</span>
                <span class="stat-val gold" id="global-apy">~0%</span>
            </div>
            <div class="stat-cell">
                <span class="stat-label">√ìrdenes</span>
                <span class="stat-val" id="total-orders">0</span>
            </div>
        </div>

        <!-- COMPANION GRID (FULL SIZE) -->
        <h2
            style="margin-bottom: 25px; color: #fff; font-size: 1.2rem; border-bottom: 1px solid #333; padding-bottom: 10px;">
            üõ°Ô∏è ESP√çRITUS GUARDIANES
        </h2>

        <div class="companion-grid" id="bot-grid" style="gap: 20px;">
            <!-- INJECTED BY JS -->
        </div>

        <!-- CAPITAL TRACKER SECTION -->
        <div class="elite-card" style="margin-top: 30px; margin-bottom: 30px; padding: 25px;">
            <h3
                style="color: var(--gold-primary); margin-bottom: 20px; border-bottom: 1px solid rgba(255,215,0,0.2); padding-bottom: 10px;">
                üí∞ CAPITAL TRACKER
            </h3>

            <!-- Summary Cards -->
            <div class="stats-hex-grid" style="grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px;">
                <div class="stat-cell" style="background: rgba(255,215,0,0.05); border: 1px solid rgba(255,215,0,0.2);">
                    <span class="stat-label">üíµ Total Depositado</span>
                    <span class="stat-val" id="cap-deposited" style="color: #fff;">$0</span>
                </div>
                <div class="stat-cell" style="background: rgba(0,240,255,0.05); border: 1px solid rgba(0,240,255,0.2);">
                    <span class="stat-label">üìä Valor Actual</span>
                    <span class="stat-val cyan" id="cap-current">$0</span>
                </div>
                <div class="stat-cell" style="background: rgba(0,255,157,0.05); border: 1px solid rgba(0,255,157,0.2);">
                    <span class="stat-label">üìà Ganancia Neta</span>
                    <span class="stat-val" id="cap-profit-table" style="color: var(--emerald-life);">$0</span>
                </div>
                <div class="stat-cell"
                    style="background: rgba(138,43,226,0.05); border: 1px solid rgba(138,43,226,0.2);">
                    <span class="stat-label">üî• ROI Total</span>
                    <span class="stat-val" id="cap-roi" style="color: #ba55d3;">0%</span>
                </div>
            </div>

            <!-- Add Deposit Form -->
            <div class="deposit-form">
                <div>
                    <label style="font-size: 0.7rem; color: #888; display: block; margin-bottom: 4px;">üìÖ Fecha</label>
                    <input type="date" id="deposit-date"
                        style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; font-family: 'Outfit', sans-serif; box-sizing: border-box;">
                </div>
                <div>
                    <label style="font-size: 0.7rem; color: #888; display: block; margin-bottom: 4px;">üí≤ USDT</label>
                    <input type="number" id="deposit-amount" placeholder="500" step="0.01"
                        style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; font-family: 'Outfit', sans-serif; box-sizing: border-box;">
                </div>
                <div class="note-field">
                    <label style="font-size: 0.7rem; color: #888; display: block; margin-bottom: 4px;">üìù Nota
                        (opcional)</label>
                    <input type="text" id="deposit-note" placeholder="Dep√≥sito mensual"
                        style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; font-family: 'Outfit', sans-serif; box-sizing: border-box;">
                </div>
                <button class="submit-btn" onclick="addDeposit()"
                    style="padding: 10px 20px; background: var(--gold-primary); color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-family: 'Outfit', sans-serif; transition: all 0.2s; white-space: nowrap;">
                    ‚ûï AGREGAR
                </button>
            </div>

            <!-- Deposit History Table -->
            <div style="background: rgba(0,0,0,0.3); border-radius: 8px; overflow: hidden;">
                <div
                    style="display: grid; grid-template-columns: 1fr 1fr 2fr 60px; padding: 10px 15px; background: rgba(255,255,255,0.05); font-size: 0.7rem; color: #888; font-weight: bold;">
                    <div>FECHA</div>
                    <div>MONTO</div>
                    <div>NOTA</div>
                    <div style="text-align: center;">‚ùå</div>
                </div>
                <div id="deposit-history" style="max-height: 200px; overflow-y: auto;">
                    <div style="padding: 15px; text-align: center; color: #555; font-size: 0.8rem;">Cargando
                        dep√≥sitos...</div>
                </div>
            </div>
        </div>

        <!-- Chart 1: Capital vs Equity -->
        <div class="elite-card" style="margin-top: 30px; padding: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 1rem; color: var(--cyan-holo);">üìä Capital vs Equity
                </h3>
                <div class="chart-controls">
                    <button onclick="updateTimeframe(7, this)" class="btn-filter">7D</button>
                    <button onclick="updateTimeframe(30, this)" class="btn-filter active">30D</button>
                    <button onclick="updateTimeframe(90, this)" class="btn-filter">3M</button>
                    <button onclick="updateTimeframe('ALL', this)" class="btn-filter">MAX</button>
                </div>
            </div>
            <div style="height: 250px; position: relative;">
                <canvas id="equity-chart"></canvas>
            </div>
        </div>

        <!-- Chart 2: Profit Tracking -->
        <div class="elite-card" style="margin-top: 20px; padding: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 1rem; color: var(--gold-primary);">üí∞ Profit Acumulado
                </h3>
            </div>
            <div style="height: 200px; position: relative;">
                <canvas id="profit-chart"></canvas>
            </div>
        </div>

        <!-- PERFORMANCE ANALYTICS SECTION -->
        <div class="elite-card" style="margin-top: 20px; padding: 25px;">
            <h3 style="margin: 0 0 20px 0; font-size: 1rem; color: var(--emerald-life);">üìà PERFORMANCE ANALYTICS</h3>

            <!-- ROI Cards Row -->
            <div class="analytics-grid-4" style="margin-bottom: 20px;">
                <div class="summary-card"
                    style="background: rgba(0,255,157,0.05); border: 1px solid rgba(0,255,157,0.2);">
                    <span class="stat-label">Hoy</span>
                    <span class="stat-val" id="roi-today" style="color: var(--emerald-life);">0%</span>
                </div>
                <div class="summary-card"
                    style="background: rgba(0,240,255,0.05); border: 1px solid rgba(0,240,255,0.2);">
                    <span class="stat-label">7 D√≠as</span>
                    <span class="stat-val" id="roi-weekly" style="color: var(--cyan-holo);">0%</span>
                </div>
                <div class="summary-card"
                    style="background: rgba(255,215,0,0.05); border: 1px solid rgba(255,215,0,0.2);">
                    <span class="stat-label">30 D√≠as</span>
                    <span class="stat-val" id="roi-monthly" style="color: var(--gold-primary);">0%</span>
                </div>
                <div class="summary-card"
                    style="background: rgba(138,43,226,0.05); border: 1px solid rgba(138,43,226,0.2);">
                    <span class="stat-label">Total</span>
                    <span class="stat-val" id="roi-alltime" style="color: #ba55d3;">0%</span>
                </div>
            </div>

            <!-- Stats Row -->
            <div class="analytics-grid-4" style="margin-bottom: 20px;">
                <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--emerald-life);" id="win-rate">0%
                    </div>
                    <div style="font-size: 0.65rem; color: #888;">Win Rate</div>
                </div>
                <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--gold-primary);" id="avg-daily">$0
                    </div>
                    <div style="font-size: 0.65rem; color: #888;">Promedio Diario</div>
                </div>
                <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: var(--cyan-holo);" id="best-day">$0</div>
                    <div style="font-size: 0.65rem; color: #888;">üèÜ Mejor D√≠a</div>
                </div>
                <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                    <div style="font-size: 1rem; color: #ff6b6b;" id="max-drawdown">0%</div>
                    <div style="font-size: 0.65rem; color: #888;">üìâ Max Drawdown</div>
                </div>
            </div>

            <!-- Streak & Bot Leaderboard -->
            <div class="analytics-grid-streak">
                <!-- Streak Card -->
                <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px;">
                    <div style="font-size: 0.75rem; color: #888; margin-bottom: 10px;">üî• RACHA ACTUAL</div>
                    <div id="streak-display" style="font-size: 1.8rem; font-weight: bold; color: var(--emerald-life);">0
                    </div>
                    <div id="streak-type" style="font-size: 0.7rem; color: #666;">d√≠as</div>
                    <div style="margin-top: 10px; font-size: 0.65rem; color: #555;">
                        Record: <span id="longest-win" style="color: var(--emerald-life);">0</span> d√≠as positivos
                    </div>
                </div>
                <!-- Bot Leaderboard -->
                <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px;">
                    <div style="font-size: 0.75rem; color: #888; margin-bottom: 10px;">üèÖ BOT LEADERBOARD</div>
                    <div id="bot-leaderboard" style="font-size: 0.75rem;">
                        <div style="color: #555;">Cargando...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LOGS SECTION (CR√ìNICAS) -->
        <div class="elite-card logs-section" style="margin-top: 30px; padding: 20px;">
            <h3 style="color: var(--cyan-holo); margin-bottom: 20px;">üìú CR√ìNICAS DEL SISTEMA</h3>
            <div class="logs-list" id="logs-list">
                <div class="log-item"><span class="log-msg">Sintonizando el Vacio...</span></div>
            </div>
        </div>

        <!-- DEBUG CONSOLE -->
        <div class="footer" style="margin-top: 30px; font-size: 0.7rem; color: #444; text-align: center;">
            <div id="last-update">Sincronizando...</div>
        </div>
    </div>

    <script>
        // === CONFIG ===
        const BOTS = [
            { id: 'btc', name: 'IGNIS', role: 'Esp√≠ritu de Fuego (BTC)', icon: 'üî•', url: '/' },
            { id: 'sol', name: 'VENTUS', role: 'Esp√≠ritu de Viento (SOL)', icon: 'üå¨Ô∏è', url: '/sol/' },
            { id: 'doge', name: 'FANG', role: 'Esp√≠ritu de Manada (DOGE)', icon: 'üê∫', url: '/doge/' }
        ];

        const ASSETS = {
            'btc': 'assets/spirit-btc.png',
            'sol': 'assets/spirit-sol.png',
            'doge': 'assets/spirit-doge.png'
        };

        // State
        let GLOBAL_EQUITY = 0;
        let GLOBAL_FULL_HISTORY = [];
        let CURRENT_TIMEFRAME = 30;
        let LAST_RENDERED_EQUITY = -1;

        function logDebug(msg) { console.log(msg); }

        // === RENDER ===
        function renderCompanions() {
            const grid = document.getElementById('bot-grid');
            if (!grid) return;

            grid.innerHTML = BOTS.map(bot => `
                <div class="elite-card companion-full-card ${bot.id}" id="card-${bot.id}" style="display: flex; flex-direction: column; overflow: hidden; min-height: 500px;">
                    <!-- IMAGE HERO SECTION -->
                    <div style="height: 220px; position: relative; overflow: hidden; background: #000;">
                        <!-- Status Indicator -->
                        <div style="position: absolute; top: 15px; left: 15px; z-index: 10; display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);">
                            <div class="pulse-dot" id="dot-${bot.id}" style="width: 10px; height: 10px;"></div>
                            <span id="status-label-${bot.id}" style="color: #fff; font-weight: bold; font-size: 0.8rem;">INIT...</span>
                        </div>
                        <div style="position: absolute; top: 15px; right: 15px; z-index: 10;">
                             <span class="c-regime-badge" id="regime-${bot.id}" style="background: rgba(0,0,0,0.8); padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; color: #fff; border: 1px solid #333;">-</span>
                        </div>
                        <img src="${ASSETS[bot.id]}" alt="${bot.name}" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.9; mask-image: linear-gradient(to bottom, black 20%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%);">
                        <div style="position: absolute; bottom: 10px; left: 15px;">
                            <h2 style="margin: 0; font-size: 2rem; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.8);">${bot.name}</h2>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8);">${bot.role}</div>
                        </div>
                    </div>

                    <!-- DATA SECTION -->
                    <div style="padding: 20px; flex: 1; display: flex; flex-direction: column; gap: 15px; background: rgba(10,10,15,0.95);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="background: rgba(255,255,255,0.03); padding: 10px; border-radius: 6px;">
                                <div style="font-size: 0.65rem; color: #666;">PRECIO</div>
                                <div id="price-${bot.id}" style="font-size: 1.1rem; color: #fff;">-</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.03); padding: 10px; border-radius: 6px;">
                                <div style="font-size: 0.65rem; color: #666;">PROFIT TOTAL</div>
                                <div id="profit-${bot.id}" style="font-size: 1.1rem; color: var(--gold-primary);">-</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <div>
                                <div style="font-size: 0.65rem; color: #666;">HOY</div>
                                <div id="daily-${bot.id}" style="font-size: 0.9rem; color: #eee;">-</div>
                            </div>
                            <div>
                                <div style="font-size: 0.65rem; color: #666;">ROI</div>
                                <div id="roi-${bot.id}" style="font-size: 0.9rem; color: #eee;">-</div>
                            </div>
                            <div>
                                <div style="font-size: 0.65rem; color: #666;">APY</div>
                                <div id="apy-${bot.id}" style="font-size: 0.9rem; color: var(--gold-primary);">-</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; text-align: center; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 15px;">
                            <div>
                                <div style="font-size: 0.6rem; color: #555;">WINRATE</div>
                                <div id="winrate-${bot.id}" style="font-size: 1rem; color: #fff;">-</div>
                                <div id="trades-${bot.id}" style="font-size: 0.6rem; color: #444;">0 trades</div>
                            </div>
                            <div>
                                <div style="font-size: 0.6rem; color: #555;">ORDENES</div>
                                <div id="orders-${bot.id}" style="font-size: 1rem; color: #fff;">-</div>
                                <div id="lots-${bot.id}" style="font-size: 0.6rem; color: #444;">0 lots</div>
                            </div>
                            <div>
                                <div style="font-size: 0.6rem; color: #555;">SCORE</div>
                                <div id="score-${bot.id}" style="font-size: 1rem; color: #fff;">-</div>
                            </div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; font-size: 0.75rem;">
                            <div style="color: #666; margin-bottom: 2px;">√öLTIMO TRADE</div>
                            <div id="last-trade-${bot.id}" style="color: #ccc;">Sin actividad reciente</div>
                        </div>
                        <div id="blocking-${bot.id}" style="display: none; background: rgba(255,100,100,0.1); border: 1px solid rgba(255,100,100,0.2); color: var(--ruby-danger); padding: 8px; font-size: 0.7rem; border-radius: 4px;"></div>
                        <div style="margin-top: auto; padding-top: 10px;">
                            <a href="${bot.url}" style="display: block; width: 100%; box-sizing: border-box; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #fff; text-align: center; text-decoration: none; font-size: 0.8rem; border-radius: 6px; transition: background 0.2s;">
                                ACCESO A TERMINAL &rarr;
                            </a>
                        </div>
                        <div id="debug-${bot.id}" style="font-size: 0.6rem; color: #ff2a6d; margin-top: 5px; min-height: 15px;"></div>
                    </div>
                </div>
            `).join('');
        }

        // === LOGIC ===
        async function fetchAllData() {
            let tProfit = 0, tDaily = 0, tUnreal = 0, tOrders = 0, tEquity = 0, tYesterday = 0, tDailyTrades = 0;
            let botsActive = 0;
            let allLogs = [];

            for (const bot of BOTS) {
                try {
                    const url = bot.url === '/' ? '/api/status' : `${bot.url}api/status`;
                    const res = await fetch(url);
                    if (res.ok) {
                        const data = await res.json();
                        updateBotUI(bot.id, data);
                        if (data.status !== "stopped") botsActive++;

                        tProfit += data.totalProfit || 0;
                        tDaily += data.dailyProfit || 0;
                        tYesterday += data.yesterdayProfit || 0;
                        tUnreal += data.unrealizedPnL || 0;
                        tOrders += data.activeOrders || 0;
                        tDailyTrades += data.dailyTrades || 0;

                        if (data.recentLogs && data.recentLogs.length > 0) {
                            data.recentLogs.forEach(log => {
                                allLogs.push({ ...log, bot: bot.id });
                            });
                        }
                    } else {
                        updateBotOffline(bot.id, "API ERROR");
                    }
                } catch (e) {
                    updateBotOffline(bot.id, 'NET ERR');
                }
            }

            const globalStatusEl = document.getElementById('global-status-text');
            if (globalStatusEl) {
                globalStatusEl.innerText = `SISTEMA: ${botsActive} / 3 CONSTRUCTOS ONLINE`;
                globalStatusEl.style.color = botsActive === 3 ? 'var(--emerald-life)' : botsActive > 0 ? 'var(--gold-primary)' : 'var(--ruby-danger)';
            }

            try {
                const eqRes = await fetch('/api/balance');
                if (eqRes.ok) {
                    const eqData = await eqRes.json();
                    if (eqData.totalEquity) tEquity = eqData.totalEquity;
                }
            } catch (e) { }

            // Store Global Equity for Chart
            GLOBAL_EQUITY = tEquity;

            document.getElementById('total-profit').innerText = `$${tProfit.toFixed(2)}`;

            const dailyEl = document.getElementById('daily-profit');
            dailyEl.style.display = 'flex';
            dailyEl.style.flexDirection = 'column';
            dailyEl.style.alignItems = 'center';
            dailyEl.style.lineHeight = '1.2';
            dailyEl.innerHTML = `
                <span style="font-size: 1.5rem; color: #fff; margin-top: 5px;">$${tDaily.toFixed(2)}</span>
                <span style="font-size: 0.65rem; color: #aaa; margin-top: 4px;">(${tDailyTrades} trades ¬∑ Ayer: $${tYesterday.toFixed(2)})</span>
            `;

            document.getElementById('unrealized-pnl').innerText = `$${tUnreal.toFixed(2)}`;
            document.getElementById('unrealized-pnl').className = `stat-val ${tUnreal >= 0 ? '' : 'neg'}`;
            document.getElementById('global-equity').innerText = `$${tEquity.toFixed(2)}`;
            document.getElementById('total-orders').innerText = tOrders;

            updateLogs(allLogs);

            if (tEquity > tProfit) {
                const roi = (tProfit / (tEquity - tProfit)) * 100;
                document.getElementById('global-roi').innerText = `${roi.toFixed(1)}%`;

                // Calculate Global APY using Time-Weighted Return
                const deposits = window.DEPOSIT_DATA?.deposits || [];
                if (deposits.length > 0) {
                    // Sort deposits by date
                    const sortedDeposits = [...deposits].sort((a, b) =>
                        new Date(a.date).getTime() - new Date(b.date).getTime()
                    );

                    const now = Date.now();
                    let totalWeightedCapital = 0;
                    let totalDays = 0;
                    let runningCapital = 0;

                    // Calculate TWR capital for each period
                    for (let i = 0; i < sortedDeposits.length; i++) {
                        const deposit = sortedDeposits[i];
                        const depositDate = new Date(deposit.date).getTime();
                        const nextDate = (i < sortedDeposits.length - 1)
                            ? new Date(sortedDeposits[i + 1].date).getTime()
                            : now;

                        runningCapital += deposit.amount;
                        const periodDays = Math.max(0, (nextDate - depositDate) / (1000 * 60 * 60 * 24));

                        totalWeightedCapital += runningCapital * periodDays;
                        totalDays += periodDays;
                    }

                    const twrCapital = totalDays > 0 ? (totalWeightedCapital / totalDays) : runningCapital;
                    const daysActive = totalDays || 1;

                    // APY = (Profit / TWR Capital) / Days * 365
                    const globalROI = twrCapital > 0 ? (tProfit / twrCapital) * 100 : 0;
                    const globalAPY = (globalROI / daysActive) * 365;

                    const apyEl = document.getElementById('global-apy');
                    if (apyEl) {
                        apyEl.innerText = `~${globalAPY.toFixed(0)}%`;
                        apyEl.style.color = globalAPY >= 50 ? 'var(--emerald-life)' : globalAPY >= 20 ? 'var(--gold-primary)' : '#fff';
                    }
                }
            }

            document.getElementById('loading').style.opacity = 0;
            setTimeout(() => document.getElementById('loading').style.display = 'none', 500);
            document.getElementById('last-update').innerText = 'ACTUALIZADO: ' + new Date().toLocaleTimeString();

            // Re-render chart if we have history and Equity changed significantly (fixing the 0 -> Value jump)
            if (GLOBAL_FULL_HISTORY.length > 0 && Math.abs(GLOBAL_EQUITY - LAST_RENDERED_EQUITY) > 0.5) {
                renderChart(GLOBAL_FULL_HISTORY);
            }
        }

        function updateBotUI(id, data) {
            document.getElementById(`regime-${id}`).innerText = data.marketRegime || 'NEUTRAL';
            const dot = document.getElementById(`dot-${id}`);
            const statusLbl = document.getElementById(`status-label-${id}`);

            if (dot) {
                dot.style.background = 'var(--emerald-life)';
                dot.style.boxShadow = '0 0 10px var(--emerald-life)';
            }

            if (statusLbl) {
                if (data.smartDcaBlocking) {
                    statusLbl.innerText = "BLOCKED";
                    statusLbl.style.color = "var(--gold-primary)";
                } else if (data.isPaused) {
                    statusLbl.innerText = "PAUSED";
                    statusLbl.style.color = "var(--ruby-danger)";
                    if (dot) { dot.style.background = 'var(--ruby-danger)'; dot.style.boxShadow = 'none'; }
                } else {
                    statusLbl.innerText = "ONLINE";
                    statusLbl.style.color = "var(--emerald-life)";
                }
            }

            const debugEl = document.getElementById(`debug-${id}`);
            if (debugEl) debugEl.innerText = "";

            const profitEl = document.getElementById(`profit-${id}`);
            if (profitEl) profitEl.innerText = `$${(data.totalProfit || 0).toFixed(2)}`;

            const price = data.currentPrice || 0;
            const priceEl = document.getElementById(`price-${id}`);
            if (priceEl) priceEl.innerText = price > 1000 ? `$${price.toFixed(0)}` : price > 1 ? `$${price.toFixed(2)}` : `$${price.toFixed(4)}`;

            const roiEl = document.getElementById(`roi-${id}`);
            if (roiEl) roiEl.innerText = `${(data.roi || 0).toFixed(2)}%`;

            // APY display
            const apyEl = document.getElementById(`apy-${id}`);
            if (apyEl) {
                const apy = data.apy || 0;
                apyEl.innerText = `~${apy.toFixed(0)}%`;
                apyEl.style.color = apy >= 50 ? 'var(--emerald-life)' : apy >= 20 ? 'var(--gold-primary)' : '#eee';
            }

            const dailyEl = document.getElementById(`daily-${id}`);
            if (dailyEl) dailyEl.innerText = `$${(data.dailyProfit || 0).toFixed(2)}`;

            const winRate = data.winRate || 0;
            const wrEl = document.getElementById(`winrate-${id}`);
            if (wrEl) {
                wrEl.innerText = `${winRate.toFixed(0)}%`;
                wrEl.style.color = winRate >= 70 ? 'var(--emerald-life)' : winRate >= 50 ? 'var(--gold-primary)' : 'var(--ruby-danger)';
            }
            const tradesEl = document.getElementById(`trades-${id}`);
            if (tradesEl) tradesEl.innerText = `${data.totalTrades || 0} trades`;
            const scoreEl = document.getElementById(`score-${id}`);
            if (scoreEl) scoreEl.innerText = data.score || 50;
            const ordersEl = document.getElementById(`orders-${id}`);
            if (ordersEl) ordersEl.innerText = data.activeOrders || 0;
            const lotsEl = document.getElementById(`lots-${id}`);
            if (lotsEl) lotsEl.innerText = data.inventoryLots || 0;

            const lastTradeEl = document.getElementById(`last-trade-${id}`);
            if (lastTradeEl) {
                if (data.lastTrade) {
                    const now = Date.now();
                    const tradeTime = new Date(data.lastTrade.timestamp).getTime();
                    const diffMins = Math.floor((now - tradeTime) / 60000);
                    let timeAgo = diffMins < 60 ? `${diffMins}m ago` : `${Math.floor(diffMins / 60)}h ago`;
                    const side = data.lastTrade.side.toUpperCase();
                    const profit = data.lastTrade.profit ? `(+$${data.lastTrade.profit.toFixed(2)})` : '';
                    const color = side === 'SELL' ? 'var(--emerald-life)' : '#fff';
                    lastTradeEl.innerHTML = `<span style="color:${color}; font-weight:bold;">${side}</span> ${profit} <span style="opacity:0.6">¬∑ ${timeAgo}</span>`;
                } else {
                    lastTradeEl.innerText = "Sin actividad reciente";
                }
            }

            const blockEl = document.getElementById(`blocking-${id}`);
            if (blockEl) {
                if (data.blockingReason || data.isPaused) {
                    blockEl.style.display = 'block';
                    blockEl.innerText = `‚ö†Ô∏è ${data.blockingReason || 'PAUSADO'}`;
                } else {
                    blockEl.style.display = 'none';
                }
            }
        }

        function updateBotOffline(id, reason = "OFFLINE") {
            const dot = document.getElementById(`dot-${id}`);
            const statusLbl = document.getElementById(`status-label-${id}`);
            if (dot) dot.style.background = '#555';
            if (statusLbl) { statusLbl.innerText = reason; statusLbl.style.color = "#888"; }
        }

        function updateLogs(logs) {
            const logsList = document.getElementById('logs-list');
            if (!logs || logs.length === 0) {
                logsList.innerHTML = '<div class="log-item"><span class="log-msg">Sin actividad reciente... el Vacio est√° en calma.</span></div>';
                return;
            }
            const sorted = logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 20);
            logsList.innerHTML = sorted.map(log => {
                const time = log.timestamp ? new Date(log.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : '--:--';
                const botClass = log.bot || 'sys';
                return `<div class="log-item"><span class="log-time">${time}</span><span class="log-bot ${botClass}">${(log.bot || 'SYS').toUpperCase()}</span><span class="log-msg">${log.message || log.type || '-'}</span></div>`;
            }).join('');
        }

        async function fetchRPG() {
            try {
                const res = await fetch('/api/rpg');
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('player-lvl').innerText = `LVL ${data.level || 1} `;
                    document.getElementById('player-title').innerText = data.title || 'INICIADO';
                    document.getElementById('xp-text').innerText = `${data.xp} / ${data.nextLevelXp} XP`;
                    document.getElementById('xp-fill').style.width = `${data.xpProgress}%`;
                    if (data.quest) {
                        document.getElementById('quest-name').innerText = data.quest.name;
                        document.getElementById('quest-status').innerText = data.quest.status === 'COMPLETED' ? 'COMPLETADA' : 'EN PROGRESO';
                        document.getElementById('quest-status').style.color = data.quest.status === 'COMPLETED' ? 'var(--emerald-life)' : 'var(--gold-primary)';
                        if (data.quest.reward) document.getElementById('quest-reward').innerText = `üèÜ RECOMPENSA: ${data.quest.reward}`;
                    }
                }
            } catch (e) { }
        }

        async function fetchChart() {
            try {
                const res = await fetch('/api/profit-history');
                if (res.ok) {
                    const data = await res.json();
                    if (data.history && data.history.length > 0) {
                        GLOBAL_FULL_HISTORY = data.history;
                        renderChart(GLOBAL_FULL_HISTORY);
                    }
                }
            } catch (e) { logDebug("Chart API error: " + e.message); }
        }

        function updateTimeframe(days, btn) {
            CURRENT_TIMEFRAME = days;
            document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            renderChart(GLOBAL_FULL_HISTORY);
        }

        function fillGaps(history) {
            if (!history || history.length < 2) return history;

            // Sort by date ascending
            const sorted = [...history].sort((a, b) => new Date(a.date) - new Date(b.date));

            const filled = [];

            // Get TODAY in CDMX timezone (UTC-6) as string
            const nowUTC = Date.now();
            const cdmxMs = nowUTC - (6 * 60 * 60 * 1000); // Subtract 6 hours for CDMX
            const cdmxNow = new Date(cdmxMs);
            const todayStr = cdmxNow.toISOString().split('T')[0];

            // Use string-based date comparison to avoid timezone issues
            const startStr = sorted[0].date;
            const endStr = sorted[sorted.length - 1].date;
            // NEVER show dates past today - todayStr is the absolute cap
            const finalStr = todayStr;

            console.log('[Chart Debug] Today (CDMX):', todayStr, 'EndStr:', endStr, 'Final (capped):', finalStr);

            const dateMap = new Map();
            sorted.forEach(h => dateMap.set(h.date, h));

            // Generate all dates from start to final (inclusive) using strings
            let currentDate = new Date(startStr + 'T12:00:00Z'); // Use noon UTC to avoid edge cases

            while (true) {
                const dayStr = currentDate.toISOString().split('T')[0];

                if (dayStr > finalStr) break; // Stop AFTER final date

                if (dateMap.has(dayStr)) {
                    filled.push(dateMap.get(dayStr));
                } else {
                    // Gap found: Insert 0 profit day
                    filled.push({ date: dayStr, profit: 0, equity: 0, capital: 0, isGap: true });
                }

                // Add 1 day
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return filled;
        }

        let GLOBAL_FINANCIAL_HISTORY = [];
        window.GLOBAL_MARKET_HISTORY = {}; // Changed to object and window scope for renderChart access

        // NOTE: /api/market-history endpoint doesn't exist - using equity-snapshots instead
        async function fetchMarketHistory() {
            // This endpoint doesn't exist, skip it
            // Equity snapshots are loaded via fetchEquitySnapshots() instead
            console.log('[Chart] Market History skipped - using equity-snapshots');
        }

        // Fetch REAL daily equity snapshots from Binance (recorded by bot)
        async function fetchEquitySnapshots() {
            try {
                const res = await fetch('/api/equity-snapshots');
                const data = await res.json();
                if (data && Array.isArray(data.snapshots)) {
                    // Inject snapshots into window.GLOBAL_MARKET_HISTORY for chart rendering
                    window.GLOBAL_MARKET_HISTORY.equitySnapshots = data.snapshots;
                    console.log("Loaded Equity Snapshots:", data.snapshots.length, "days", data.snapshots);
                    // Re-render chart with real data
                    if (GLOBAL_FULL_HISTORY.length > 0) {
                        renderChart(GLOBAL_FULL_HISTORY);
                    }
                }
            } catch (e) { console.error("Equity Snapshots fetch failed", e); }
        }
        fetchEquitySnapshots(); // Load on page load

        // NOTE: /api/financial-history endpoint doesn't exist - not needed for chart
        async function fetchFinancialHistory() {
            // This endpoint doesn't exist, skip it
            console.log('[Chart] Financial History skipped - not needed');
        }

        function renderChart(historyRaw) {
            LAST_RENDERED_EQUITY = GLOBAL_EQUITY;

            // 1. FILL GAPS first
            const history = fillGaps(historyRaw);

            // 2. FILTER
            let filtered = [];
            let startIndex = 0;
            if (CURRENT_TIMEFRAME === 'ALL') {
                filtered = history;
                startIndex = 0;
            } else {
                const limit = parseInt(CURRENT_TIMEFRAME) || 30;
                filtered = history.slice(-limit);
                startIndex = Math.max(0, history.length - limit);
            }

            // 3. PREPARE DATA - Robust Deposit & Equity Calculation
            let currentDepositSum = 0;
            const depositsCumulative = [];
            const equityReconstructed = [];

            // Helper: Get sorted deposits
            let sortedDeposits = [];
            if (window.DEPOSIT_DATA && window.DEPOSIT_DATA.deposits) {
                sortedDeposits = [...window.DEPOSIT_DATA.deposits].sort((a, b) => a.date.localeCompare(b.date));
            }

            // A. Calculate Cumulative Profits first
            let runningProfit = 0;
            const profitCumulative = history.map(h => {
                runningProfit += (h.profit || 0);
                return runningProfit;
            });

            // B. Build Deposit Curve synchronous with History
            let depIndex = 0;

            // Pre-calculate deposits before history start
            if (history.length > 0) {
                const startDate = history[0].date;
                while (depIndex < sortedDeposits.length && sortedDeposits[depIndex].date < startDate) {
                    currentDepositSum += sortedDeposits[depIndex].amount;
                    depIndex++;
                }
            }

            history.forEach((h, i) => {
                // Add deposits for this specific day
                while (depIndex < sortedDeposits.length && sortedDeposits[depIndex].date === h.date) {
                    currentDepositSum += sortedDeposits[depIndex].amount;
                    depIndex++;
                }

                depositsCumulative.push(currentDepositSum);

                // Reconstruct Equity: Capital + Realized Profit
                // This gives the "floor" equity (ignoring unrealized PnL)
                equityReconstructed.push(currentDepositSum + profitCumulative[i]);
            });

            // C. Equity Curve Scaling with Volatility (Market-Aware)

            const realCurrentEquity = window.DEPOSIT_DATA?.currentEquity || currentDepositSum;
            const lastReconstructed = equityReconstructed[equityReconstructed.length - 1];

            // 1. Calculate Base Scaling (Book Value -> Book Equity)
            let baseScalingFactor = 1;
            if (lastReconstructed > 0 && realCurrentEquity > 0) {
                baseScalingFactor = realCurrentEquity / lastReconstructed;
            }

            // 2. Apply Price Volatility using GLOBAL_MARKET_HISTORY
            // K-Lines provide true daily volatility

            // Map Market History to Dates
            const priceMap = new Map();
            const snapshotMap = new Map(); // NEW: Hard Data Map

            if (window.GLOBAL_MARKET_HISTORY) {
                if (Array.isArray(window.GLOBAL_MARKET_HISTORY.history)) {
                    window.GLOBAL_MARKET_HISTORY.history.forEach(p => priceMap.set(p.date, p.price));
                }
                if (Array.isArray(window.GLOBAL_MARKET_HISTORY.equitySnapshots)) {
                    window.GLOBAL_MARKET_HISTORY.equitySnapshots.forEach(s => snapshotMap.set(s.date, s.equity));
                    console.log('[Chart] snapshotMap loaded:', snapshotMap.size, 'entries', [...snapshotMap.entries()]);
                } else {
                    console.log('[Chart] No equitySnapshots found in GLOBAL_MARKET_HISTORY');
                }
            }

            // Find current price (last available) or from deposit data
            let currentPrice = 0;
            if (window.GLOBAL_MARKET_HISTORY && window.GLOBAL_MARKET_HISTORY.history && window.GLOBAL_MARKET_HISTORY.history.length > 0) {
                currentPrice = window.GLOBAL_MARKET_HISTORY.history[window.GLOBAL_MARKET_HISTORY.history.length - 1].price;
            }

            // Build clean equity curve: JUST deposits + profit (no scaling or volatility)
            const equityCurve = equityReconstructed.map((val, i) => {
                const date = history[i].date;

                // PRIORITY 1: Use real Binance snapshot if available
                if (snapshotMap.has(date)) {
                    return snapshotMap.get(date);
                }

                // PRIORITY 2: Use reconstructed value (deposits + cumulative profit)
                // NO volatility adjustment - this causes the weird fluctuations
                return val;
            });

            const slicedEquity = equityCurve.slice(startIndex);
            const slicedDeposits = depositsCumulative.slice(startIndex);
            const slicedProfits = filtered.map(h => h.profit);
            const slicedLabels = filtered.map(h => h.date.substring(5));

            // Cumulative profit for Chart 2
            let runningTotal = 0;
            const absoluteCumulative = history.map(h => {
                runningTotal += (h.profit || 0);
                return runningTotal;
            });
            const slicedCumulative = absoluteCumulative.slice(startIndex);

            // Colors
            const COLOR_GOLD = '#ffd700';
            const COLOR_CYAN = '#00f0ff';
            const COLOR_ORANGE = '#ff8c00';
            const COLOR_EMERALD = '#00ff9d';
            const COLOR_GRID = 'rgba(255, 255, 255, 0.05)';
            const FONT_UI = "'Outfit', sans-serif";

            // ========== CHART 1: Capital vs Equity ==========
            const canvas1 = document.getElementById('equity-chart');
            if (canvas1) {
                if (window.equityChart instanceof Chart) window.equityChart.destroy();
                const ctx1 = canvas1.getContext('2d');

                const gradfillCyan = ctx1.createLinearGradient(0, 0, 0, 250);
                gradfillCyan.addColorStop(0, 'rgba(0, 240, 255, 0.2)');
                gradfillCyan.addColorStop(1, 'rgba(0, 240, 255, 0.0)');

                window.equityChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: slicedLabels,
                        datasets: [
                            {
                                label: 'Equity Total',
                                data: slicedEquity,
                                borderColor: COLOR_CYAN,
                                backgroundColor: gradfillCyan,
                                borderWidth: 2,
                                pointRadius: 2,
                                pointHoverRadius: 5,
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'Capital Invertido',
                                data: slicedDeposits.length > 0 ? slicedDeposits : null,
                                borderColor: COLOR_ORANGE,
                                backgroundColor: 'rgba(255, 140, 0, 0.1)',
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: false,
                                stepped: 'before'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { display: true, labels: { color: '#ccc', font: { family: FONT_UI, size: 10 }, usePointStyle: true } },
                            tooltip: {
                                backgroundColor: 'rgba(10, 10, 16, 0.95)',
                                callbacks: {
                                    label: ctx => `${ctx.dataset.label}: $${ctx.parsed.y.toFixed(2)}`
                                }
                            }
                        },
                        scales: {
                            x: { grid: { color: COLOR_GRID }, ticks: { color: '#666', font: { size: 10 } } },
                            y: {
                                beginAtZero: false,
                                grid: { color: COLOR_GRID },
                                ticks: { color: COLOR_CYAN, callback: v => '$' + v }
                            }
                        }
                    }
                });
            }

            // ========== CHART 2: Profit Tracking ==========
            const canvas2 = document.getElementById('profit-chart');
            if (canvas2) {
                if (window.profitChart instanceof Chart) window.profitChart.destroy();
                const ctx2 = canvas2.getContext('2d');

                const gradfillGold = ctx2.createLinearGradient(0, 0, 0, 200);
                gradfillGold.addColorStop(0, 'rgba(255, 215, 0, 0.2)');
                gradfillGold.addColorStop(1, 'rgba(255, 215, 0, 0.0)');

                window.profitChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: slicedLabels,
                        datasets: [
                            {
                                label: 'Profit Acumulado',
                                data: slicedCumulative,
                                type: 'line',
                                borderColor: COLOR_GOLD,
                                backgroundColor: gradfillGold,
                                borderWidth: 2,
                                pointRadius: 2,
                                fill: true,
                                tension: 0.3,
                                yAxisID: 'y_cumulative',
                                order: 0
                            },
                            {
                                label: 'Bot√≠n Diario',
                                data: slicedProfits,
                                backgroundColor: ctx => (ctx.raw || 0) >= 0 ? 'rgba(0, 255, 157, 0.7)' : 'rgba(255, 42, 109, 0.7)',
                                borderColor: ctx => (ctx.raw || 0) >= 0 ? COLOR_EMERALD : '#ff2a6d',
                                borderWidth: 1,
                                borderRadius: 3,
                                yAxisID: 'y_daily',
                                order: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { display: true, labels: { color: '#ccc', font: { family: FONT_UI, size: 10 }, usePointStyle: true } },
                            tooltip: {
                                backgroundColor: 'rgba(10, 10, 16, 0.95)',
                                callbacks: {
                                    label: ctx => `${ctx.dataset.label}: $${ctx.parsed.y.toFixed(2)}`
                                }
                            }
                        },
                        scales: {
                            x: { grid: { color: COLOR_GRID }, ticks: { color: '#666', font: { size: 10 } } },
                            y_daily: {
                                type: 'linear',
                                position: 'left',
                                grid: { color: COLOR_GRID },
                                ticks: { color: COLOR_EMERALD, callback: v => '$' + v },
                                title: { display: true, text: 'Diario', color: '#555', font: { size: 9 } }
                            },
                            y_cumulative: {
                                type: 'linear',
                                position: 'right',
                                grid: { drawOnChartArea: false },
                                ticks: { color: COLOR_GOLD, callback: v => '$' + v },
                                title: { display: true, text: 'Total', color: '#555', font: { size: 9 } }
                            }
                        }
                    }
                });
            }
        }

        // ============================================
        // CAPITAL TRACKER FUNCTIONS
        // ============================================
        async function fetchDeposits() {
            try {
                const res = await fetch('/api/deposits');
                if (res.ok) {
                    const data = await res.json();

                    // Store globally for chart access
                    window.DEPOSIT_DATA = data;

                    // Update summary cards
                    document.getElementById('cap-deposited').innerText = `$${data.totalDeposited.toFixed(2)}`;
                    document.getElementById('cap-current').innerText = `$${data.currentEquity.toFixed(2)}`;

                    // UPDATE HERO ROW (Protagonists)
                    const profitEl = document.getElementById('cap-profit');
                    if (profitEl) {
                        profitEl.innerText = `${data.profit >= 0 ? '+' : ''}$${data.profit.toFixed(2)}`;
                        profitEl.style.color = data.profit >= 0 ? 'var(--emerald-life)' : 'var(--ruby-danger)';
                    }

                    // Update Table/Tracker if exists
                    const profitTableEl = document.getElementById('cap-profit-table');
                    if (profitTableEl) {
                        profitTableEl.innerText = `${data.profit >= 0 ? '+' : ''}$${data.profit.toFixed(2)}`;
                        profitTableEl.style.color = data.profit >= 0 ? 'var(--emerald-life)' : 'var(--ruby-danger)';
                    }


                    const roiEl = document.getElementById('cap-roi');
                    roiEl.innerText = `${data.roi >= 0 ? '+' : ''}${data.roi.toFixed(2)}%`;
                    roiEl.style.color = data.roi >= 0 ? '#ba55d3' : 'var(--ruby-danger)';

                    // Render history
                    renderDeposits(data.deposits);
                }
            } catch (e) {
                console.error('Deposits fetch failed:', e.message);
            }
        }

        function renderDeposits(deposits) {
            const container = document.getElementById('deposit-history');
            if (!deposits || deposits.length === 0) {
                container.innerHTML = '<div style="padding: 15px; text-align: center; color: #555; font-size: 0.8rem;">No hay dep√≥sitos registrados</div>';
                return;
            }

            container.innerHTML = deposits.map(d => `
                <div style="display: grid; grid-template-columns: 1fr 1fr 2fr 60px; padding: 10px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center;">
                    <div style="color: #aaa; font-size: 0.8rem;">${d.date}</div>
                    <div style="color: var(--gold-primary); font-weight: bold;">$${d.amount.toFixed(2)}</div>
                    <div style="color: #888; font-size: 0.8rem;">${d.note || '-'}</div>
                    <div style="text-align: center;">
                        <button onclick="deleteDeposit(${d.id})" style="background: rgba(255,42,109,0.2); border: none; color: var(--ruby-danger); padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.7rem;">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        async function addDeposit() {
            const dateInput = document.getElementById('deposit-date');
            const amountInput = document.getElementById('deposit-amount');
            const noteInput = document.getElementById('deposit-note');

            const date = dateInput.value;
            const amount = parseFloat(amountInput.value);
            const note = noteInput.value;

            if (!date || !amount || isNaN(amount)) {
                alert('Por favor ingresa fecha y monto v√°lidos');
                return;
            }

            try {
                const res = await fetch('/api/deposits', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date, amount, note })
                });

                if (res.ok) {
                    // Clear form
                    dateInput.value = '';
                    amountInput.value = '';
                    noteInput.value = '';
                    // Refresh
                    fetchDeposits();
                } else {
                    const err = await res.json();
                    alert('Error: ' + (err.error || 'No se pudo agregar'));
                }
            } catch (e) {
                alert('Error de red: ' + e.message);
            }
        }

        async function deleteDeposit(id) {
            if (!confirm('¬øEliminar este dep√≥sito?')) return;

            try {
                const res = await fetch(`/api/deposits/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    fetchDeposits();
                } else {
                    alert('Error al eliminar');
                }
            } catch (e) {
                alert('Error de red: ' + e.message);
            }
        }

        // ============================================
        // ANALYTICS FUNCTIONS
        // ============================================
        async function fetchAnalytics() {
            try {
                const res = await fetch('/api/analytics');
                if (res.ok) {
                    const data = await res.json();

                    // ROI Cards
                    document.getElementById('roi-today').innerText = `${data.roi.daily >= 0 ? '+' : ''}${data.roi.daily}%`;
                    document.getElementById('roi-weekly').innerText = `${data.roi.weekly >= 0 ? '+' : ''}${data.roi.weekly}%`;
                    document.getElementById('roi-monthly').innerText = `${data.roi.monthly >= 0 ? '+' : ''}${data.roi.monthly}%`;
                    document.getElementById('roi-alltime').innerText = `${data.roi.allTime >= 0 ? '+' : ''}${data.roi.allTime}%`;

                    // Stats Row
                    document.getElementById('win-rate').innerText = `${data.performance.winRate}%`;
                    document.getElementById('avg-daily').innerText = `$${data.performance.avgDailyProfit}`;
                    document.getElementById('best-day').innerText = `$${data.highlights.bestDay.profit}`;
                    document.getElementById('max-drawdown').innerText = `${data.risk.maxDrawdownPercent}%`;

                    // Streak
                    document.getElementById('streak-display').innerText = data.streaks.current;
                    document.getElementById('streak-display').style.color = data.streaks.currentType === 'win' ? 'var(--emerald-life)' : '#ff6b6b';
                    document.getElementById('streak-type').innerText = data.streaks.currentType === 'win' ? 'd√≠as positivos üî•' : 'd√≠as negativos';
                    document.getElementById('longest-win').innerText = data.streaks.longestWin;

                    // Bot Leaderboard
                    const leaderboard = document.getElementById('bot-leaderboard');
                    if (data.botComparison && data.botComparison.length > 0) {
                        leaderboard.innerHTML = data.botComparison.map((b, i) => {
                            const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '';
                            return `<div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <span>${medal} ${b.name}</span>
                                <span style="color: var(--gold-primary);">$${b.profit} <span style="color: #666; font-size: 0.65rem;">(${b.roi}%)</span></span>
                            </div>`;
                        }).join('');
                    }
                }
            } catch (e) {
                console.error('Analytics fetch failed:', e.message);
            }
        }

        async function init() {
            renderCompanions();

            // Wait a tick to ensure DOM is ready
            await new Promise(r => setTimeout(r, 100));

            // CRITICAL: Load deposits FIRST (other fetches need this for chart)
            await fetchDeposits();

            // Now load the rest (these may trigger renderChart which needs DEPOSIT_DATA)
            fetchAllData();
            fetchRPG();
            fetchChart();
            fetchEquitySnapshots(); // Charts need snapshots too
            fetchFinancialHistory();
            fetchMarketHistory(); // NEW: Volatility Data
            fetchAnalytics(); // NEW: Performance Analytics

            setInterval(fetchAllData, 5000);
            setInterval(fetchRPG, 60000);
            setInterval(fetchChart, 60000);
            setInterval(fetchDeposits, 30000);
            setInterval(fetchFinancialHistory, 60000);
            setInterval(fetchMarketHistory, 60000);
            setInterval(fetchAnalytics, 60000); // Refresh analytics every minute
        }

        init();
    </script>
    <script src="socket.io.min.js"></script>
</body>

</html>