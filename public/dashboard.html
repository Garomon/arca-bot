<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARCA DASHBOARD | RPG</title>

    <!-- APP ICONS & MOBILE CONFIG -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="512x512" href="assets/icon-512.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#050508">

    <link href="styles/rpg-theme.css?v=4.3.0" rel="stylesheet">
    <link href="css_patch.css?v=4.3.0" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Outfit:wght@300;400;600&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <script>
        // Mobile-optimized Chart.js defaults
        const isMobileDevice = window.innerWidth < 768;

        if (isMobileDevice && typeof Chart !== 'undefined') {
            // Set global defaults for mobile
            Chart.defaults.font.size = 9;
            Chart.defaults.plugins.legend.labels.font = { size: 8 };
            Chart.defaults.plugins.legend.labels.boxWidth = 8;
            Chart.defaults.plugins.legend.labels.padding = 5;

            // Override scale defaults
            Chart.defaults.scale.ticks.maxTicksLimit = 5;
        }
    </script>

    <style>
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .btn-filter {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #888;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.65rem;
            font-family: 'Outfit', sans-serif;
            margin-left: 4px;
            transition: all 0.2s;
        }

        .btn-filter:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .btn-filter.active {
            background: var(--cyan-holo);
            color: #000;
            border-color: var(--cyan-holo);
            font-weight: bold;
        }

        .btn-filter.custom-active {
            background: var(--gold-primary);
            color: #000;
            border-color: var(--gold-primary);
            font-weight: bold;
        }

        .chart-controls {
            display: flex;
            align-items: center;
            gap: 2px;
            flex-wrap: wrap;
        }

        .date-range-container {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: 8px;
            padding-left: 8px;
            border-left: 1px solid rgba(255,255,255,0.1);
        }

        .date-input {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.15);
            color: #fff;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-family: 'Outfit', sans-serif;
            width: 95px;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--gold-primary);
        }

        .btn-apply-range {
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid var(--gold-primary);
            color: var(--gold-primary);
            padding: 3px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.65rem;
            font-family: 'Outfit', sans-serif;
            transition: all 0.2s;
        }

        .btn-apply-range:hover {
            background: var(--gold-primary);
            color: #000;
        }

        .filter-separator {
            width: 1px;
            height: 20px;
            background: rgba(255,255,255,0.1);
            margin: 0 6px;
        }

        /* Deposit Form Responsive */
        .deposit-form {
            display: grid;
            grid-template-columns: 150px 120px 1fr auto;
            gap: 12px;
            align-items: end;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .deposit-form {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .deposit-form .note-field {
                grid-column: span 2;
            }

            .deposit-form .submit-btn {
                grid-column: span 2;
            }
        }

        @media (max-width: 480px) {
            .deposit-form {
                grid-template-columns: 1fr;
            }

            .deposit-form .note-field,
            .deposit-form .submit-btn {
                grid-column: span 1;
            }
        }

        /* Analytics Section Responsive */
        .analytics-grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .analytics-grid-streak {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .analytics-grid-4 {
                grid-template-columns: repeat(2, 1fr);
            }

            .analytics-grid-streak {
                grid-template-columns: 1fr;
            }
        }

        /* Insights Avanzados Responsive */
        .insights-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .insights-card {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
        }

        .hold-times-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        @media (max-width: 768px) {
            .insights-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .hold-times-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .insights-card canvas {
                max-height: 120px;
            }

            #heatmap-container {
                height: 150px !important;
            }
        }

        @media (max-width: 480px) {
            .hold-times-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .insights-card {
                padding: 12px;
            }
        }
    </style>

    <style>
        /* === ACHIEVEMENTS MOBILE OPTIMIZATION === */
        @media (max-width: 768px) {
            /* Timeline: smaller boxes, better wrap */
            #milestones-timeline {
                gap: 6px !important;
                justify-content: center;
            }
            #milestones-timeline > div {
                min-width: 50px !important;
                padding: 6px 8px !important;
                font-size: 0.9em;
            }
            #milestones-timeline > div > div:first-child {
                font-size: 1rem !important;
            }
            #milestones-timeline > div > div:nth-child(2) {
                font-size: 0.55rem !important;
            }
            #milestones-timeline > div > div:nth-child(3) {
                font-size: 0.65rem !important;
            }

            /* Next rewards: single column on mobile */
            #next-rewards {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }

            /* Pending reward box: compact */
            #pending-reward-box {
                padding: 12px !important;
            }
            #pending-reward-box button {
                width: 100%;
                padding: 12px !important;
            }

            /* Redeemed box: stack on mobile */
            #redeemed-rewards-list > div {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 5px;
            }

            /* Section header: smaller */
            .elite-card h3 {
                font-size: 0.95rem !important;
            }

            /* Progress text */
            #achievements-progress {
                font-size: 0.75rem !important;
            }
        }

        @media (max-width: 480px) {
            /* Extra small screens */
            #milestones-timeline > div {
                min-width: 42px !important;
                padding: 5px 6px !important;
            }
            #milestones-timeline > div > div:first-child {
                font-size: 0.85rem !important;
            }

            #next-rewards > div {
                padding: 12px !important;
            }
        }
    </style>


    <style>
        /* === STATS CARDS MOBILE FIX === */
        @media (max-width: 768px) {
            /* Hero stats row: vertical stack */
            .hero-stats-row {
                flex-direction: column !important;
                gap: 12px !important;
            }

            .hero-card {
                width: 100% !important;
                min-width: unset !important;
                padding: 15px !important;
                flex-direction: row !important;
                align-items: center !important;
                justify-content: flex-start !important;
            }

            .hero-card .hero-icon {
                font-size: 1.5rem !important;
                margin-right: 12px !important;
                margin-bottom: 0 !important;
            }

            .hero-card .hero-content {
                display: flex !important;
                flex-direction: column !important;
                align-items: flex-start !important;
            }

            .hero-card .hero-label {
                font-size: 0.7rem !important;
                margin-bottom: 3px !important;
            }

            .hero-card .hero-val {
                font-size: 1.3rem !important;
            }

            .hero-card.main-hero .hero-val {
                font-size: 1.5rem !important;
            }

            /* Stats hex grid: 2 columns on tablet, 1 on phone */
            .stats-hex-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }

            .stat-cell {
                padding: 12px 10px !important;
            }

            .stat-cell .stat-label {
                font-size: 0.65rem !important;
            }

            .stat-cell .stat-val {
                font-size: 1rem !important;
            }
        }

        @media (max-width: 480px) {
            .hero-card {
                padding: 12px !important;
            }

            .hero-card .hero-val {
                font-size: 1.1rem !important;
            }

            .hero-card.main-hero .hero-val {
                font-size: 1.3rem !important;
            }

            /* Stats: still 2 columns but tighter */
            .stats-hex-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 6px !important;
            }

            .stat-cell {
                padding: 10px 8px !important;
            }

            .stat-cell .stat-val {
                font-size: 0.9rem !important;
            }
        }
    </style>


    <style>
        /* === CHARTS MOBILE OPTIMIZATION === */
        @media (max-width: 768px) {
            /* Chart containers: more height */
            .elite-card canvas,
            .chart-container canvas {
                max-height: 200px !important;
            }

            /* Chart filter buttons: smaller */
            .chart-filter-btn {
                padding: 4px 8px !important;
                font-size: 0.65rem !important;
            }

            /* Date inputs: smaller */
            .chart-date-input {
                width: 85px !important;
                font-size: 0.6rem !important;
                padding: 3px 5px !important;
            }

            /* Chart titles: smaller */
            .elite-card h3,
            .chart-title {
                font-size: 0.9rem !important;
            }

            /* Legend: hide text, show only dots on very small */
            .chart-legend {
                font-size: 0.6rem !important;
                flex-wrap: wrap !important;
                gap: 5px !important;
            }
        }

        @media (max-width: 480px) {
            /* Even more compact on phones */
            .chart-filter-btn {
                padding: 3px 6px !important;
                font-size: 0.6rem !important;
            }

            .chart-date-input {
                width: 75px !important;
                font-size: 0.55rem !important;
            }

            /* Stack filter row */
            .chart-filters,
            .chart-controls {
                flex-wrap: wrap !important;
                gap: 5px !important;
            }

            /* Capital vs Equity chart specific */
            #capital-chart-container {
                min-height: 180px !important;
            }
        }
    </style>


    <style>
        
    <style>
        /* === INSIGHTS MOBILE FIX v2 === */
        @media (max-width: 768px) {
            /* Make insights section scroll horizontally if needed */
            .insights-row {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* But try to make cards fit */
            .insights-card {
                min-width: 280px;
            }

            /* Spread chart - just ensure it doesn't overflow */
            #spread-chart-container,
            #spread-chart {
                max-width: 100% !important;
            }
        }
    </style>

</head>

<body>

    <div class="loading-overlay" id="loading"
        style="position:fixed; inset:0; background:#050508; display:flex; align-items:center; justify-content:center; z-index:9999; transition:opacity 0.5s;">
        <div class="loader"
            style="width:50px; height:50px; border:3px solid #333; border-top-color:var(--gold-primary); border-radius:50%; animation:spin 1s infinite linear;">
        </div>
    </div>

    <!-- QUEST COMPLETION CELEBRATION MODAL -->
    <div id="quest-celebration-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:10000; align-items:center; justify-content:center;">
        <!-- Confetti Canvas -->
        <canvas id="confetti-canvas" style="position:absolute; inset:0; pointer-events:none;"></canvas>

        <!-- Victory Content -->
        <div id="celebration-content" style="position:relative; text-align:center; padding:40px; max-width:500px; animation: celebrationPulse 0.5s ease-out; background:rgba(0,0,0,0.9); border-radius:15px; border:1px solid rgba(255,215,0,0.3);">
            <!-- Quest Complete Banner -->
            <div style="font-size: 0.9rem; color: #ffd700; letter-spacing: 3px; margin-bottom: 10px; text-shadow: 0 0 20px rgba(255,215,0,0.5);">
                ‚öîÔ∏è MISI√ìN COMPLETADA ‚öîÔ∏è
            </div>

            <!-- Quest Name -->
            <h1 id="celebration-quest-name" style="font-size: 2rem; color: #fff; margin: 20px 0; text-shadow: 0 0 30px rgba(255,215,0,0.3);">
                El Cruce del Valle
            </h1>

            <!-- Achievement Icon -->
            <div style="font-size: 5rem; margin: 30px 0; animation: bounceIn 0.6s ease-out 0.3s both;">
                üèÜ
            </div>

            <!-- Rewards Section -->
            <div style="background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(0,255,157,0.1)); border: 1px solid rgba(255,215,0,0.3); border-radius: 12px; padding: 25px; margin: 20px 0;">
                <div style="font-size: 0.8rem; color: #888; margin-bottom: 15px;">RECOMPENSAS OBTENIDAS</div>

                <!-- XP Reward -->
                <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px;">
                    <span style="font-size: 2.5rem; color: #ffd700; font-weight: bold;" id="xp-reward-counter">+0</span>
                    <span style="color: #ffd700; font-size: 1.2rem;">XP</span>
                </div>

                <!-- New Rank -->
                <div style="margin-top: 20px; padding: 15px; background: rgba(0,255,157,0.1); border-radius: 8px; border: 1px solid rgba(0,255,157,0.3);">
                    <div style="font-size: 0.7rem; color: #00ff9d; margin-bottom: 5px;">NUEVO RANGO DESBLOQUEADO</div>
                    <div id="celebration-new-rank" style="font-size: 1.3rem; color: #fff; font-weight: bold;">‚öîÔ∏è Caballero del Grid ‚öîÔ∏è</div>
                </div>

                <!-- Life Reward - What you can buy! -->
                <div style="margin-top: 15px; padding: 12px; background: rgba(255,149,0,0.1); border-radius: 8px; border: 1px solid rgba(255,149,0,0.3);">
                    <div style="font-size: 0.65rem; color: #ff9500; margin-bottom: 5px;">TE HAS GANADO EN LA VIDA REAL</div>
                    <div id="celebration-life-reward" style="font-size: 1.1rem; color: #fff;">üéÆ Headset gamer / Gadget</div>
                </div>
            </div>

            <!-- Strategy Tip -->
            <div style="margin-top: 15px; padding: 15px; background: rgba(0,212,255,0.05); border-radius: 8px; border: 1px solid rgba(0,212,255,0.2);">
                <div style="font-size: 0.65rem; color: #00d4ff; margin-bottom: 5px;">üí° PR√ìXIMO PASO ESTRAT√âGICO</div>
                <div id="celebration-strategy" style="color: #aaa; font-size: 0.85rem;">Grid trading puro + reinversi√≥n 100%</div>
            </div>

            <!-- Next Quest Preview -->
            <div style="margin-top: 15px; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px dashed rgba(255,255,255,0.1);">
                <div style="font-size: 0.7rem; color: #666; margin-bottom: 8px;">SIGUIENTE MISI√ìN</div>
                <div id="celebration-next-quest" style="color: #aaa; font-size: 0.9rem;">El Rito de Fortalecimiento</div>
                <div style="color: #666; font-size: 0.7rem; margin-top: 5px;">Mantener el sistema 30 d√≠as sin intervenci√≥n</div>
            </div>

            <!-- Continue Button -->
            <button onclick="closeCelebration()" style="margin-top: 30px; padding: 15px 50px; background: linear-gradient(135deg, #ffd700, #ff9500); border: none; border-radius: 8px; color: #000; font-weight: bold; font-size: 1rem; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;">
                CONTINUAR AVENTURA ‚Üí
            </button>
        </div>
    </div>

    <style>
        @keyframes celebrationPulse {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        #quest-celebration-modal button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255,215,0,0.5);
        }
        /* Legendary quest celebration effects */
        .legendary-celebration {
            animation: legendaryGlow 2s ease-in-out infinite, celebrationPulse 0.5s ease-out !important;
        }
        @keyframes legendaryGlow {
            0%, 100% {
                box-shadow: 0 0 30px rgba(255,215,0,0.3), 0 0 60px rgba(255,100,0,0.2), 0 0 90px rgba(255,0,100,0.1);
            }
            50% {
                box-shadow: 0 0 50px rgba(255,215,0,0.5), 0 0 100px rgba(255,100,0,0.3), 0 0 150px rgba(255,0,100,0.2);
            }
        }
        @keyframes legendaryPulse {
            0%, 100% { transform: scale(1); color: #ffd700; }
            50% { transform: scale(1.1); color: #ff6600; }
        }
        .legendary-celebration::before {
            content: '';
            position: absolute;
            inset: -3px;
            background: linear-gradient(45deg, #ffd700, #ff6600, #ff0066, #aa00ff, #00aaff, #00ff9d, #ffd700);
            background-size: 400% 400%;
            animation: legendaryBorder 3s linear infinite;
            border-radius: 15px;
            z-index: -1;
        }
        @keyframes legendaryBorder {
            0% { background-position: 0% 50%; }
            100% { background-position: 400% 50%; }
        }
    </style>

    <div class="container" style="max-width: 1600px; margin: 0 auto; padding: 20px;">

        <!-- HEADER / PROFILE -->
        <div class="elite-card profile-hero" style="margin-bottom: 30px;">
            <div style="position: relative;">
                <div class="avatar-hex" style="width: 100px; height: 100px;">
                    <img src="assets/avatar.png" alt="Commander" class="avatar-img">
                </div>
                <div class="level-badge" id="player-lvl" style="top: auto; bottom: -10px; width: max-content;">LVL 1
                </div>
            </div>

            <div class="hero-stats" style="padding-left: 20px;">
                <span class="hero-rank" id="player-title">INICIADO</span>
                <h1 class="hero-name" style="font-size: 1.8rem;">GAROSSA</h1>
                <div style="display: flex; align-items: center; gap: 15px; margin-top: 5px; max-width: 400px;">
                    <div
                        style="flex: 1; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden;">
                        <div id="xp-fill" style="width: 0%; height: 100%; background: var(--gold-primary);"></div>
                    </div>
                    <span style="font-size: 0.7rem; color: #888;" id="xp-text">0/0 XP</span>
                </div>

                <!-- Global Status Indicator -->
                <div style="margin-top: 10px; font-size: 0.75rem; color: var(--emerald-life); font-weight: 600;">
                    <span id="global-status-text">ESPERANDO SE√ëAL...</span>
                </div>
            </div>

            <div class="quest-mini-plate"
                style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; min-width: 300px;">
                <div style="font-size: 0.7rem; color: var(--gold-dim); margin-bottom: 5px;">üìú MISI√ìN ACTIVA</div>
                <div id="quest-name" style="color: #fff; font-weight: 600;">Sincronizando...</div>
                <div id="quest-objective" style="font-size: 0.65rem; color: #aaa; margin-top: 3px;">üéØ -</div>
                <div id="quest-progress-container" style="margin-top: 8px;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.6rem; color: #888; margin-bottom: 3px;">
                        <span id="quest-status">EN PROGRESO</span>
                        <span id="quest-progress-text">0%</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 4px; height: 6px; overflow: hidden;">
                        <div id="quest-progress-bar" style="background: var(--gold-primary); height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                    </div>
                </div>
                <div id="quest-reward"
                    style="font-size: 0.7rem; color: var(--gold-primary); margin-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 6px;">
                </div>
            </div>
        </div>

        <!-- HERO STATS ROW (PROTAGONISTS) -->
        <div class="hero-stats-row">
            <!-- TOTAL REALIZADO -->
            <div class="hero-card hero-gold" title="Suma de ganancias de todos los trades cerrados (SELLs)">
                <div class="hero-icon">üí∞</div>
                <div class="hero-content">
                    <span class="hero-label">TOTAL REALIZADO <span style="font-size:0.6rem;opacity:0.6;cursor:help;">‚ìò</span></span>
                    <span class="hero-val" id="total-profit">$0.00</span>
                </div>
            </div>

            <!-- GANANCIA NETA (MAIN) -->
            <div class="hero-card hero-emerald main-hero" title="Equity actual menos total depositado. Incluye ganancias realizadas + flotante.">
                <div class="hero-icon">üíπ</div>
                <div class="hero-content">
                    <span class="hero-label">GANANCIA NETA <span style="font-size:0.6rem;opacity:0.6;cursor:help;">‚ìò</span></span>
                    <span class="hero-val" id="cap-profit">$0.00</span>
                </div>
            </div>

            <!-- BOT√çN DIARIO -->
            <div class="hero-card hero-blue" title="Profit de trades cerrados en las √∫ltimas 24 horas">
                <div class="hero-icon">üíé</div>
                <div class="hero-content">
                    <span class="hero-label">BOT√çN DIARIO</span>
                    <span class="hero-val" id="daily-profit">$0.00</span>
                </div>
            </div>
        </div>

        <!-- GLOBAL STATS ROW -->
        <div class="stats-hex-grid"
            style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 30px;">
            <!-- Cells Moved to Hero Row -->
            <div class="stat-cell" title="Ganancia/p√©rdida no realizada de posiciones abiertas">
                <span class="stat-label">Flotante <span style="font-size:0.55rem;opacity:0.5;cursor:help;">‚ìò</span></span>
                <span class="stat-val" id="unrealized-pnl">$0.00</span>
            </div>
            <div class="stat-cell" title="Valor total de tu cuenta: USDT + valor de todos los activos">
                <span class="stat-label">Equity Global <span style="font-size:0.55rem;opacity:0.5;cursor:help;">‚ìò</span></span>
                <span class="stat-val cyan" id="global-equity">$0.00</span>
            </div>
            <div class="stat-cell" title="ROI TRADING: Mide eficiencia del bot. F√≥rmula: Profit Realizado ($27) √∑ Capital de Trabajo ($1268) = 2.2%. Diferente al ROI de Capital Tracker que mide retorno sobre inversi√≥n.">
                <span class="stat-label">ROI Trading <span style="font-size:0.55rem;opacity:0.5;cursor:help;">‚ìò</span></span>
                <span class="stat-val" id="global-roi">0%</span>
            </div>
            <div class="stat-cell" title="APY GLOBAL: Rendimiento anualizado de TODOS los bots combinados. F√≥rmula: (Profit Realizado √∑ Capital Ponderado) √ó 365 d√≠as. Es el promedio general de tu sistema.">
                <span class="stat-label">APY Global <span style="font-size:0.55rem;opacity:0.5;cursor:help;">‚ìò</span></span>
                <span class="stat-val gold" id="global-apy">~0%</span>
            </div>
            <div class="stat-cell" title="N√∫mero de √≥rdenes activas en el grid">
                <span class="stat-label">√ìrdenes</span>
                <span class="stat-val" id="total-orders">0</span>
            </div>
        </div>


        <!-- MINDSET ANTI-FEAR SECTION -->
        <div id="mindset-section" style="display: none; margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 12px; border-left: 4px solid #e94560;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <span style="font-size: 1.5rem;">üßò</span>
                <h3 style="margin: 0; color: #e94560; font-size: 1rem;">MODO PACIENCIA ACTIVADO</h3>
            </div>
            <div id="mindset-message" style="color: #a0a0a0; font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;"></div>
            <div id="mindset-strategy" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
        </div>

        <!-- COMPANION GRID (FULL SIZE) -->
        
        <h2
            style="margin-bottom: 25px; color: #fff; font-size: 1.2rem; border-bottom: 1px solid #333; padding-bottom: 10px;">
            üõ°Ô∏è ESP√çRITUS GUARDIANES
        </h2>

        <div class="companion-grid" id="bot-grid" style="gap: 20px;">
            <!-- INJECTED BY JS -->
        </div>

        <!-- CAPITAL TRACKER SECTION -->
        <div class="elite-card" style="margin-top: 30px; margin-bottom: 30px; padding: 25px;">
            <h3
                style="color: var(--gold-primary); margin-bottom: 20px; border-bottom: 1px solid rgba(255,215,0,0.2); padding-bottom: 10px;">
                üí∞ CAPITAL TRACKER
            </h3>

            <!-- Injection Indicator PRO -->
            <div id="injection-indicator" style="margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.4); border-radius: 10px; border: 2px solid #666;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span id="indicator-emoji" style="font-size: 2rem;">üü°</span>
                        <div>
                            <div style="font-size: 0.9rem; font-weight: bold; color: #fff;">¬øBuen momento para inyectar?</div>
                            <div id="indicator-message" style="font-size: 0.75rem; color: #aaa;">Calculando...</div>
                        </div>
                    </div>
                    <div id="indicator-score" style="font-size: 1.5rem; font-weight: bold; color: #666;">--</div>
                </div>
                <div id="indicator-breakdown" style="margin-top: 12px; display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 6px; font-size: 0.7rem;"></div>
                <div id="indicator-recommendation" style="margin-top: 10px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px; font-size: 0.75rem; color: #aaa;"></div>
            </div>

            <!-- Summary Cards -->
            <div class="stats-hex-grid" style="grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px;">
                <div class="stat-cell" style="background: rgba(255,215,0,0.05); border: 1px solid rgba(255,215,0,0.2);" title="Suma de todos tus dep√≥sitos de capital">
                    <span class="stat-label">üíµ Total Depositado</span>
                    <span class="stat-val" id="cap-deposited" style="color: #fff;">$0</span>
                </div>
                <div class="stat-cell" style="background: rgba(0,240,255,0.05); border: 1px solid rgba(0,240,255,0.2);" title="Equity actual: USDT + valor de activos">
                    <span class="stat-label">üìä Valor Actual</span>
                    <span class="stat-val cyan" id="cap-current">$0</span>
                </div>
                <div class="stat-cell" style="background: rgba(0,255,157,0.05); border: 1px solid rgba(0,255,157,0.2);" title="Valor Actual - Total Depositado = Tu ganancia real">
                    <span class="stat-label">üìà Ganancia Neta</span>
                    <span class="stat-val" id="cap-profit-table" style="color: var(--emerald-life);">$0</span>
                </div>
                <div class="stat-cell"
                    style="background: rgba(138,43,226,0.05); border: 1px solid rgba(138,43,226,0.2);" title="ROI INVERSI√ìN: Mide retorno sobre tu capital invertido. F√≥rmula: Ganancia Neta ($20) √∑ Total Depositado ($1275) = 1.6%. Diferente al ROI Trading que mide eficiencia de trades.">
                    <span class="stat-label">üî• ROI Inversi√≥n <span style="font-size:0.55rem;opacity:0.5;cursor:help;">‚ìò</span></span>
                    <span class="stat-val" id="cap-roi" style="color: #ba55d3;">0%</span>
                </div>
            </div>

            <!-- Monthly Deposit Goal Tracker -->
            <div id="monthly-goal-tracker" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,215,0,0.15); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.2rem;">üéØ</span>
                        <div>
                            <span style="font-size: 0.75rem; color: #888;">Meta Mensual</span>
                            <span id="monthly-goal-month" style="font-size: 0.75rem; color: var(--gold-primary); margin-left: 8px;">Enero 2026</span>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <span id="monthly-goal-status" style="font-size: 0.7rem; padding: 3px 8px; border-radius: 4px; background: rgba(255,165,0,0.2); color: #ffa500;">‚è≥ Pendiente</span>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="flex: 1;">
                        <div style="background: rgba(255,255,255,0.1); border-radius: 4px; height: 8px; overflow: hidden;">
                            <div id="monthly-goal-bar" style="background: linear-gradient(90deg, var(--gold-primary), #ffd700); height: 100%; width: 0%; transition: width 0.5s ease; border-radius: 4px;"></div>
                        </div>
                    </div>
                    <div style="min-width: 140px; text-align: right;">
                        <span id="monthly-goal-amount" style="font-size: 1.1rem; font-weight: bold; color: #fff;">$0</span>
                        <span style="color: #666; font-size: 0.8rem;"> / $500</span>
                    </div>
                </div>
                <div style="margin-top: 8px; font-size: 0.65rem; color: #666;">
                    <span id="monthly-goal-detail">Deposita m√≠nimo $500 este mes para mantener tu estrategia DCA</span>
                </div>
            </div>

            <!-- Add Deposit Form -->
            <div class="deposit-form">
                <div>
                    <label style="font-size: 0.7rem; color: #888; display: block; margin-bottom: 4px;">üìÖ Fecha</label>
                    <input type="date" id="deposit-date"
                        style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; font-family: 'Outfit', sans-serif; box-sizing: border-box;">
                </div>
                <div>
                    <label style="font-size: 0.7rem; color: #888; display: block; margin-bottom: 4px;">üí≤ USDT</label>
                    <input type="number" id="deposit-amount" placeholder="500" step="0.01"
                        style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; font-family: 'Outfit', sans-serif; box-sizing: border-box;">
                </div>
                <div class="note-field">
                    <label style="font-size: 0.7rem; color: #888; display: block; margin-bottom: 4px;">üìù Nota
                        (opcional)</label>
                    <input type="text" id="deposit-note" placeholder="Dep√≥sito mensual"
                        style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; font-family: 'Outfit', sans-serif; box-sizing: border-box;">
                </div>
                <button class="submit-btn" onclick="addDeposit()"
                    style="padding: 10px 20px; background: var(--gold-primary); color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-family: 'Outfit', sans-serif; transition: all 0.2s; white-space: nowrap;">
                    ‚ûï AGREGAR
                </button>
            </div>

            <!-- Deposit History Table -->
            <div style="background: rgba(0,0,0,0.3); border-radius: 8px; overflow: hidden;">
                <div
                    style="display: grid; grid-template-columns: 1fr 1fr 2fr 60px; padding: 10px 15px; background: rgba(255,255,255,0.05); font-size: 0.7rem; color: #888; font-weight: bold;">
                    <div>FECHA</div>
                    <div>MONTO</div>
                    <div>NOTA</div>
                    <div style="text-align: center;">‚ùå</div>
                </div>
                <div id="deposit-history" style="max-height: 200px; overflow-y: auto;">
                    <div style="padding: 15px; text-align: center; color: #555; font-size: 0.8rem;">Cargando
                        dep√≥sitos...</div>
                </div>
            </div>

            <!-- Injection History with Indicators -->
            <div style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px; border: 1px solid rgba(255,255,255,0.05);">
                <div style="font-size: 0.75rem; color: var(--cyan-holo); margin-bottom: 12px;">üìä HISTORIAL DE INYECCIONES (con indicador)</div>
                <div id="injection-history-list" style="display: flex; flex-direction: column; gap: 6px; max-height: 200px; overflow-y: auto;">
                    <div style="color: #555; font-size: 0.8rem;">Cargando historial...</div>
                </div>
            </div>
        </div>

        <!-- Chart 1: Capital vs Equity -->
        <div class="elite-card" style="margin-top: 30px; padding: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 1rem; color: var(--cyan-holo);">üìä Capital vs Equity
                </h3>
                <div class="chart-controls">
                    <button onclick="updateTimeframe(1, this)" class="btn-filter">1D</button>
                    <button onclick="updateTimeframe(7, this)" class="btn-filter">7D</button>
                    <button onclick="updateTimeframe(14, this)" class="btn-filter">14D</button>
                    <button onclick="updateTimeframe(30, this)" class="btn-filter active">1M</button>
                    <button onclick="updateTimeframe(90, this)" class="btn-filter">3M</button>
                    <button onclick="updateTimeframe(180, this)" class="btn-filter">6M</button>
                    <button onclick="updateTimeframe('YTD', this)" class="btn-filter">YTD</button>
                    <button onclick="updateTimeframe('ALL', this)" class="btn-filter">MAX</button>
                    <div class="date-range-container">
                        <input type="date" id="date-from" class="date-input" title="Fecha inicial">
                        <span style="color: #666; font-size: 0.6rem;">‚Üí</span>
                        <input type="date" id="date-to" class="date-input" title="Fecha final">
                        <button onclick="applyCustomRange()" class="btn-apply-range" title="Aplicar rango personalizado">OK</button>
                    </div>
                </div>
            </div>
            <div style="height: 250px; position: relative;">
                <canvas id="equity-chart"></canvas>
            </div>
        </div>

        <!-- Chart 2: Profit Tracking -->
        <div class="elite-card" style="margin-top: 20px; padding: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 1rem; color: var(--gold-primary);">üí∞ Profit Acumulado
                </h3>
            </div>
            <div style="height: 200px; position: relative;">
                <canvas id="profit-chart"></canvas>
            </div>
        </div>

        <!-- PERFORMANCE ANALYTICS SECTION -->
        <div class="elite-card" style="margin-top: 20px; padding: 25px;">
            <h3 style="margin: 0 0 20px 0; font-size: 1rem; color: var(--emerald-life);">üìà PERFORMANCE ANALYTICS</h3>

            <!-- ROI Cards Row -->
            <div class="analytics-grid-4" style="margin-bottom: 20px;">
                <div class="summary-card"
                    style="background: rgba(0,255,157,0.05); border: 1px solid rgba(0,255,157,0.2);">
                    <span class="stat-label">Hoy</span>
                    <span class="stat-val" id="roi-today" style="color: var(--emerald-life);">0%</span>
                </div>
                <div class="summary-card"
                    style="background: rgba(0,240,255,0.05); border: 1px solid rgba(0,240,255,0.2);">
                    <span class="stat-label">7 D√≠as</span>
                    <span class="stat-val" id="roi-weekly" style="color: var(--cyan-holo);">0%</span>
                </div>
                <div class="summary-card"
                    style="background: rgba(255,215,0,0.05); border: 1px solid rgba(255,215,0,0.2);">
                    <span class="stat-label">30 D√≠as</span>
                    <span class="stat-val" id="roi-monthly" style="color: var(--gold-primary);">0%</span>
                </div>
                <div class="summary-card"
                    style="background: rgba(138,43,226,0.05); border: 1px solid rgba(138,43,226,0.2);">
                    <span class="stat-label">Total</span>
                    <span class="stat-val" id="roi-alltime" style="color: #ba55d3;">0%</span>
                </div>
            </div>

            <!-- Stats Row -->
            <div class="analytics-grid-4" style="margin-bottom: 20px;">
                <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--emerald-life);" id="win-rate">0%
                    </div>
                    <div style="font-size: 0.65rem; color: #888;">Win Rate</div>
                </div>
                <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--gold-primary);" id="avg-daily">$0
                    </div>
                    <div style="font-size: 0.65rem; color: #888;">Promedio Diario</div>
                </div>
                <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: var(--cyan-holo);" id="best-day">$0</div>
                    <div style="font-size: 0.65rem; color: #888;">üèÜ Mejor D√≠a</div>
                </div>
                <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                    <div style="font-size: 1rem; color: #ff6b6b;" id="max-drawdown">0%</div>
                    <div style="font-size: 0.65rem; color: #888;">üìâ Max Drawdown</div>
                </div>
            </div>

            <!-- Streak & Bot Leaderboard -->
            <div class="analytics-grid-streak">
                <!-- Streak Card -->
                <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px;">
                    <div style="font-size: 0.75rem; color: #888; margin-bottom: 10px;">üî• RACHA ACTUAL</div>
                    <div id="streak-display" style="font-size: 1.8rem; font-weight: bold; color: var(--emerald-life);">0
                    </div>
                    <div id="streak-type" style="font-size: 0.7rem; color: #666;">d√≠as</div>
                    <div style="margin-top: 10px; font-size: 0.65rem; color: #555;">
                        Record: <span id="longest-win" style="color: var(--emerald-life);">0</span> d√≠as positivos
                    </div>
                </div>
                <!-- Bot Leaderboard -->
                <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px;">
                    <div style="font-size: 0.75rem; color: #888; margin-bottom: 10px;">üèÖ BOT LEADERBOARD</div>
                    <div id="bot-leaderboard" style="font-size: 0.75rem;">
                        <div style="color: #555;">Cargando...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ADVANCED INSIGHTS SECTION -->
        <div class="elite-card" style="margin-top: 20px; padding: 25px;">
            <h3 style="margin: 0 0 20px 0; font-size: 1rem; color: var(--gold-primary);">üî¨ INSIGHTS AVANZADOS</h3>

            <!-- Row 1: Heatmap + Profit por Bot -->
            <div class="insights-row" style="margin-bottom: 20px;">
                <!-- Heatmap de Actividad -->
                <div class="insights-card">
                    <div style="font-size: 0.75rem; color: #888; margin-bottom: 10px;">üìä ACTIVIDAD DE TRADING</div>
                    <div id="heatmap-container" style="height: 180px; position: relative;">
                        <canvas id="activity-heatmap"></canvas>
                    </div>
                    <div id="peak-hour-info" style="margin-top: 8px; font-size: 0.65rem; color: var(--cyan-holo);">
                        Cargando...
                    </div>
                </div>

                <!-- Profit por Bot (Donut) -->
                <div class="insights-card">
                    <div style="font-size: 0.75rem; color: #888; margin-bottom: 10px;">üèÜ PROFIT POR BOT</div>
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap; justify-content: center;">
                        <div style="width: 140px; height: 140px;">
                            <canvas id="bot-donut-chart"></canvas>
                        </div>
                        <div id="bot-legend" style="flex: 1; min-width: 100px; font-size: 0.7rem;">
                            <div style="color: #555;">Cargando...</div>
                        </div>
                    </div>
                    <div id="total-profit-display" style="margin-top: 10px; text-align: center; font-size: 0.8rem; color: var(--emerald-life);">
                        Total: $0
                    </div>
                </div>
            </div>

            <!-- Row 2: Spread Distribution + Hold Times -->
            <div class="insights-row">
                <!-- Distribuci√≥n de Spreads -->
                <div class="insights-card">
                    <div style="font-size: 0.75rem; color: #888; margin-bottom: 10px;">üìà DISTRIBUCI√ìN DE SPREADS</div>
                    <div id="spread-chart-container" style="height: 150px;">
                        <canvas id="spread-chart"></canvas>
                    </div>
                    <div id="spread-avg-info" style="margin-top: 8px; font-size: 0.65rem; color: #888;">
                        Spread promedio: --
                    </div>
                </div>

                <!-- Tiempos de Hold -->
                <div class="insights-card">
                    <div style="font-size: 0.75rem; color: #888; margin-bottom: 10px;">‚è±Ô∏è TIEMPO DE HOLD</div>
                    <div class="hold-times-grid" style="margin-top: 15px;">
                        <div style="text-align: center; padding: 10px; background: rgba(247,147,26,0.1); border-radius: 6px; border: 1px solid rgba(247,147,26,0.3);">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #f7931a;" id="hold-btc">--</div>
                            <div style="font-size: 0.6rem; color: #888;">BTC</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: rgba(153,69,255,0.1); border-radius: 6px; border: 1px solid rgba(153,69,255,0.3);">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #9945ff;" id="hold-sol">--</div>
                            <div style="font-size: 0.6rem; color: #888;">SOL</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: rgba(195,166,52,0.1); border-radius: 6px; border: 1px solid rgba(195,166,52,0.3);">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #c3a634;" id="hold-doge">--</div>
                            <div style="font-size: 0.6rem; color: #888;">DOGE</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: rgba(0,240,255,0.1); border-radius: 6px; border: 1px solid rgba(0,240,255,0.3);">
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--cyan-holo);" id="hold-global">--</div>
                            <div style="font-size: 0.6rem; color: #888;">GLOBAL</div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.6rem; color: #666; text-align: center;">
                        Tiempo promedio entre compra y venta (horas)
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== LIFE COACH SECTION ==================== -->
        <div class="elite-card" style="margin-top: 30px; padding: 25px; border: 1px solid rgba(0, 255, 157, 0.2);">
            <h3 style="margin: 0 0 20px 0; font-size: 1.1rem; color: var(--emerald-life);">
                üß† ARCA LIFE COACH
                <span style="font-size: 0.65rem; color: #666; font-weight: normal; margin-left: 10px;">Tu mentor hacia el mill√≥n</span>
            </h3>

            <!-- Mentor Tips -->
            <div id="mentor-tips" style="margin-bottom: 25px;">
                <div style="font-size: 0.75rem; color: var(--gold-primary); margin-bottom: 10px;">üí° CONSEJOS DEL MENTOR</div>
                <div id="tips-container" style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="padding: 12px; background: rgba(255,215,0,0.05); border-radius: 8px; border-left: 3px solid var(--gold-primary); font-size: 0.8rem; color: #ccc;">
                        Cargando consejos...
                    </div>
                </div>
            </div>

            <!-- Active Missions -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 25px;">
                <!-- Missions Panel -->
                <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="font-size: 0.75rem; color: var(--cyan-holo); margin-bottom: 12px;">üéØ MISIONES ACTIVAS</div>
                    <div id="active-missions" style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="color: #555; font-size: 0.8rem;">Cargando misiones...</div>
                    </div>
                </div>

                <!-- Side Quests Panel -->
                <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="font-size: 0.75rem; color: #9945ff; margin-bottom: 12px;">üìö SIDE QUESTS (Educaci√≥n)</div>
                    <div id="side-quests" style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="color: #555; font-size: 0.8rem;">Cargando quests...</div>
                    </div>
                </div>
            </div>

            <!-- Strategies & Habits Row -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                <!-- Unlocked Strategies -->
                <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="font-size: 0.75rem; color: var(--gold-primary); margin-bottom: 12px;">üîì ESTRATEGIAS DESBLOQUEADAS</div>
                    <div id="strategies-list" style="display: flex; flex-direction: column; gap: 6px;">
                        <div style="color: #555; font-size: 0.8rem;">Cargando...</div>
                    </div>
                </div>

                <!-- Habits Tracker -->
                <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="font-size: 0.75rem; color: var(--emerald-life); margin-bottom: 12px;">üî• H√ÅBITOS & STREAKS</div>
                    <div id="habits-tracker" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <div style="text-align: center; padding: 10px; background: rgba(255,215,0,0.1); border-radius: 8px;">
                            <div id="habit-no-withdrawal" style="font-size: 1.5rem; font-weight: bold; color: var(--gold-primary);">--</div>
                            <div style="font-size: 0.6rem; color: #888;">D√≠as sin retiro</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: rgba(0,255,157,0.1); border-radius: 8px;">
                            <div id="habit-injection-days" style="font-size: 1.5rem; font-weight: bold; color: var(--emerald-life);">--</div>
                            <div style="font-size: 0.6rem; color: #888;">D√≠as desde inyecci√≥n</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: rgba(0,240,255,0.1); border-radius: 8px; grid-column: span 2;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.7rem; color: #888;">Meta mensual:</span>
                                <span id="monthly-injection-progress" style="font-size: 0.8rem; color: var(--cyan-holo);">$0 / $500</span>
                            </div>
                            <div style="margin-top: 5px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                                <div id="monthly-injection-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--cyan-holo), var(--emerald-life)); transition: width 0.5s;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- üèÜ ACHIEVEMENTS & LIFE REWARDS -->
        <div class="elite-card" style="margin-bottom: 30px; padding: 25px; background: linear-gradient(135deg, rgba(0,0,0,0.4), rgba(20,20,30,0.6)); border: 1px solid rgba(255,215,0,0.2);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: var(--gold-primary); font-size: 1.1rem;">üèÜ VIAJE A LA √âLITE MILLONARIA</h3>
                <span id="achievements-progress" style="font-size: 0.85rem; color: #888;">Cargando...</span>
            </div>
            
            <!-- Pending Reward Box -->
            <div id="pending-reward-box" style="background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,140,0,0.05)); border: 2px solid var(--gold-primary); border-radius: 12px; padding: 20px; margin-bottom: 20px; display: none;">
                <div style="font-size: 0.75rem; color: var(--gold-dim); margin-bottom: 8px;">üéÅ LIFE REWARD PENDIENTE</div>
                <div id="pending-reward-name" style="font-size: 1.1rem; font-weight: bold; color: #fff;"></div>
                <div id="pending-reward-detail" style="font-size: 1rem; color: var(--gold-primary); margin-top: 10px;"></div>
                <button onclick="claimReward()" style="margin-top: 15px; background: var(--gold-primary); color: #000; border: none; padding: 10px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s;">‚úÖ YA LO RECLAM√â</button>
            </div>

            <!-- Current Mission IN_PROGRESS -->
            <div id="in-progress-box" style="display: none; background: rgba(0,200,255,0.08); border: 2px solid #00d4ff; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="font-size: 0.75rem; color: #00d4ff; margin-bottom: 8px;">‚ö° MISI√ìN ACTUAL EN PROGRESO</div>
                <div id="in-progress-name" style="font-size: 1.1rem; font-weight: bold; color: #fff;"></div>
                <div id="in-progress-detail" style="font-size: 0.9rem; color: #aaa; margin-top: 5px;"></div>
                <div style="margin-top: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; height: 20px; overflow: hidden; position: relative;">
                    <div id="in-progress-bar" style="height: 100%; background: linear-gradient(90deg, #00d4ff, #00ff88); width: 0%; transition: width 0.5s;"></div>
                    <div id="in-progress-percent" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.7rem; color: #fff; font-weight: bold;">0%</div>
                </div>
            </div>

            <!-- Redeemed Rewards -->
            <div id="redeemed-rewards-box" style="display: none; background: rgba(0,255,100,0.05); border: 1px solid rgba(0,255,100,0.3); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                <div style="font-size: 0.75rem; color: #00ff64; margin-bottom: 10px;">‚úÖ REWARDS YA RECLAMADOS:</div>
                <div id="redeemed-rewards-list"></div>
            </div>

            <!-- Milestones Timeline -->
            <div id="milestones-timeline" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;"></div>
            
            <!-- Next Rewards Preview -->
            <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                <div style="font-size: 0.8rem; color: #666; margin-bottom: 15px;">üìç PR√ìXIMOS LIFE REWARDS:</div>
                <div id="next-rewards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px;"></div>
            </div>
        </div>

        <!-- LOGS SECTION (CR√ìNICAS) -->

            <!-- MXN MILESTONES - Road to Millonario M√©xico -->
            <div style="margin-top: 20px; background: linear-gradient(135deg, rgba(0,100,0,0.2), rgba(206,17,38,0.1)); border-radius: 12px; padding: 20px; border: 2px solid rgba(0,100,0,0.4);">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                    <div>
                        <div style="font-size: 0.9rem; color: #00ff9d; font-weight: bold;">üá≤üáΩ ROAD TO MILLONARIO MXN</div>
                        <div style="font-size: 0.65rem; color: #888;">Milestones en tu moneda local</div>
                    </div>
                    <div style="text-align: right;">
                        <div id="mxn-current" style="font-size: 1.2rem; color: #fff; font-weight: bold;">$--</div>
                        <div style="font-size: 0.6rem; color: #666;">MXN actual</div>
                        <div id="mxn-rate" style="font-size: 0.55rem; color: #00ff9d;">@ $-- MXN/USD</div>
                    </div>
                </div>

                <!-- Next MXN Milestone -->
                <div id="mxn-next-milestone" style="background: rgba(0,0,0,0.4); border-radius: 10px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #00ff9d;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div id="mxn-next-icon" style="font-size: 1.5rem; display: inline-block; margin-right: 10px;">üéØ</div>
                            <span id="mxn-next-name" style="font-size: 1rem; color: #fff; font-weight: bold;">--</span>
                            <span id="mxn-next-title" style="font-size: 0.7rem; color: var(--gold-primary); margin-left: 8px;">--</span>
                        </div>
                        <div style="text-align: right;">
                            <div id="mxn-next-eta" style="font-size: 0.9rem; color: #00ff9d;">--</div>
                            <div style="font-size: 0.6rem; color: #666;">Estimado</div>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #888; margin-bottom: 4px;">
                            <span id="mxn-progress-text">$0 / $0 MXN</span>
                            <span id="mxn-progress-percent">0%</span>
                        </div>
                        <div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                            <div id="mxn-progress-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #006400, #00ff9d); transition: width 0.5s;"></div>
                        </div>
                    </div>
                    <div id="mxn-next-reward" style="margin-top: 8px; font-size: 0.7rem; color: #f0b90b;">üèÜ --</div>
                </div>

                <!-- All MXN Milestones -->
                <div style="font-size: 0.7rem; color: #666; margin-bottom: 8px;">TODOS LOS MILESTONES:</div>
                <div id="mxn-milestones-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px;">
                    <div style="color: #555; font-size: 0.7rem;">Cargando...</div>
                </div>
            </div>

        <div class="elite-card logs-section" style="margin-top: 30px; padding: 20px;">
            <h3 style="color: var(--cyan-holo); margin-bottom: 20px;">üìú CR√ìNICAS DEL SISTEMA</h3>
            <div class="logs-list" id="logs-list">
                <div class="log-item"><span class="log-msg">Sintonizando el Vacio...</span></div>
            </div>
        </div>

        <!-- DEBUG CONSOLE -->
        <div class="footer" style="margin-top: 30px; font-size: 0.7rem; color: #444; text-align: center;">
            <div id="last-update">Sincronizando...</div>
        </div>
    </div>

    <script>
        // === USD/MXN Exchange Rate (from Binance) ===
        window.usdMxnRate = 18.0; // Default, updated from Binance

        async function fetchBinanceExchangeRate() {
            try {
                const res = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=USDTMXN');
                if (res.ok) {
                    const data = await res.json();
                    window.usdMxnRate = parseFloat(data.price);
                    console.log(`[Exchange] USD/MXN from Binance: ${window.usdMxnRate.toFixed(2)}`);
                }
            } catch (e) {
                console.error('[Exchange] Failed to fetch rate:', e);
            }
        }

        // Fetch rate immediately and every 5 minutes
        fetchBinanceExchangeRate();
        setInterval(fetchBinanceExchangeRate, 5 * 60 * 1000);

        // === CONFIG ===
        const BOTS = [
            { id: 'btc', name: 'IGNIS', role: 'Esp√≠ritu de Fuego (BTC)', icon: 'üî•', url: '/' },
            { id: 'sol', name: 'VENTUS', role: 'Esp√≠ritu de Viento (SOL)', icon: 'üå¨Ô∏è', url: '/sol/' },
            { id: 'doge', name: 'FANG', role: 'Esp√≠ritu de Manada (DOGE)', icon: 'üê∫', url: '/doge/' }
        ];

        const ASSETS = {
            'btc': 'assets/spirit-btc.png',
            'sol': 'assets/spirit-sol.png',
            'doge': 'assets/spirit-doge.png'
        };

        // State
        let GLOBAL_EQUITY = 0;
        let GLOBAL_FULL_HISTORY = [];
        let CURRENT_TIMEFRAME = 30;
        let LAST_RENDERED_EQUITY = -1;

        function logDebug(msg) { console.log(msg); }

        // === RENDER ===
        function renderCompanions() {
            const grid = document.getElementById('bot-grid');
            if (!grid) return;

            grid.innerHTML = BOTS.map(bot => `
                <div class="elite-card companion-full-card ${bot.id}" id="card-${bot.id}" style="display: flex; flex-direction: column; overflow: hidden; min-height: 500px;">
                    <!-- IMAGE HERO SECTION -->
                    <div style="height: 220px; position: relative; overflow: hidden; background: #000;">
                        <!-- Status Indicator -->
                        <div style="position: absolute; top: 15px; left: 15px; z-index: 10; display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);">
                            <div class="pulse-dot" id="dot-${bot.id}" style="width: 10px; height: 10px;"></div>
                            <span id="status-label-${bot.id}" style="color: #fff; font-weight: bold; font-size: 0.8rem;">INIT...</span>
                        </div>
                        <div style="position: absolute; top: 15px; right: 15px; z-index: 10;">
                             <span class="c-regime-badge" id="regime-${bot.id}" style="background: rgba(0,0,0,0.8); padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; color: #fff; border: 1px solid #333;">-</span>
                        </div>
                        <img src="${ASSETS[bot.id]}" alt="${bot.name}" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.9; mask-image: linear-gradient(to bottom, black 20%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%);">
                        <div style="position: absolute; bottom: 10px; left: 15px;">
                            <h2 style="margin: 0; font-size: 2rem; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.8);">${bot.name}</h2>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8);">${bot.role}</div>
                        </div>
                    </div>

                    <!-- DATA SECTION -->
                    <div style="padding: 20px; flex: 1; display: flex; flex-direction: column; gap: 15px; background: rgba(10,10,15,0.95);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="background: rgba(255,255,255,0.03); padding: 10px; border-radius: 6px;">
                                <div style="font-size: 0.65rem; color: #666;">PRECIO</div>
                                <div id="price-${bot.id}" style="font-size: 1.1rem; color: #fff;">-</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.03); padding: 10px; border-radius: 6px;">
                                <div style="font-size: 0.65rem; color: #666;">PROFIT TOTAL</div>
                                <div id="profit-${bot.id}" style="font-size: 1.1rem; color: var(--gold-primary);">-</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <div title="Profit realizado de este bot en las √∫ltimas 24h">
                                <div style="font-size: 0.65rem; color: #666;">HOY</div>
                                <div id="daily-${bot.id}" style="font-size: 0.9rem; color: #eee;">-</div>
                            </div>
                            <div title="ROI de este bot: Profit Total √∑ Capital Asignado a este bot">
                                <div style="font-size: 0.65rem; color: #666;">ROI <span style="font-size:0.5rem;opacity:0.5;">‚ìò</span></div>
                                <div id="roi-${bot.id}" style="font-size: 0.9rem; color: #eee;">-</div>
                            </div>
                            <div title="APY INDIVIDUAL: Rendimiento anualizado de SOLO este bot. Basado en su profit y d√≠as activos. Puede diferir del APY Global que es el promedio de todos.">
                                <div style="font-size: 0.65rem; color: #666;">APY <span style="font-size:0.5rem;opacity:0.5;">‚ìò</span></div>
                                <div id="apy-${bot.id}" style="font-size: 0.9rem; color: var(--gold-primary);">-</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; text-align: center; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 15px;">
                            <div>
                                <div style="font-size: 0.6rem; color: #555;">WINRATE</div>
                                <div id="winrate-${bot.id}" style="font-size: 1rem; color: #fff;">-</div>
                                <div id="trades-${bot.id}" style="font-size: 0.6rem; color: #444;">0 trades</div>
                            </div>
                            <div>
                                <div style="font-size: 0.6rem; color: #555;">ORDENES</div>
                                <div id="orders-${bot.id}" style="font-size: 1rem; color: #fff;">-</div>
                                <div id="lots-${bot.id}" style="font-size: 0.6rem; color: #444;">0 lots</div>
                            </div>
                            <div>
                                <div style="font-size: 0.6rem; color: #555;">SCORE</div>
                                <div id="score-${bot.id}" style="font-size: 1rem; color: #fff;">-</div>
                            </div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; font-size: 0.75rem;">
                            <div style="color: #666; margin-bottom: 2px;">√öLTIMO TRADE</div>
                            <div id="last-trade-${bot.id}" style="color: #ccc;">Sin actividad reciente</div>
                        </div>
                        <div id="blocking-${bot.id}" style="display: none; background: rgba(255,100,100,0.1); border: 1px solid rgba(255,100,100,0.2); color: var(--ruby-danger); padding: 8px; font-size: 0.7rem; border-radius: 4px;"></div>
                        <div style="margin-top: auto; padding-top: 10px;">
                            <a href="${bot.url}" style="display: block; width: 100%; box-sizing: border-box; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #fff; text-align: center; text-decoration: none; font-size: 0.8rem; border-radius: 6px; transition: background 0.2s;">
                                ACCESO A TERMINAL &rarr;
                            </a>
                        </div>
                        <div id="debug-${bot.id}" style="font-size: 0.6rem; color: #ff2a6d; margin-top: 5px; min-height: 15px;"></div>
                    </div>
                </div>
            `).join('');
        }

        // === LOGIC ===
        async function fetchAllData() {
            let tProfit = 0, tDaily = 0, tUnreal = 0, tOrders = 0, tEquity = 0, tYesterday = 0, tDailyTrades = 0;
            let botsActive = 0;
            let allLogs = [];

            for (const bot of BOTS) {
                try {
                    const url = bot.url === '/' ? '/api/status' : `${bot.url}api/status`;
                    const res = await fetch(url);
                    if (res.ok) {
                        const data = await res.json();
                        // Capture USD/MXN rate and APY from Binance
                        if (data.usdMxnRate) window.usdMxnRate = data.usdMxnRate;
                        if (data.apy) window.currentAPY = data.apy;
                        updateBotUI(bot.id, data);
                        if (data.status !== "stopped") botsActive++;

                        tProfit += data.totalProfit || 0;
                        tDaily += data.dailyProfit || 0;
                        tYesterday += data.yesterdayProfit || 0;
                        tUnreal += data.unrealizedPnL || 0;
                        tOrders += data.activeOrders || 0;
                        tDailyTrades += data.dailyTrades || 0;

                        if (data.recentLogs && data.recentLogs.length > 0) {
                            data.recentLogs.forEach(log => {
                                allLogs.push({ ...log, bot: bot.id });
                            });
                        }
                    } else {
                        updateBotOffline(bot.id, "API ERROR");
                    }
                } catch (e) {
                    updateBotOffline(bot.id, 'NET ERR');
                }
            }

            const globalStatusEl = document.getElementById('global-status-text');
            if (globalStatusEl) {
                globalStatusEl.innerText = `SISTEMA: ${botsActive} / 3 CONSTRUCTOS ONLINE`;
                globalStatusEl.style.color = botsActive === 3 ? 'var(--emerald-life)' : botsActive > 0 ? 'var(--gold-primary)' : 'var(--ruby-danger)';
            }

            try {
                const eqRes = await fetch('/api/balance');
                if (eqRes.ok) {
                    const eqData = await eqRes.json();
                    if (eqData.totalEquity) tEquity = eqData.totalEquity;
                }
            } catch (e) { }

            // Store Global Equity for Chart
            GLOBAL_EQUITY = tEquity;

            // SYNC CHECK: Use Chart value if available and discrepancy is minor (prevents reversion)
            const mxnRate = window.usdMxnRate || 18.0;
            if (typeof window.FINAL_CHART_PROFIT !== 'undefined' && Math.abs(window.FINAL_CHART_PROFIT - tProfit) < 1.0) {
                const chartProfitMXN = window.FINAL_CHART_PROFIT * mxnRate;
                document.getElementById('total-profit').innerHTML = `$${window.FINAL_CHART_PROFIT.toFixed(2)} <small style="color:#888;font-size:0.65em">‚âà $${chartProfitMXN.toFixed(0)} MXN</small>`;
            } else {
                const profitMXN = tProfit * mxnRate;
                document.getElementById('total-profit').innerHTML = `$${tProfit.toFixed(2)} <small style="color:#888;font-size:0.65em">‚âà $${profitMXN.toFixed(0)} MXN</small>`;
            }

            const dailyEl = document.getElementById('daily-profit');
            const dailyMXN = tDaily * (window.usdMxnRate || 18.0);
            dailyEl.style.display = 'flex';
            dailyEl.style.flexDirection = 'column';
            dailyEl.style.alignItems = 'center';
            dailyEl.style.lineHeight = '1.2';
            dailyEl.innerHTML = `
                <span style="font-size: 1.5rem; color: #fff; margin-top: 5px;">$${tDaily.toFixed(2)} <small style="color:#888;font-size:0.5em">‚âà $${dailyMXN.toFixed(0)} MXN</small></span>
                <span style="font-size: 0.65rem; color: #aaa; margin-top: 4px;">(${tDailyTrades} trades ¬∑ Ayer: $${tYesterday.toFixed(2)})</span>
            `;

            document.getElementById('unrealized-pnl').innerText = `$${tUnreal.toFixed(2)}`;
            document.getElementById('unrealized-pnl').className = `stat-val ${tUnreal >= 0 ? '' : 'neg'}`;
            const equityMXN = tEquity * mxnRate;
            document.getElementById('global-equity').innerHTML = `$${tEquity.toFixed(2)} <small style="color:#888;font-size:0.55em">‚âà $${equityMXN.toFixed(0)} MXN</small>`;
            document.getElementById('total-orders').innerText = tOrders;

            updateLogs(allLogs);

            // ROI: Realized Profit / Working Capital (original formula)
            if (tEquity > tProfit) {
                const roi = (tProfit / (tEquity - tProfit)) * 100;
                document.getElementById('global-roi').innerText = `${roi.toFixed(1)}%`;
            }

            // Calculate Global APY using PRE-CALCULATED TWR values (stable, no recalc every poll)
            if (window.APY_TWR_CAPITAL && window.APY_DAYS_ACTIVE) {
                const twrCapital = window.APY_TWR_CAPITAL;
                const daysActive = window.APY_DAYS_ACTIVE;
                const globalROI = twrCapital > 0 ? (tProfit / twrCapital) * 100 : 0;
                const globalAPY = (globalROI / daysActive) * 365;

                // STABILITY: Only update if APY is reasonable (< 150%) and profit > 0
                // This prevents wild swings when bots are loading or data is partial
                if (globalAPY > 0 && globalAPY < 150 && tProfit > 0) {
                    window.currentAPY = globalAPY;
                    const apyEl = document.getElementById('global-apy');
                    if (apyEl) {
                        apyEl.innerText = `~${globalAPY.toFixed(0)}%`;
                        apyEl.style.color = globalAPY >= 50 ? 'var(--emerald-life)' : globalAPY >= 20 ? 'var(--gold-primary)' : '#fff';
                    }
                }
            }

            document.getElementById('loading').style.opacity = 0;
            setTimeout(() => document.getElementById('loading').style.display = 'none', 500);
            document.getElementById('last-update').innerText = 'ACTUALIZADO: ' + new Date().toLocaleTimeString();

            // Re-render chart if we have history and Equity changed significantly (fixing the 0 -> Value jump)
            if (GLOBAL_FULL_HISTORY.length > 0 && Math.abs(GLOBAL_EQUITY - LAST_RENDERED_EQUITY) > 0.5) {
                renderChart(GLOBAL_FULL_HISTORY);
            }
        }

        function updateBotUI(id, data) {
            document.getElementById(`regime-${id}`).innerText = data.marketRegime || 'NEUTRAL';
            const dot = document.getElementById(`dot-${id}`);
            const statusLbl = document.getElementById(`status-label-${id}`);

            if (dot) {
                dot.style.background = 'var(--emerald-life)';
                dot.style.boxShadow = '0 0 10px var(--emerald-life)';
            }

            if (statusLbl) {
                if (data.smartDcaBlocking) {
                    statusLbl.innerText = "BLOCKED";
                    statusLbl.style.color = "var(--gold-primary)";
                } else if (data.isPaused) {
                    statusLbl.innerText = "PAUSED";
                    statusLbl.style.color = "var(--ruby-danger)";
                    if (dot) { dot.style.background = 'var(--ruby-danger)'; dot.style.boxShadow = 'none'; }
                } else {
                    statusLbl.innerText = "ONLINE";
                    statusLbl.style.color = "var(--emerald-life)";
                }
            }

            const debugEl = document.getElementById(`debug-${id}`);
            if (debugEl) debugEl.innerText = "";

            const profitEl = document.getElementById(`profit-${id}`);
            if (profitEl) {
                const botProfitMXN = (data.totalProfit || 0) * (window.usdMxnRate || 18.0);
                profitEl.innerHTML = `$${(data.totalProfit || 0).toFixed(2)} <small style="color:#888;font-size:0.6em">‚âà$${botProfitMXN.toFixed(0)}</small>`;
            }

            const price = data.currentPrice || 0;
            const priceEl = document.getElementById(`price-${id}`);
            if (priceEl) priceEl.innerText = price > 1000 ? `$${price.toFixed(0)}` : price > 1 ? `$${price.toFixed(2)}` : `$${price.toFixed(4)}`;

            const roiEl = document.getElementById(`roi-${id}`);
            if (roiEl) roiEl.innerText = `${(data.roi || 0).toFixed(2)}%`;

            // APY display
            const apyEl = document.getElementById(`apy-${id}`);
            if (apyEl) {
                const apy = data.apy || 0;
                apyEl.innerText = `~${apy.toFixed(0)}%`;
                apyEl.style.color = apy >= 50 ? 'var(--emerald-life)' : apy >= 20 ? 'var(--gold-primary)' : '#eee';
            }

            const dailyEl = document.getElementById(`daily-${id}`);
            if (dailyEl) dailyEl.innerText = `$${(data.dailyProfit || 0).toFixed(2)}`;

            const winRate = data.winRate || 0;
            const wrEl = document.getElementById(`winrate-${id}`);
            if (wrEl) {
                wrEl.innerText = `${winRate.toFixed(0)}%`;
                wrEl.style.color = winRate >= 70 ? 'var(--emerald-life)' : winRate >= 50 ? 'var(--gold-primary)' : 'var(--ruby-danger)';
            }
            const tradesEl = document.getElementById(`trades-${id}`);
            if (tradesEl) tradesEl.innerText = `${data.totalTrades || 0} trades`;
            const scoreEl = document.getElementById(`score-${id}`);
            if (scoreEl) scoreEl.innerText = data.score || 50;
            const ordersEl = document.getElementById(`orders-${id}`);
            if (ordersEl) ordersEl.innerText = data.activeOrders || 0;
            const lotsEl = document.getElementById(`lots-${id}`);
            if (lotsEl) lotsEl.innerText = data.inventoryLots || 0;

            const lastTradeEl = document.getElementById(`last-trade-${id}`);
            if (lastTradeEl) {
                if (data.lastTrade) {
                    const now = Date.now();
                    const tradeTime = new Date(data.lastTrade.timestamp).getTime();
                    const diffMins = Math.floor((now - tradeTime) / 60000);
                    let timeAgo = diffMins < 60 ? `${diffMins}m ago` : `${Math.floor(diffMins / 60)}h ago`;
                    const side = data.lastTrade.side.toUpperCase();
                    const profit = data.lastTrade.profit ? `(+$${data.lastTrade.profit.toFixed(2)})` : '';
                    const color = side === 'SELL' ? 'var(--emerald-life)' : '#fff';
                    lastTradeEl.innerHTML = `<span style="color:${color}; font-weight:bold;">${side}</span> ${profit} <span style="opacity:0.6">¬∑ ${timeAgo}</span>`;
                } else {
                    lastTradeEl.innerText = "Sin actividad reciente";
                }
            }

            const blockEl = document.getElementById(`blocking-${id}`);
            if (blockEl) {
                if (data.blockingReason || data.isPaused) {
                    blockEl.style.display = 'block';
                    blockEl.innerText = `‚ö†Ô∏è ${data.blockingReason || 'PAUSADO'}`;
                } else {
                    blockEl.style.display = 'none';
                }
            }
        }

        function updateBotOffline(id, reason = "OFFLINE") {
            const dot = document.getElementById(`dot-${id}`);
            const statusLbl = document.getElementById(`status-label-${id}`);
            if (dot) dot.style.background = '#555';
            if (statusLbl) { statusLbl.innerText = reason; statusLbl.style.color = "#888"; }
        }

        function updateLogs(logs) {
            const logsList = document.getElementById('logs-list');
            if (!logs || logs.length === 0) {
                logsList.innerHTML = '<div class="log-item"><span class="log-msg">Sin actividad reciente... el Vacio est√° en calma.</span></div>';
                return;
            }
            const sorted = logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 20);
            logsList.innerHTML = sorted.map(log => {
                const time = log.timestamp ? new Date(log.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : '--:--';
                const botClass = log.bot || 'sys';
                return `<div class="log-item"><span class="log-time">${time}</span><span class="log-bot ${botClass}">${(log.bot || 'SYS').toUpperCase()}</span><span class="log-msg">${log.message || log.type || '-'}</span></div>`;
            }).join('');
        }

        // Track previous quest for completion detection
        let previousQuestName = localStorage.getItem('arca_current_quest') || null;

        async function fetchRPG() {
            try {
                const res = await fetch('/api/rpg');
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('player-lvl').innerText = `LVL ${data.level || 1} `;
                    document.getElementById('player-title').innerText = data.title || 'INICIADO';
                    document.getElementById('xp-text').innerText = `${data.xp} / ${data.nextLevelXp} XP`;
                    document.getElementById('xp-fill').style.width = `${data.xpProgress}%`;
                    if (data.quest) {
                        document.getElementById('quest-name').innerText = data.quest.name;
                        document.getElementById('quest-objective').innerText = `üéØ ${data.quest.objective || '-'}`;
                        document.getElementById('quest-status').innerText = data.quest.status === 'COMPLETED' ? 'COMPLETADA' : 'EN PROGRESO';
                        document.getElementById('quest-status').style.color = data.quest.status === 'COMPLETED' ? 'var(--emerald-life)' : 'var(--gold-primary)';
                        document.getElementById('quest-progress-text').innerText = data.quest.progress || '0%';
                        document.getElementById('quest-progress-bar').style.width = `${data.quest.progressPercent || 0}%`;
                        if (data.quest.status === 'COMPLETED') {
                            document.getElementById('quest-progress-bar').style.background = 'var(--emerald-life)';
                        }
                        if (data.quest.reward) document.getElementById('quest-reward').innerText = `üèÜ RECOMPENSA: ${data.quest.reward}`;

                        // CHECK FOR QUEST COMPLETION - Trigger celebration!
                        checkQuestCompletion(data.quest, previousQuestName);
                        previousQuestName = data.quest.name;
                        localStorage.setItem('arca_current_quest', data.quest.name);
                    }
                }
            } catch (e) { }
        }

        // ========== LIFE COACH SYSTEM ==========
        async function fetchLifeCoach() {
            try {
                const res = await fetch('/api/life-coach');
                if (!res.ok) return;
                const data = await res.json();

                // Render Mentor Tips
                const tipsContainer = document.getElementById('tips-container');
                if (tipsContainer && data.tips && data.tips.length > 0) {
                    tipsContainer.innerHTML = data.tips.map(t => {
                        const borderColor = t.priority === 'high' ? 'var(--ruby-danger)' :
                                           t.priority === 'medium' ? 'var(--gold-primary)' : 'var(--cyan-holo)';
                        return `<div style="padding: 12px; background: rgba(255,215,0,0.05); border-radius: 8px; border-left: 3px solid ${borderColor}; font-size: 0.8rem; color: #ccc;">
                            <span style="margin-right: 8px;">${t.icon}</span>${t.tip}
                        </div>`;
                    }).join('');
                }

                // Render Active Missions
                const missionsContainer = document.getElementById('active-missions');
                if (missionsContainer && data.missions) {
                    missionsContainer.innerHTML = data.missions.map(m => {
                        const hasProgress = m.progress !== undefined && m.target !== undefined;
                        const progressBar = hasProgress ? `
                            <div style="margin-top: 6px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden;">
                                <div style="height: 100%; width: ${m.progressPercent}%; background: var(--emerald-life);"></div>
                            </div>
                            <div style="font-size: 0.65rem; color: #666; margin-top: 3px;">${typeof m.progress === 'number' ? '$' + m.progress.toFixed(0) : m.progress} / ${typeof m.target === 'number' ? '$' + m.target : m.target}</div>
                        ` : '';

                        const actionBtn = m.action === 'complete_quest' ? `
                            <button onclick="completeQuest('${m.id}')" style="margin-top: 8px; padding: 4px 10px; background: rgba(153,69,255,0.2); border: 1px solid #9945ff; border-radius: 4px; color: #9945ff; font-size: 0.65rem; cursor: pointer;">
                                ‚úì Marcar completado
                            </button>
                        ` : '';

                        return `<div style="padding: 10px; background: rgba(255,255,255,0.02); border-radius: 6px; border: 1px solid rgba(255,255,255,0.05);">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.2rem;">${m.icon}</span>
                                <div style="flex: 1;">
                                    <div style="font-size: 0.8rem; color: #fff; font-weight: 500;">${m.name}</div>
                                    <div style="font-size: 0.65rem; color: #888;">${m.description}</div>
                                </div>
                                <div style="font-size: 0.7rem; color: var(--gold-primary);">+${m.xpReward} XP</div>
                            </div>
                            ${progressBar}
                            ${actionBtn}
                        </div>`;
                    }).join('');
                }

                // Render Side Quests
                const sideQuestsContainer = document.getElementById('side-quests');
                if (sideQuestsContainer && data.sideQuests) {
                    sideQuestsContainer.innerHTML = data.sideQuests.map(q => {
                        const urlBtn = q.url ? `<a href="${q.url}" target="_blank" style="color: var(--cyan-holo); font-size: 0.65rem; text-decoration: none;">üìñ Leer</a>` : '';
                        return `<div style="display: flex; align-items: center; gap: 10px; padding: 8px; background: rgba(153,69,255,0.05); border-radius: 6px;">
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; color: #ccc;">${q.name}</div>
                                <div style="font-size: 0.6rem; color: #666;">${q.description}</div>
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
                                <span style="font-size: 0.65rem; color: #9945ff;">+${q.xp} XP</span>
                                ${urlBtn}
                            </div>
                            <button onclick="completeQuest('${q.id}')" style="padding: 4px 8px; background: rgba(0,255,157,0.1); border: 1px solid var(--emerald-life); border-radius: 4px; color: var(--emerald-life); font-size: 0.6rem; cursor: pointer;">‚úì</button>
                        </div>`;
                    }).join('');
                }

                // Render Strategies with Dynamic Unlock Estimates
                const strategiesContainer = document.getElementById('strategies-list');
                if (strategiesContainer && data.strategies) {
                    const currentEquity = data.equity || 1500;
                    const realAPY = window.currentAPY || 25;
                    const dailyGrowthRate = realAPY / 100 / 365;
                    const monthlyInjection = (data.stats && data.stats.avgMonthlyInjection) ? data.stats.avgMonthlyInjection : 500;
                    const dailyInjection = monthlyInjection / 30;

                    strategiesContainer.innerHTML = data.strategies.map(s => {
                        const unlocked = s.unlocked;
                        const icon = unlocked ? '‚úÖ' : 'üîí';
                        const color = unlocked ? 'var(--emerald-life)' : '#555';
                        const textColor = unlocked ? '#ccc' : '#444';

                        let unlockInfo = '';
                        if (!unlocked && s.minCapital) {
                            const needed = s.minCapital - currentEquity;
                            if (needed > 0) {
                                let projected = currentEquity;
                                let daysToUnlock = 0;
                                while (projected < s.minCapital && daysToUnlock < 10000) {
                                    projected = projected * (1 + dailyGrowthRate) + dailyInjection;
                                    daysToUnlock++;
                                }
                                const monthsToUnlock = Math.ceil(daysToUnlock / 30);
                                if (monthsToUnlock <= 1) {
                                    unlockInfo = 'Faltan $' + needed.toFixed(0) + ' (~' + daysToUnlock + ' dias)';
                                } else if (monthsToUnlock <= 12) {
                                    unlockInfo = 'Faltan $' + needed.toFixed(0) + ' (~' + monthsToUnlock + ' meses)';
                                } else {
                                    const years = (monthsToUnlock / 12).toFixed(1);
                                    unlockInfo = 'Faltan $' + needed.toFixed(0) + ' (~' + years + ' a√±os)';
                                }
                            }
                        }

                        const unlockLine = !unlocked && unlockInfo ? `<div style="font-size:0.55rem;color:#f0b90b;margin-top:2px">üéØ ${unlockInfo}</div>` : '';

                        return `<div style="display:flex;align-items:center;gap:8px;padding:6px;opacity:${unlocked ? 1 : 0.5}">
                            <span>${icon}</span>
                            <div style="flex:1">
                                <span style="font-size:0.75rem;color:${color}">${s.name}</span>
                                <div style="font-size:0.6rem;color:${textColor}">${s.description}</div>
                                ${unlockLine}
                            </div>
                        </div>`;
                    }).join('');
                }

                // Update Habits
                if (data.habits) {
                    const noWithdrawEl = document.getElementById('habit-no-withdrawal');
                    const injectionDaysEl = document.getElementById('habit-injection-days');
                    if (noWithdrawEl) noWithdrawEl.innerText = data.habits.noWithdrawalDays || 0;
                    if (injectionDaysEl) {
                        const days = data.habits.lastInjectionDays;
                        injectionDaysEl.innerText = days > 900 ? '‚àû' : days;
                        injectionDaysEl.style.color = days > 30 ? 'var(--ruby-danger)' : 'var(--emerald-life)';
                    }
                }

                // Update Monthly Progress
                if (data.stats) {
                    const progressEl = document.getElementById('monthly-injection-progress');
                    const barEl = document.getElementById('monthly-injection-bar');
                    if (progressEl) progressEl.innerText = `$${data.stats.depositsThisMonth} / $${data.stats.monthlyGoal}`;
                    if (barEl) barEl.style.width = `${Math.min(100, (data.stats.depositsThisMonth / data.stats.monthlyGoal) * 100)}%`;
                }

                // === INJECTION INDICATOR PRO ===
                if (data.injectionIndicator) {
                    const ind = data.injectionIndicator;
                    const emojiEl = document.getElementById('indicator-emoji');
                    const msgEl = document.getElementById('indicator-message');
                    const scoreEl = document.getElementById('indicator-score');
                    const breakdownEl = document.getElementById('indicator-breakdown');
                    const recEl = document.getElementById('indicator-recommendation');
                    const containerEl = document.getElementById('injection-indicator');

                    if (emojiEl) emojiEl.innerText = ind.emoji;
                    if (msgEl) msgEl.innerText = ind.message;
                    if (scoreEl) {
                        scoreEl.innerText = ind.score + '/100';
                        scoreEl.style.color = ind.signal === 'GREEN' ? '#00ff9d' : ind.signal === 'RED' ? '#ff4444' : '#f0b90b';
                    }
                    if (containerEl) {
                        containerEl.style.borderColor = ind.signal === 'GREEN' ? '#00ff9d' : ind.signal === 'RED' ? '#ff4444' : '#f0b90b';
                    }

                    // Render breakdown
                    if (breakdownEl && ind.breakdown) {
                        breakdownEl.innerHTML = ind.breakdown.map(b => {
                            const ptsColor = b.points > 0 ? '#00ff9d' : b.points < 0 ? '#ff4444' : '#888';
                            const pts = (b.points >= 0 ? '+' : '') + b.points;
                            return `<div style="display: flex; justify-content: space-between; padding: 4px 8px; background: rgba(255,255,255,0.03); border-radius: 4px;">
                                <span style="color: #aaa;">${b.factor}</span>
                                <span><span style="color: #fff; margin-right: 8px;">${b.value}</span><span style="color: ${ptsColor}; font-weight: bold;">${pts}</span></span>
                            </div>`;
                        }).join('');
                    }

                    if (recEl && ind.recommendation) {
                        recEl.innerHTML = `<strong>üìã Recomendaci√≥n:</strong> ${ind.recommendation}`;
                    }
                }

                // === DEPOSIT HISTORY WITH INDICATORS ===
                if (data.deposits) {
                    const depositsListEl = document.getElementById('injection-history-list');
                    if (depositsListEl) {
                        // Sort by date descending (most recent first)
                        const sortedDeposits = [...data.deposits]
                            .filter(d => d.amount) // Only actual deposits, not rebalance events
                            .sort((a, b) => new Date(b.date) - new Date(a.date));

                        if (sortedDeposits.length === 0) {
                            depositsListEl.innerHTML = '<div style="color: #555; font-size: 0.8rem;">Sin dep√≥sitos registrados</div>';
                        } else {
                            depositsListEl.innerHTML = sortedDeposits.map(d => {
                                const ind = d.indicator || { signal: 'N/A', emoji: '‚ö™', score: '?' };
                                const borderColor = ind.signal === 'GREEN' ? '#00ff9d' : ind.signal === 'RED' ? '#ff4444' : ind.signal === 'YELLOW' ? '#f0b90b' : '#666';
                                const signalText = ind.signal === 'N/A' ? 'Sin datos' : ind.signal;
                                return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: rgba(255,255,255,0.02); border-radius: 6px; border-left: 3px solid ${borderColor};">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="font-size: 1.2rem;">${ind.emoji}</span>
                                        <div>
                                            <div style="font-size: 0.8rem; color: #fff; font-weight: 500;">$${d.amount.toFixed(0)}</div>
                                            <div style="font-size: 0.65rem; color: #666;">${d.date}${d.note ? ' - ' + d.note : ''}</div>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 0.7rem; color: ${borderColor}; font-weight: bold;">${signalText}</div>
                                        <div style="font-size: 0.6rem; color: #555;">${ind.score !== '?' ? 'Score: ' + ind.score : ''}</div>
                                    </div>
                                </div>`;
                            }).join('');
                        }
                    }
                }


                // === MXN MILESTONES RENDERING ===
                if (data.mxnMilestones) {
                    const mxn = data.mxnMilestones;
                    const currentMxnEl = document.getElementById("mxn-current");
                    if (currentMxnEl) currentMxnEl.innerText = "$" + Math.round(mxn.currentMXN).toLocaleString("es-MX");
                    const mxnRateEl = document.getElementById("mxn-rate");
                    if (mxnRateEl && mxn.mxnRate) mxnRateEl.innerText = "@ $" + mxn.mxnRate.toFixed(2) + " MXN/USD";
                    if (mxn.nextMilestone) {
                        const nm = mxn.nextMilestone;
                        document.getElementById("mxn-next-icon").innerText = nm.icon;
                        document.getElementById("mxn-next-name").innerText = nm.name;
                        document.getElementById("mxn-next-title").innerText = nm.title;
                        document.getElementById("mxn-next-eta").innerText = nm.estimatedDate;
                        document.getElementById("mxn-progress-text").innerText = "$" + Math.round(mxn.currentMXN).toLocaleString("es-MX") + " / $" + nm.mxn.toLocaleString("es-MX") + " MXN";
                        document.getElementById("mxn-progress-percent").innerText = nm.progressPercent.toFixed(1) + "%";
                        document.getElementById("mxn-progress-bar").style.width = nm.progressPercent + "%";
                        document.getElementById("mxn-next-reward").innerText = "üèÜ " + nm.reward;
                    }
                    const milestonesListEl = document.getElementById("mxn-milestones-list");
                    if (milestonesListEl && mxn.milestones) {
                        milestonesListEl.innerHTML = mxn.milestones.map(function(m) {
                            var bgColor = m.achieved ? "rgba(0,255,157,0.15)" : "rgba(255,255,255,0.02)";
                            var borderColor = m.achieved ? "#00ff9d" : m.legendary ? "#f0b90b" : "#333";
                            var textColor = m.achieved ? "#00ff9d" : "#666";
                            var icon = m.achieved ? "‚úÖ" : m.icon;
                            var eta = m.achieved ? "LOGRADO" : (m.yearsToReach < 1 ? m.monthsToReach + "m" : m.yearsToReach + "a");
                            return "<div style=\"padding:8px;background:" + bgColor + ";border-radius:6px;border:1px solid " + borderColor + ";text-align:center\"><div style=\"font-size:1.2rem\">" + icon + "</div><div style=\"font-size:0.7rem;color:" + textColor + ";font-weight:bold\">" + m.name + "</div><div style=\"font-size:0.55rem;color:#555\">" + m.title + "</div><div style=\"font-size:0.6rem;color:" + (m.achieved ? "#00ff9d" : "#f0b90b") + ";margin-top:4px\">" + eta + "</div></div>";
                        }).join("");
                    }
                }

            } catch (e) {
                console.error('[LifeCoach] Error:', e.message);
            }
        }

        // Complete a side quest
        async function completeQuest(questId) {
            try {
                const res = await fetch('/api/life-coach/complete-quest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ questId })
                });
                const data = await res.json();
                if (data.success) {
                    alert(`üéâ ${data.message}`);
                    fetchLifeCoach(); // Refresh
                } else {
                    alert(data.message || 'Error');
                }
            } catch (e) {
                alert('Error completando quest');
            }
        }

        // ========== QUEST CELEBRATION SYSTEM - JOURNEY TO MILLIONAIRE ==========
        // ESTRATEGIA REAL: Grid ‚Üí Reinversi√≥n ‚Üí Inyecci√≥n ‚Üí Staking ‚Üí Apalancamiento ‚Üí Real Estate
        const QUESTS_CONFIG = {
            // ===== ACT I: EL DESPERTAR (Grid Trading Puro) =====
            'El Cruce del Valle': {
                xpReward: 1000, chapter: 1,
                newRank: '‚öîÔ∏è Veterano del Valle ‚öîÔ∏è',
                nextQuest: 'La Forja del Guerrero',
                nextObjective: 'Alcanzar $2,000 USD de capital',
                lifeReward: 'üéÆ Headset gamer / Gadget',
                strategy: 'Grid trading puro + reinversi√≥n 100%'
            },
            'La Forja del Guerrero': {
                xpReward: 1500, chapter: 2,
                newRank: 'üî® Herrero del Profit üî®',
                nextQuest: 'El Pacto del Compuesto',
                nextObjective: 'Alcanzar $3,000 USD de capital',
                lifeReward: 'üçΩÔ∏è Cena en restaurante nice',
                strategy: 'Considera agregar staking (8-12% APY)'
            },
            'El Pacto del Compuesto': {
                xpReward: 2000, chapter: 3,
                newRank: 'üìà Maestro Compuesto üìà',
                nextQuest: 'La Conquista del Reino',
                nextObjective: 'Alcanzar $5,000 USD de capital',
                lifeReward: 'üì± iPhone/Galaxy nuevo',
                strategy: 'Inyecta capital extra de trabajo/freelance'
            },
            'La Conquista del Reino': {
                xpReward: 3000, chapter: 4,
                newRank: 'üè∞ Conquistador üè∞',
                nextQuest: 'El Templo del Poder',
                nextObjective: 'Alcanzar $7,500 USD de capital',
                lifeReward: 'üíª Setup upgrade / MacBook',
                strategy: 'Diversifica: 70% grid, 30% holding BTC/ETH'
            },
            // ===== ACT II: LA EXPANSI√ìN =====
            'El Templo del Poder': {
                xpReward: 4000, chapter: 5,
                newRank: 'üèõÔ∏è Sacerdote del Grid üèõÔ∏è',
                nextQuest: 'Los Diez Mil Soles',
                nextObjective: 'Alcanzar $10,000 USD (5 D√çGITOS)',
                lifeReward: 'üèçÔ∏è Moto / E-bike',
                strategy: 'Considera DCA en blue chips crypto'
            },
            'Los Diez Mil Soles': {
                xpReward: 5000, chapter: 6,
                newRank: '‚òÄÔ∏è Leyenda 5 D√≠gitos ‚òÄÔ∏è',
                nextQuest: 'La C√°mara de los Titanes',
                nextObjective: 'Alcanzar $15,000 USD de capital',
                lifeReward: '‚úàÔ∏è Viaje internacional',
                strategy: 'Apalancamiento 2x en 20% del capital MAX'
            },
            'La C√°mara de los Titanes': {
                xpReward: 7500, chapter: 7,
                newRank: '‚ö° Campe√≥n de los Titanes ‚ö°',
                nextQuest: 'El Despertar del Drag√≥n',
                nextObjective: 'Alcanzar $25,000 USD de capital',
                lifeReward: 'üöó Enganche para carro',
                strategy: 'Yield farming conservador (Aave, Compound)'
            },
            'El Despertar del Drag√≥n': {
                xpReward: 12500, chapter: 8,
                newRank: 'üêâ Domador de Dragones üêâ',
                nextQuest: 'El Trono del Rey',
                nextObjective: 'Alcanzar $50,000 USD de capital',
                lifeReward: 'üöô Carro / Rolex',
                strategy: 'REITs tokenizados para ingreso pasivo'
            },
            // ===== ACT III: EL APALANCAMIENTO =====
            'El Trono del Rey': {
                xpReward: 25000, chapter: 9,
                newRank: 'üëë Rey del Trading üëë',
                nextQuest: 'La Fortaleza de Cristal',
                nextObjective: 'Alcanzar $75,000 USD de capital',
                lifeReward: 'üè† Enganche depa CDMX',
                strategy: 'Diversifica en ETFs (VOO, QQQ)'
            },
            'La Fortaleza de Cristal': {
                xpReward: 37500, chapter: 10,
                newRank: 'üîÆ Arquitecto Financiero üîÆ',
                nextQuest: 'El Club de los Cien Mil',
                nextObjective: 'Alcanzar $100,000 USD (6 D√çGITOS)',
                lifeReward: 'üè¢ Depa peque√±o pagado',
                strategy: 'Real estate fraccionado / Crowdfunding'
            },
            'El Club de los Cien Mil': {
                xpReward: 50000, chapter: 11,
                newRank: 'üíØ Semidi√≥s Financiero üíØ',
                nextQuest: 'El Portal Dimensional',
                nextObjective: 'Alcanzar $150,000 USD de capital',
                lifeReward: 'üèñÔ∏è Depa Canc√∫n/Playa',
                strategy: 'Primer propiedad f√≠sica para rentar'
            },
            // ===== ACT IV: DIVERSIFICACI√ìN =====
            'El Portal Dimensional': {
                xpReward: 75000, chapter: 12,
                newRank: 'üåÄ Viajero Entre Mundos üåÄ',
                nextQuest: 'La Corona de Plata',
                nextObjective: 'Alcanzar $250,000 USD de capital',
                lifeReward: 'üå¥ Enganche depa Miami',
                strategy: 'M√∫ltiples fuentes de ingreso pasivo'
            },
            'La Corona de Plata': {
                xpReward: 125000, chapter: 13,
                newRank: 'ü•à Bar√≥n del Capital ü•à',
                nextQuest: 'La Corona de Oro',
                nextObjective: 'Alcanzar $500,000 USD de capital',
                lifeReward: 'üèôÔ∏è Depa CDMX premium',
                strategy: 'Angel investing / Startups'
            },
            'La Corona de Oro': {
                xpReward: 250000, chapter: 14,
                newRank: 'ü•á Emperador del Capital ü•á',
                nextQuest: 'Las Puertas del Olimpo',
                nextObjective: 'Alcanzar $750,000 USD de capital',
                lifeReward: 'üåÜ Depa Miami pagado',
                strategy: 'Portafolio de propiedades'
            },
            // ===== ACT V: LA √âLITE =====
            'Las Puertas del Olimpo': {
                xpReward: 500000, chapter: 15,
                newRank: '‚õ©Ô∏è Guardi√°n del Olimpo ‚õ©Ô∏è',
                nextQuest: 'EL MILL√ìN',
                nextObjective: 'Alcanzar $1,000,000 USD (7 D√çGITOS)',
                lifeReward: 'üèùÔ∏è Casa en la playa',
                strategy: 'Family office / Wealth management'
            },
            'EL MILL√ìN': {
                xpReward: 1000000, chapter: 16,
                newRank: 'üí∞ üèÜ MILLONARIO üèÜ üí∞',
                nextQuest: 'El Consejo de los Dioses',
                nextObjective: 'Alcanzar $2,500,000 USD de capital',
                lifeReward: 'üõ•Ô∏è Yate / Depa Dubai',
                strategy: 'Preservaci√≥n + crecimiento conservador',
                legendary: true
            },
            // ===== ACT VI: LEGADO =====
            'El Consejo de los Dioses': {
                xpReward: 2500000, chapter: 17,
                newRank: 'üåü Miembro del Consejo üåü',
                nextQuest: 'El Legado Eterno',
                nextObjective: 'Alcanzar $5,000,000 USD de capital',
                lifeReward: 'üè∞ Mansi√≥n / Multi-propiedades',
                strategy: 'Private equity / Venture capital',
                legendary: true
            },
            'El Legado Eterno': {
                xpReward: 5000000, chapter: 18,
                newRank: 'üëÅÔ∏è Creador de Dinast√≠as üëÅÔ∏è',
                nextQuest: '‚àû LEYENDA INMORTAL ‚àû',
                nextObjective: 'Alcanzar $10,000,000 USD de capital',
                lifeReward: 'üõ©Ô∏è Jet (fracci√≥n) / Yate grande',
                strategy: 'Trust / Fundaci√≥n familiar',
                legendary: true
            },
            '‚àû LEYENDA INMORTAL ‚àû': {
                xpReward: Infinity, chapter: 19,
                newRank: 'üåå Has Trascendido üåå',
                nextQuest: '‚àû BEYOND ‚àû',
                nextObjective: 'El universo es tu playground',
                lifeReward: 'üåç Lo que quieras. Ganaste.',
                strategy: 'Filantrop√≠a + Legado generacional',
                legendary: true
            }
        };

        function checkQuestCompletion(currentQuest, previousQuest) {
            // If quest name changed (new quest = previous completed)
            if (previousQuest && previousQuest !== currentQuest.name) {
                const celebratedKey = `arca_celebrated_${previousQuest}`;
                if (!localStorage.getItem(celebratedKey)) {
                    // Trigger celebration for the completed quest!
                    triggerCelebration(previousQuest);
                    localStorage.setItem(celebratedKey, 'true');
                }
            }
        }

        function triggerCelebration(questName) {
            const config = QUESTS_CONFIG[questName];
            if (!config) return;

            // Update modal content
            const questTitle = config.chapter
                ? `CAP√çTULO ${config.chapter} COMPLETADO`
                : 'MISI√ìN COMPLETADA';
            document.getElementById('celebration-quest-name').innerHTML =
                `<div style="font-size:0.6em;color:#00ff9d;margin-bottom:5px">${questTitle}</div>${questName}`;
            document.getElementById('celebration-new-rank').innerText = config.newRank;
            document.getElementById('celebration-next-quest').innerText = config.nextQuest;
            document.getElementById('celebration-next-quest').nextElementSibling.innerText = config.nextObjective;

            // Update lifeReward and strategy if elements exist
            const lifeRewardEl = document.getElementById('celebration-life-reward');
            const strategyEl = document.getElementById('celebration-strategy');
            if (lifeRewardEl) lifeRewardEl.innerText = config.lifeReward || '';
            if (strategyEl) strategyEl.innerText = config.strategy || '';

            // Show modal
            const modal = document.getElementById('quest-celebration-modal');
            modal.style.display = 'flex';

            // Add legendary glow for epic milestones
            const celebrationContent = document.getElementById('celebration-content');
            if (config.legendary) {
                celebrationContent.classList.add('legendary-celebration');
            } else {
                celebrationContent.classList.remove('legendary-celebration');
            }

            // Start confetti (more for legendary quests)
            startConfetti(config.legendary ? 300 : 150);

            // Animate XP counter
            const xpDisplay = config.xpReward === Infinity ? '‚àû' : config.xpReward;
            animateXPCounter(xpDisplay);

            // Play victory sound (optional)
            playVictorySound();
        }

        function closeCelebration() {
            document.getElementById('quest-celebration-modal').style.display = 'none';
            stopConfetti();
        }

        // XP Counter Animation
        function animateXPCounter(targetXP) {
            const counter = document.getElementById('xp-reward-counter');

            // Handle infinity symbol for legendary quests
            if (targetXP === '‚àû') {
                counter.innerText = '+‚àû';
                counter.style.animation = 'legendaryPulse 0.5s infinite';
                return;
            }

            counter.style.animation = '';
            let current = 0;
            const duration = 2000; // 2 seconds
            const steps = 60;
            const increment = targetXP / steps;
            const stepTime = duration / steps;

            const timer = setInterval(() => {
                current += increment;
                if (current >= targetXP) {
                    current = targetXP;
                    clearInterval(timer);
                }
                counter.innerText = `+${Math.floor(current).toLocaleString()}`;
            }, stepTime);
        }

        // Confetti Animation
        let confettiAnimationId = null;
        const confettiParticles = [];

        function startConfetti(particleCount = 150) {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            // Clear previous particles
            confettiParticles.length = 0;

            // Create particles - more particles for epic celebrations
            const colors = ['#ffd700', '#00ff9d', '#ff9500', '#00d4ff', '#ff3b5c', '#fff'];
            for (let i = 0; i < particleCount; i++) {
                confettiParticles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    w: Math.random() * 10 + 5,
                    h: Math.random() * 6 + 3,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    speed: Math.random() * 3 + 2,
                    angle: Math.random() * Math.PI * 2,
                    spin: (Math.random() - 0.5) * 0.2
                });
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                confettiParticles.forEach(p => {
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.angle);
                    ctx.fillStyle = p.color;
                    ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
                    ctx.restore();

                    p.y += p.speed;
                    p.angle += p.spin;
                    p.x += Math.sin(p.angle) * 0.5;

                    if (p.y > canvas.height) {
                        p.y = -20;
                        p.x = Math.random() * canvas.width;
                    }
                });

                confettiAnimationId = requestAnimationFrame(animate);
            }
            animate();
        }

        function stopConfetti() {
            if (confettiAnimationId) {
                cancelAnimationFrame(confettiAnimationId);
                confettiAnimationId = null;
            }
            confettiParticles.length = 0;
        }

        // Victory Sound (subtle chime)
        function playVictorySound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6

                notes.forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.frequency.value = freq;
                    osc.type = 'sine';
                    gain.gain.setValueAtTime(0.1, audioCtx.currentTime + i * 0.15);
                    gain.gain.exponentialDecayTo && gain.gain.exponentialDecayTo(0.01, audioCtx.currentTime + i * 0.15 + 0.3);
                    osc.start(audioCtx.currentTime + i * 0.15);
                    osc.stop(audioCtx.currentTime + i * 0.15 + 0.4);
                });
            } catch (e) { /* Audio not supported */ }
        }

        // Manual test functions (can be called from console)
        window.testCelebration = function(questName = 'El Cruce del Valle') {
            triggerCelebration(questName);
        };
        // List all available quests for testing
        window.listQuests = function() {
            console.log('üéÆ QUESTS DISPONIBLES PARA TESTING:');
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            Object.entries(QUESTS_CONFIG).forEach(([name, config], index) => {
                const legendary = config.legendary ? ' ‚≠ê LEGENDARIO' : '';
                console.log(`${index + 1}. ${name}${legendary}`);
                console.log(`   ‚Üí XP: ${config.xpReward === Infinity ? '‚àû' : config.xpReward.toLocaleString()}`);
                console.log(`   ‚Üí Rango: ${config.newRank}`);
                console.log('');
            });
            console.log('üìù Uso: testCelebration("nombre de la misi√≥n")');
            console.log('üìù Ejemplo: testCelebration("LA √âLITE MILLONARIA")');
        };

        async function fetchChart() {
            try {
                const res = await fetch('/api/profit-history');
                if (res.ok) {
                    const data = await res.json();
                    if (data.history && data.history.length > 0) {
                        GLOBAL_FULL_HISTORY = data.history;
                        renderChart(GLOBAL_FULL_HISTORY);
                    }
                }
            } catch (e) { logDebug("Chart API error: " + e.message); }
        }

        // Store custom date range
        let CUSTOM_DATE_RANGE = null;

        function updateTimeframe(days, btn) {
            CURRENT_TIMEFRAME = days;
            CUSTOM_DATE_RANGE = null; // Clear custom range when using preset

            // Clear all active states
            document.querySelectorAll('.btn-filter').forEach(b => {
                b.classList.remove('active');
                b.classList.remove('custom-active');
            });
            if (btn) btn.classList.add('active');

            // Clear date inputs
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';

            renderChart(GLOBAL_FULL_HISTORY);
        }

        function applyCustomRange() {
            const fromInput = document.getElementById('date-from');
            const toInput = document.getElementById('date-to');

            if (!fromInput.value || !toInput.value) {
                alert('Selecciona ambas fechas');
                return;
            }

            const fromDate = fromInput.value;
            const toDate = toInput.value;

            if (fromDate > toDate) {
                alert('La fecha inicial debe ser anterior a la final');
                return;
            }

            // Set custom range
            CUSTOM_DATE_RANGE = { from: fromDate, to: toDate };
            CURRENT_TIMEFRAME = 'CUSTOM';

            // Update button states
            document.querySelectorAll('.btn-filter').forEach(b => {
                b.classList.remove('active');
                b.classList.remove('custom-active');
            });

            // Highlight the apply button
            event.target.classList.add('custom-active');

            renderChart(GLOBAL_FULL_HISTORY);
        }

        function initDateInputs() {
            // Set max date to today (CDMX timezone UTC-6)
            const nowUTC = Date.now();
            const cdmxMs = nowUTC - (6 * 60 * 60 * 1000);
            const cdmxNow = new Date(cdmxMs);
            const today = cdmxNow.toISOString().split('T')[0];

            const fromInput = document.getElementById('date-from');
            const toInput = document.getElementById('date-to');

            if (fromInput && toInput) {
                fromInput.max = today;
                toInput.max = today;

                // Default "to" to today
                toInput.value = today;

                // Default "from" to 30 days ago (CDMX)
                const thirtyDaysAgoMs = cdmxMs - (30 * 24 * 60 * 60 * 1000);
                const thirtyDaysAgo = new Date(thirtyDaysAgoMs);
                fromInput.value = thirtyDaysAgo.toISOString().split('T')[0];
            }
        }

        function fillGaps(history) {
            if (!history || history.length < 2) return history;

            // Sort by date ascending
            const sorted = [...history].sort((a, b) => new Date(a.date) - new Date(b.date));

            const filled = [];

            // Get TODAY in CDMX timezone (UTC-6) as string
            const nowUTC = Date.now();
            const cdmxMs = nowUTC - (6 * 60 * 60 * 1000); // Subtract 6 hours for CDMX
            const cdmxNow = new Date(cdmxMs);
            const todayStr = cdmxNow.toISOString().split('T')[0];

            // Use string-based date comparison to avoid timezone issues
            const startStr = sorted[0].date;
            const endStr = sorted[sorted.length - 1].date;
            // NEVER show dates past today - todayStr is the absolute cap
            const finalStr = todayStr;

            console.log('[Chart Debug] Today (CDMX):', todayStr, 'EndStr:', endStr, 'Final (capped):', finalStr);

            const dateMap = new Map();
            sorted.forEach(h => dateMap.set(h.date, h));

            // Generate all dates from start to final (inclusive) using strings
            let currentDate = new Date(startStr + 'T12:00:00Z'); // Use noon UTC to avoid edge cases

            while (true) {
                const dayStr = currentDate.toISOString().split('T')[0];

                if (dayStr > finalStr) break; // Stop AFTER final date

                if (dateMap.has(dayStr)) {
                    filled.push(dateMap.get(dayStr));
                } else {
                    // Gap found: Insert 0 profit day
                    filled.push({ date: dayStr, profit: 0, equity: 0, capital: 0, isGap: true });
                }

                // Add 1 day
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return filled;
        }

        let GLOBAL_FINANCIAL_HISTORY = [];
        window.GLOBAL_MARKET_HISTORY = {}; // Changed to object and window scope for renderChart access

        // NOTE: /api/market-history endpoint doesn't exist - using equity-snapshots instead
        async function fetchMarketHistory() {
            // This endpoint doesn't exist, skip it
            // Equity snapshots are loaded via fetchEquitySnapshots() instead
            console.log('[Chart] Market History skipped - using equity-snapshots');
        }

        // Fetch REAL daily equity snapshots from Binance (recorded by bot)
        async function fetchEquitySnapshots() {
            try {
                const res = await fetch('/api/equity-snapshots');
                const data = await res.json();
                if (data && Array.isArray(data.snapshots)) {
                    // Inject snapshots into window.GLOBAL_MARKET_HISTORY for chart rendering
                    window.GLOBAL_MARKET_HISTORY.equitySnapshots = data.snapshots;
                    console.log("Loaded Equity Snapshots:", data.snapshots.length, "days", data.snapshots);
                    // Re-render chart with real data
                    if (GLOBAL_FULL_HISTORY.length > 0) {
                        renderChart(GLOBAL_FULL_HISTORY);
                    }
                }
            } catch (e) { console.error("Equity Snapshots fetch failed", e); }
        }
        fetchEquitySnapshots(); // Load on page load

        // NOTE: /api/financial-history endpoint doesn't exist - not needed for chart
        async function fetchFinancialHistory() {
            // This endpoint doesn't exist, skip it
            console.log('[Chart] Financial History skipped - not needed');
        }

        function renderChart(historyRaw) {
            LAST_RENDERED_EQUITY = GLOBAL_EQUITY;

            // 1. FILL GAPS first
            const history = fillGaps(historyRaw);

            // 2. FILTER - Support for various timeframe types
            let filtered = [];
            let startIndex = 0;

            if (CURRENT_TIMEFRAME === 'ALL') {
                // Show all data
                filtered = history;
                startIndex = 0;
            } else if (CURRENT_TIMEFRAME === 'YTD') {
                // Year to date - from Jan 1st of current year
                const currentYear = new Date().getFullYear();
                const ytdStart = `${currentYear}-01-01`;
                filtered = history.filter(h => h.date >= ytdStart);
                startIndex = history.findIndex(h => h.date >= ytdStart);
                if (startIndex < 0) startIndex = 0;
            } else if (CURRENT_TIMEFRAME === 'CUSTOM' && CUSTOM_DATE_RANGE) {
                // Custom date range
                filtered = history.filter(h =>
                    h.date >= CUSTOM_DATE_RANGE.from &&
                    h.date <= CUSTOM_DATE_RANGE.to
                );
                startIndex = history.findIndex(h => h.date >= CUSTOM_DATE_RANGE.from);
                if (startIndex < 0) startIndex = 0;
            } else {
                // Numeric days (1, 7, 14, 30, 90, 180, etc.)
                const limit = parseInt(CURRENT_TIMEFRAME) || 30;
                filtered = history.slice(-limit);
                startIndex = Math.max(0, history.length - limit);
            }

            // Safety check - ensure we have data
            if (filtered.length === 0 && history.length > 0) {
                console.warn('[Chart] No data in selected range, showing all');
                filtered = history;
                startIndex = 0;
            }

            // 3. PREPARE DATA - Robust Deposit & Equity Calculation
            let currentDepositSum = 0;
            const depositsCumulative = [];
            const equityReconstructed = [];

            // Helper: Get sorted deposits
            let sortedDeposits = [];
            if (window.DEPOSIT_DATA && window.DEPOSIT_DATA.deposits) {
                sortedDeposits = [...window.DEPOSIT_DATA.deposits].sort((a, b) => a.date.localeCompare(b.date));
            }

            // A. Calculate Cumulative Profits first
            let runningProfit = 0;
            const profitCumulative = history.map(h => {
                runningProfit += (h.profit || 0);
                return runningProfit;
            });

            // B. Build Deposit Curve synchronous with History
            let depIndex = 0;

            // Pre-calculate deposits before history start
            if (history.length > 0) {
                const startDate = history[0].date;
                while (depIndex < sortedDeposits.length && sortedDeposits[depIndex].date < startDate) {
                    currentDepositSum += sortedDeposits[depIndex].amount;
                    depIndex++;
                }
            }

            history.forEach((h, i) => {
                // Add deposits for this specific day
                while (depIndex < sortedDeposits.length && sortedDeposits[depIndex].date === h.date) {
                    currentDepositSum += sortedDeposits[depIndex].amount;
                    depIndex++;
                }

                depositsCumulative.push(currentDepositSum);

                // Reconstruct Equity: Capital + Realized Profit
                // This gives the "floor" equity (ignoring unrealized PnL)
                equityReconstructed.push(currentDepositSum + profitCumulative[i]);
            });

            // C. Equity Curve Scaling with Volatility (Market-Aware)

            const realCurrentEquity = window.DEPOSIT_DATA?.currentEquity || currentDepositSum;
            const lastReconstructed = equityReconstructed[equityReconstructed.length - 1];

            // 1. Calculate Base Scaling (Book Value -> Book Equity)
            let baseScalingFactor = 1;
            if (lastReconstructed > 0 && realCurrentEquity > 0) {
                baseScalingFactor = realCurrentEquity / lastReconstructed;
            }

            // 2. Apply Price Volatility using GLOBAL_MARKET_HISTORY
            // K-Lines provide true daily volatility

            // Map Market History to Dates
            const priceMap = new Map();
            const snapshotMap = new Map(); // NEW: Hard Data Map

            if (window.GLOBAL_MARKET_HISTORY) {
                if (Array.isArray(window.GLOBAL_MARKET_HISTORY.history)) {
                    window.GLOBAL_MARKET_HISTORY.history.forEach(p => priceMap.set(p.date, p.price));
                }
                if (Array.isArray(window.GLOBAL_MARKET_HISTORY.equitySnapshots)) {
                    window.GLOBAL_MARKET_HISTORY.equitySnapshots.forEach(s => snapshotMap.set(s.date, s.equity));
                    console.log('[Chart] snapshotMap loaded:', snapshotMap.size, 'entries', [...snapshotMap.entries()]);
                } else {
                    console.log('[Chart] No equitySnapshots found in GLOBAL_MARKET_HISTORY');
                }
            }

            // Find current price (last available) or from deposit data
            let currentPrice = 0;
            if (window.GLOBAL_MARKET_HISTORY && window.GLOBAL_MARKET_HISTORY.history && window.GLOBAL_MARKET_HISTORY.history.length > 0) {
                currentPrice = window.GLOBAL_MARKET_HISTORY.history[window.GLOBAL_MARKET_HISTORY.history.length - 1].price;
            }

            // Build clean equity curve: JUST deposits + profit (no scaling or volatility)
            const equityCurve = equityReconstructed.map((val, i) => {
                const date = history[i].date;

                // PRIORITY 1: Use real Binance snapshot if available
                if (snapshotMap.has(date)) {
                    return snapshotMap.get(date);
                }

                // PRIORITY 2: Use reconstructed value (deposits + cumulative profit)
                // NO volatility adjustment - this causes the weird fluctuations
                return val;
            });

            const slicedEquity = equityCurve.slice(startIndex);
            const slicedDeposits = depositsCumulative.slice(startIndex);
            const slicedProfits = filtered.map(h => h.profit);
            const slicedLabels = filtered.map(h => h.date.substring(5));

            // Cumulative profit for Chart 2 - Total + Per Bot
            let runningTotal = 0;
            let runningBTC = 0;
            let runningSOL = 0;
            let runningDOGE = 0;

            const absoluteCumulative = history.map(h => {
                runningTotal += (h.profit || 0);
                return runningTotal;
            });

            const btcCumulative = history.map(h => {
                runningBTC += (h.btc || 0);
                return runningBTC;
            });

            const solCumulative = history.map(h => {
                runningSOL += (h.sol || 0);
                return runningSOL;
            });

            const dogeCumulative = history.map(h => {
                runningDOGE += (h.doge || 0);
                return runningDOGE;
            });

            const slicedCumulative = absoluteCumulative.slice(startIndex);
            const slicedBTC = btcCumulative.slice(startIndex);
            const slicedSOL = solCumulative.slice(startIndex);
            const slicedDOGE = dogeCumulative.slice(startIndex);

            // Colors
            const COLOR_GOLD = '#ffd700';
            const COLOR_CYAN = '#00f0ff';
            const COLOR_ORANGE = '#ff8c00';
            const COLOR_EMERALD = '#00ff9d';
            const COLOR_BTC = '#f7931a';      // Bitcoin orange
            const COLOR_SOL = '#9945ff';      // Solana purple
            const COLOR_DOGE = '#c2a633';     // Dogecoin gold/tan
            const COLOR_GRID = 'rgba(255, 255, 255, 0.05)';
            const FONT_UI = "'Outfit', sans-serif";

            // ========== CHART 1: Capital vs Equity ==========
            const canvas1 = document.getElementById('equity-chart');
            if (canvas1) {
                if (window.equityChart instanceof Chart) window.equityChart.destroy();
                const ctx1 = canvas1.getContext('2d');

                const gradfillCyan = ctx1.createLinearGradient(0, 0, 0, 250);
                gradfillCyan.addColorStop(0, 'rgba(0, 240, 255, 0.2)');
                gradfillCyan.addColorStop(1, 'rgba(0, 240, 255, 0.0)');

                window.equityChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: slicedLabels,
                        datasets: [
                            {
                                label: 'Equity Total',
                                data: slicedEquity,
                                borderColor: COLOR_CYAN,
                                backgroundColor: gradfillCyan,
                                borderWidth: 2,
                                pointRadius: 2,
                                pointHoverRadius: 5,
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'Capital Invertido',
                                data: slicedDeposits.length > 0 ? slicedDeposits : null,
                                borderColor: COLOR_ORANGE,
                                backgroundColor: 'rgba(255, 140, 0, 0.1)',
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: false,
                                stepped: 'before'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { display: true, position: isMobileDevice ? 'top' : 'top', labels: { color: '#ccc', font: { family: FONT_UI, size: isMobileDevice ? 8 : 10 }, usePointStyle: true, boxWidth: isMobileDevice ? 8 : 12, padding: isMobileDevice ? 5 : 10 } },
                            tooltip: {
                                backgroundColor: 'rgba(10, 10, 16, 0.95)',
                                callbacks: {
                                    label: ctx => `${ctx.dataset.label}: $${ctx.parsed.y.toFixed(2)}`
                                }
                            }
                        },
                        scales: {
                            x: { grid: { color: COLOR_GRID }, ticks: { color: '#666', font: { size: isMobileDevice ? 8 : 10 }, maxTicksLimit: isMobileDevice ? 6 : 12, maxRotation: 45 } },
                            y: {
                                beginAtZero: false,
                                grid: { color: COLOR_GRID },
                                ticks: { color: COLOR_CYAN, callback: v => '$' + v }
                            }
                        }
                    }
                });

                // SYNC CHECK: Use Retry Logic to handle Race Condition (Header load vs Chart load)
                if (typeof slicedCumulative !== 'undefined' && slicedCumulative.length > 0) {
                    const finalChartProfit = slicedCumulative[slicedCumulative.length - 1];
                    window.FINAL_CHART_PROFIT = finalChartProfit; // Global Switch for Poller

                    const performSync = () => {
                        const headerProfitEl = document.getElementById('total-profit');
                        if (!headerProfitEl) return;

                        const currentText = headerProfitEl.innerText;
                        // If header is loading or empty, wait for next retry
                        if (!currentText || currentText === 'Loading...' || currentText.includes('$0.00')) {
                            return;
                        }

                        const currentHeaderVal = parseFloat(currentText.replace(/[$,]/g, '')) || 0;

                        // Compare with 2 decimal precision to avoid floating point noise
                        const currentRounded = parseFloat(currentHeaderVal.toFixed(2));
                        const chartRounded = parseFloat(finalChartProfit.toFixed(2));

                        // Only sync if values are actually different after rounding
                        if (currentRounded !== chartRounded && Math.abs(chartRounded - currentRounded) < 1.0) {
                            console.log(`[Sync] Adjusting Header Profit to match Chart: $${currentRounded} -> $${chartRounded}`);
                            const mxnRate = window.usdMxnRate || 18.0;
                            const profitMXN = chartRounded * mxnRate;
                            headerProfitEl.innerHTML = `$${chartRounded.toFixed(2)} <small style="color:#888;font-size:0.65em">‚âà $${profitMXN.toFixed(0)} MXN</small>`;
                            headerProfitEl.style.textShadow = "0 0 10px var(--gold-primary)";
                            setTimeout(() => headerProfitEl.style.textShadow = "", 1000);
                        }
                    };

                    // Run immediately and retry a few times to catch the fetchStatus update
                    performSync();
                    setTimeout(performSync, 500);
                    setTimeout(performSync, 1500);
                    setTimeout(performSync, 3000);
                }
            }

            // ========== CHART 2: Profit Tracking ==========

            const canvas2 = document.getElementById('profit-chart');
            if (canvas2) {
                if (window.profitChart instanceof Chart) window.profitChart.destroy();
                const ctx2 = canvas2.getContext('2d');

                const gradfillGold = ctx2.createLinearGradient(0, 0, 0, 200);
                gradfillGold.addColorStop(0, 'rgba(255, 215, 0, 0.2)');
                gradfillGold.addColorStop(1, 'rgba(255, 215, 0, 0.0)');

                window.profitChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: slicedLabels,
                        datasets: [
                            {
                                label: 'Total Acumulado',
                                data: slicedCumulative,
                                type: 'line',
                                borderColor: COLOR_GOLD,
                                backgroundColor: gradfillGold,
                                borderWidth: 3,
                                pointRadius: 2,
                                fill: true,
                                tension: 0.3,
                                yAxisID: 'y_cumulative',
                                order: 0
                            },
                            {
                                label: 'BTC',
                                data: slicedBTC,
                                type: 'line',
                                borderColor: COLOR_BTC,
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                pointRadius: 0,
                                pointHoverRadius: 4,
                                fill: false,
                                tension: 0.3,
                                yAxisID: 'y_cumulative',
                                order: 1
                            },
                            {
                                label: 'SOL',
                                data: slicedSOL,
                                type: 'line',
                                borderColor: COLOR_SOL,
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                pointRadius: 0,
                                pointHoverRadius: 4,
                                fill: false,
                                tension: 0.3,
                                yAxisID: 'y_cumulative',
                                order: 2
                            },
                            {
                                label: 'DOGE',
                                data: slicedDOGE,
                                type: 'line',
                                borderColor: COLOR_DOGE,
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                pointRadius: 0,
                                pointHoverRadius: 4,
                                fill: false,
                                tension: 0.3,
                                yAxisID: 'y_cumulative',
                                order: 3
                            },
                            {
                                label: 'Bot√≠n Diario',
                                data: slicedProfits,
                                backgroundColor: ctx => (ctx.raw || 0) >= 0 ? 'rgba(0, 255, 157, 0.7)' : 'rgba(255, 42, 109, 0.7)',
                                borderColor: ctx => (ctx.raw || 0) >= 0 ? COLOR_EMERALD : '#ff2a6d',
                                borderWidth: 1,
                                borderRadius: 3,
                                yAxisID: 'y_daily',
                                order: 4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { display: true, labels: { color: '#ccc', font: { family: FONT_UI, size: 10 }, usePointStyle: true } },
                            tooltip: {
                                backgroundColor: 'rgba(10, 10, 16, 0.95)',
                                callbacks: {
                                    label: ctx => `${ctx.dataset.label}: $${ctx.parsed.y.toFixed(2)}`
                                }
                            }
                        },
                        scales: {
                            x: { grid: { color: COLOR_GRID }, ticks: { color: '#666', font: { size: typeof isMobileDevice !== 'undefined' && isMobileDevice ? 8 : 10 }, maxTicksLimit: typeof isMobileDevice !== 'undefined' && isMobileDevice ? 6 : 12 } },
                            y_daily: {
                                type: 'linear',
                                position: 'left',
                                grid: { color: COLOR_GRID },
                                ticks: { color: COLOR_EMERALD, callback: v => '$' + v },
                                title: { display: true, text: 'Diario', color: '#555', font: { size: 9 } }
                            },
                            y_cumulative: {
                                type: 'linear',
                                position: 'right',
                                grid: { drawOnChartArea: false },
                                ticks: { color: COLOR_GOLD, callback: v => '$' + v },
                                title: { display: true, text: 'Total', color: '#555', font: { size: 9 } }
                            }
                        }
                    }
                });
            }
        }

        // ============================================
        // CAPITAL TRACKER FUNCTIONS
        // ============================================
        async function fetchDeposits() {
            try {
                const res = await fetch('/api/deposits');
                if (res.ok) {
                    const data = await res.json();

                    // Store globally for chart access
                    window.DEPOSIT_DATA = data;

                    // Update summary cards
                    document.getElementById('cap-deposited').innerText = `$${data.totalDeposited.toFixed(2)}`;
                    document.getElementById('cap-current').innerText = `$${data.currentEquity.toFixed(2)}`;

                    // UPDATE HERO ROW (Protagonists)
                    const profitEl = document.getElementById('cap-profit');
                    if (profitEl) {
                        const mxnRate = window.usdMxnRate || 18.0;
                        const profitMXN = data.profit * mxnRate;
                        profitEl.innerHTML = `${data.profit >= 0 ? '+' : ''}$${data.profit.toFixed(2)} <small style="color:#888;font-size:0.65em">‚âà $${profitMXN.toFixed(0)} MXN</small>`;
                        profitEl.style.color = data.profit >= 0 ? 'var(--emerald-life)' : 'var(--ruby-danger)';
                    }

                    // Update Table/Tracker if exists
                    const profitTableEl = document.getElementById('cap-profit-table');
                    if (profitTableEl) {
                        profitTableEl.innerText = `${data.profit >= 0 ? '+' : ''}$${data.profit.toFixed(2)}`;
                        profitTableEl.style.color = data.profit >= 0 ? 'var(--emerald-life)' : 'var(--ruby-danger)';
                    }


                    const roiEl = document.getElementById('cap-roi');
                    roiEl.innerText = `${data.roi >= 0 ? '+' : ''}${data.roi.toFixed(2)}%`;
                    roiEl.style.color = data.roi >= 0 ? '#ba55d3' : 'var(--ruby-danger)';

                    // Render history
                    renderDeposits(data.deposits);

                    // PRE-CALCULATE APY (stable, not recalculated every poll)
                    const actualDeposits = (data.deposits || []).filter(d => d.type !== 'rebalance' && d.amount > 0);
                    if (actualDeposits.length > 0) {
                        const sortedDeposits = [...actualDeposits].sort((a, b) =>
                            new Date(a.date).getTime() - new Date(b.date).getTime()
                        );
                        const now = Date.now();
                        let totalWeightedCapital = 0;
                        let totalDays = 0;
                        let runningCapital = 0;
                        for (let i = 0; i < sortedDeposits.length; i++) {
                            const deposit = sortedDeposits[i];
                            const depositDate = new Date(deposit.date).getTime();
                            const nextDate = (i < sortedDeposits.length - 1)
                                ? new Date(sortedDeposits[i + 1].date).getTime()
                                : now;
                            runningCapital += deposit.amount;
                            const periodDays = Math.max(0, (nextDate - depositDate) / (1000 * 60 * 60 * 24));
                            totalWeightedCapital += runningCapital * periodDays;
                            totalDays += periodDays;
                        }
                        window.APY_TWR_CAPITAL = totalDays > 0 ? (totalWeightedCapital / totalDays) : runningCapital;
                        window.APY_DAYS_ACTIVE = totalDays || 1;
                    }

                    // Update monthly goal tracker
                    updateMonthlyGoal(data.deposits);
                }
            } catch (e) {
                console.error('Deposits fetch failed:', e.message);
            }
        }

        function updateMonthlyGoal(deposits) {
            const MONTHLY_GOAL = 500; // Meta mensual en USD

            // Get current month info
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth(); // 0-indexed

            // Month names in Spanish
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

            // Filter deposits for current month (excluding rebalances)
            const monthlyDeposits = (deposits || []).filter(d => {
                if (d.type === 'rebalance') return false;
                const depositDate = new Date(d.date);
                return depositDate.getFullYear() === currentYear &&
                       depositDate.getMonth() === currentMonth;
            });

            // Calculate total for this month
            const monthlyTotal = monthlyDeposits.reduce((sum, d) => sum + (d.amount || 0), 0);
            const percentage = Math.min((monthlyTotal / MONTHLY_GOAL) * 100, 100);
            const isComplete = monthlyTotal >= MONTHLY_GOAL;

            // Update UI elements
            const monthEl = document.getElementById('monthly-goal-month');
            const statusEl = document.getElementById('monthly-goal-status');
            const barEl = document.getElementById('monthly-goal-bar');
            const amountEl = document.getElementById('monthly-goal-amount');
            const detailEl = document.getElementById('monthly-goal-detail');

            if (monthEl) monthEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            if (amountEl) amountEl.textContent = `$${monthlyTotal.toFixed(0)}`;
            if (barEl) barEl.style.width = `${percentage}%`;

            if (statusEl) {
                if (isComplete) {
                    statusEl.textContent = '‚úÖ Completado';
                    statusEl.style.background = 'rgba(0,255,157,0.2)';
                    statusEl.style.color = 'var(--emerald-life)';
                } else {
                    statusEl.textContent = '‚è≥ Pendiente';
                    statusEl.style.background = 'rgba(255,165,0,0.2)';
                    statusEl.style.color = '#ffa500';
                }
            }

            if (detailEl) {
                if (isComplete) {
                    const extra = monthlyTotal - MONTHLY_GOAL;
                    if (extra > 0) {
                        detailEl.textContent = `üéâ Meta alcanzada! +$${extra.toFixed(0)} extra este mes`;
                    } else {
                        detailEl.textContent = `üéâ Meta alcanzada! Excelente disciplina de ahorro`;
                    }
                    detailEl.style.color = 'var(--emerald-life)';
                } else {
                    const remaining = MONTHLY_GOAL - monthlyTotal;
                    const daysLeft = new Date(currentYear, currentMonth + 1, 0).getDate() - now.getDate();
                    detailEl.textContent = `Faltan $${remaining.toFixed(0)} para completar la meta (${daysLeft} d√≠as restantes)`;
                    detailEl.style.color = '#888';
                }
            }

            // Change bar color based on progress
            if (barEl) {
                if (isComplete) {
                    barEl.style.background = 'linear-gradient(90deg, var(--emerald-life), #00ff9d)';
                } else if (percentage >= 50) {
                    barEl.style.background = 'linear-gradient(90deg, var(--gold-primary), #ffd700)';
                } else {
                    barEl.style.background = 'linear-gradient(90deg, #ff8c00, #ffa500)';
                }
            }
        }

        function renderDeposits(deposits) {
            const container = document.getElementById('deposit-history');
            if (!deposits || deposits.length === 0) {
                container.innerHTML = '<div style="padding: 15px; text-align: center; color: #555; font-size: 0.8rem;">No hay dep√≥sitos registrados</div>';
                return;
            }

            container.innerHTML = deposits.map(d => `
                <div style="display: grid; grid-template-columns: 1fr 1fr 2fr 60px; padding: 10px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center;">
                    <div style="color: #aaa; font-size: 0.8rem;">${d.date}</div>
                    <div style="color: var(--gold-primary); font-weight: bold;">$${d.amount.toFixed(2)}</div>
                    <div style="color: #888; font-size: 0.8rem;">${d.note || '-'}</div>
                    <div style="text-align: center;">
                        <button onclick="deleteDeposit(${d.id})" style="background: rgba(255,42,109,0.2); border: none; color: var(--ruby-danger); padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.7rem;">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        async function addDeposit() {
            const dateInput = document.getElementById('deposit-date');
            const amountInput = document.getElementById('deposit-amount');
            const noteInput = document.getElementById('deposit-note');

            const date = dateInput.value;
            const amount = parseFloat(amountInput.value);
            const note = noteInput.value;

            if (!date || !amount || isNaN(amount)) {
                alert('Por favor ingresa fecha y monto v√°lidos');
                return;
            }

            try {
                const res = await fetch('/api/deposits', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date, amount, note })
                });

                if (res.ok) {
                    // Clear form
                    dateInput.value = '';
                    amountInput.value = '';
                    noteInput.value = '';
                    // Refresh
                    fetchDeposits();
                } else {
                    const err = await res.json();
                    alert('Error: ' + (err.error || 'No se pudo agregar'));
                }
            } catch (e) {
                alert('Error de red: ' + e.message);
            }
        }

        async function deleteDeposit(id) {
            if (!confirm('¬øEliminar este dep√≥sito?')) return;

            try {
                const res = await fetch(`/api/deposits/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    fetchDeposits();
                } else {
                    alert('Error al eliminar');
                }
            } catch (e) {
                alert('Error de red: ' + e.message);
            }
        }

        // ============================================
        // ANALYTICS FUNCTIONS
        // ============================================
        async function fetchAnalytics() {
            try {
                const res = await fetch('/api/analytics');
                if (res.ok) {
                    const data = await res.json();

                    // ROI Cards
                    document.getElementById('roi-today').innerText = `${data.roi.daily >= 0 ? '+' : ''}${data.roi.daily}%`;
                    document.getElementById('roi-weekly').innerText = `${data.roi.weekly >= 0 ? '+' : ''}${data.roi.weekly}%`;
                    document.getElementById('roi-monthly').innerText = `${data.roi.monthly >= 0 ? '+' : ''}${data.roi.monthly}%`;
                    document.getElementById('roi-alltime').innerText = `${data.roi.allTime >= 0 ? '+' : ''}${data.roi.allTime}%`;

                    // Stats Row
                    document.getElementById('win-rate').innerText = `${data.performance.winRate}%`;
                    document.getElementById('avg-daily').innerText = `$${data.performance.avgDailyProfit}`;
                    document.getElementById('best-day').innerText = `$${data.highlights.bestDay.profit}`;
                    document.getElementById('max-drawdown').innerText = `${data.risk.maxDrawdownPercent}%`;

                    // Streak
                    document.getElementById('streak-display').innerText = data.streaks.current;
                    document.getElementById('streak-display').style.color = data.streaks.currentType === 'win' ? 'var(--emerald-life)' : '#ff6b6b';
                    document.getElementById('streak-type').innerText = data.streaks.currentType === 'win' ? 'd√≠as positivos üî•' : 'd√≠as negativos';
                    document.getElementById('longest-win').innerText = data.streaks.longestWin;

                    // Bot Leaderboard
                    const leaderboard = document.getElementById('bot-leaderboard');
                    if (data.botComparison && data.botComparison.length > 0) {
                        leaderboard.innerHTML = data.botComparison.map((b, i) => {
                            const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '';
                            return `<div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <span>${medal} ${b.name}</span>
                                <span style="color: var(--gold-primary);">$${b.profit} <span style="color: #666; font-size: 0.65rem;">(${b.roi}%)</span></span>
                            </div>`;
                        }).join('');
                    }
                }
            } catch (e) {
                console.error('Analytics fetch failed:', e.message);
            }
        }

        // ============================================
        // ADVANCED INSIGHTS FUNCTIONS
        // ============================================

        async function fetchTradeActivity() {
            try {
                const res = await fetch('/api/trade-activity');
                if (res.ok) {
                    const data = await res.json();
                    renderHeatmap(data);

                    // Update peak hour info
                    const peakInfo = document.getElementById('peak-hour-info');
                    if (peakInfo && data.peakHour) {
                        peakInfo.innerHTML = `Hora pico: <strong>${data.peakHour.day} ${data.peakHour.hour}</strong> (${data.peakHour.count} trades) | Total: ${data.totalTrades}`;
                    }
                }
            } catch (e) { console.error('Trade activity fetch failed:', e.message); }
        }

        function renderHeatmap(data) {
            const canvas = document.getElementById('activity-heatmap');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;

            const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            const hourRanges = ['00-04', '04-08', '08-12', '12-16', '16-20', '20-24'];

            const cellWidth = (canvas.width - 50) / 7;
            const cellHeight = (canvas.height - 30) / 6;
            const offsetX = 50;
            const offsetY = 20;

            // Find max count for color scaling
            const maxCount = Math.max(...data.heatmap.map(h => h.count), 1);

            // Clear canvas
            ctx.fillStyle = 'transparent';
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw day labels
            ctx.fillStyle = '#888';
            ctx.font = '10px Outfit';
            ctx.textAlign = 'center';
            dayNames.forEach((day, i) => {
                ctx.fillText(day, offsetX + i * cellWidth + cellWidth / 2, 12);
            });

            // Draw hour labels
            ctx.textAlign = 'right';
            hourRanges.forEach((hr, i) => {
                ctx.fillText(hr, 45, offsetY + i * cellHeight + cellHeight / 2 + 4);
            });

            // Draw heatmap cells
            for (let day = 0; day < 7; day++) {
                for (let hourBlock = 0; hourBlock < 6; hourBlock++) {
                    // Sum 4 hours per block
                    let count = 0;
                    for (let h = hourBlock * 4; h < (hourBlock + 1) * 4; h++) {
                        const idx = day * 24 + h;
                        count += data.heatmap[idx]?.count || 0;
                    }

                    const intensity = count / maxCount;
                    const x = offsetX + day * cellWidth;
                    const y = offsetY + hourBlock * cellHeight;

                    // Color gradient: dark gray -> cyan
                    const r = Math.floor(10 + intensity * 0);
                    const g = Math.floor(10 + intensity * 200);
                    const b = Math.floor(20 + intensity * 255);
                    ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
                    ctx.fillRect(x + 2, y + 2, cellWidth - 4, cellHeight - 4);

                    // Show count if > 0
                    if (count > 0) {
                        ctx.fillStyle = intensity > 0.5 ? '#000' : '#fff';
                        ctx.font = '9px Outfit';
                        ctx.textAlign = 'center';
                        ctx.fillText(count, x + cellWidth / 2, y + cellHeight / 2 + 3);
                    }
                }
            }
        }

        async function fetchBotComparison() {
            try {
                const res = await fetch('/api/bot-comparison');
                if (res.ok) {
                    const data = await res.json();
                    renderBotDonut(data);

                    // Update legend
                    const legend = document.getElementById('bot-legend');
                    if (legend && data.bots) {
                        legend.innerHTML = data.bots.map(bot => `
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <div style="width: 12px; height: 12px; border-radius: 2px; background: ${bot.color};"></div>
                                <span style="color: #fff; flex: 1;">${bot.name}</span>
                                <span style="color: ${bot.color}; font-weight: bold;">$${bot.profit.toFixed(2)}</span>
                                <span style="color: #666; font-size: 0.6rem;">(${bot.percentage}%)</span>
                            </div>
                        `).join('');
                    }

                    // Update total
                    const totalDisplay = document.getElementById('total-profit-display');
                    if (totalDisplay) {
                        totalDisplay.innerHTML = `Total: <strong>$${data.totalProfit.toFixed(2)}</strong> (${data.totalTrades} trades)`;
                    }
                }
            } catch (e) { console.error('Bot comparison fetch failed:', e.message); }
        }

        function renderBotDonut(data) {
            const canvas = document.getElementById('bot-donut-chart');
            if (!canvas || !data.bots || data.bots.length === 0) return;

            if (window.botDonutChart instanceof Chart) window.botDonutChart.destroy();

            const ctx = canvas.getContext('2d');
            window.botDonutChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.bots.map(b => b.name),
                    datasets: [{
                        data: data.bots.map(b => b.profit),
                        backgroundColor: data.bots.map(b => b.color),
                        borderColor: '#0a0a10',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(10, 10, 16, 0.95)',
                            callbacks: {
                                label: (ctx) => `$${ctx.raw.toFixed(2)} (${data.bots[ctx.dataIndex].percentage}%)`
                            }
                        }
                    }
                }
            });
        }

        async function fetchSpreadDistribution() {
            try {
                const res = await fetch('/api/spread-distribution');
                if (res.ok) {
                    const data = await res.json();
                    renderSpreadChart(data);

                    const avgInfo = document.getElementById('spread-avg-info');
                    if (avgInfo) {
                        avgInfo.innerHTML = `Spread promedio: <strong>${data.avgSpread}%</strong> | Rango √≥ptimo: <strong style="color: var(--emerald-life);">${data.optimalRange}</strong>`;
                    }
                }
            } catch (e) { console.error('Spread distribution fetch failed:', e.message); }
        }

        function renderSpreadChart(data) {
            const canvas = document.getElementById('spread-chart');
            if (!canvas || !data.distribution) return;

            if (window.spreadChart instanceof Chart) window.spreadChart.destroy();

            const ctx = canvas.getContext('2d');
            window.spreadChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.distribution.map(d => d.label),
                    datasets: [{
                        label: 'Trades',
                        data: data.distribution.map(d => d.count),
                        backgroundColor: data.distribution.map(d =>
                            d.label === data.optimalRange ? 'rgba(0, 255, 157, 0.7)' : 'rgba(0, 240, 255, 0.5)'
                        ),
                        borderColor: data.distribution.map(d =>
                            d.label === data.optimalRange ? 'var(--emerald-life)' : 'var(--cyan-holo)'
                        ),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(10, 10, 16, 0.95)',
                            callbacks: {
                                afterLabel: (ctx) => `Profit: $${data.distribution[ctx.dataIndex].profit.toFixed(2)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#888' }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: '#888', font: { size: 10 } }
                        }
                    }
                }
            });
        }

        async function fetchHoldTimes() {
            try {
                const res = await fetch('/api/hold-times');
                if (res.ok) {
                    const data = await res.json();

                    // Update hold time cards
                    const botMap = { 'BTC': 'hold-btc', 'SOL': 'hold-sol', 'DOGE': 'hold-doge' };
                    data.bots.forEach(bot => {
                        const el = document.getElementById(botMap[bot.name]);
                        if (el) el.textContent = `${bot.avgHoldHours}h`;
                    });

                    const globalEl = document.getElementById('hold-global');
                    if (globalEl) globalEl.textContent = `${data.globalAvg}h`;
                }
            } catch (e) { console.error('Hold times fetch failed:', e.message); }
        }

        async function fetchAllInsights() {
            await Promise.all([
                fetchTradeActivity(),
                fetchBotComparison(),
                fetchSpreadDistribution(),
                fetchHoldTimes()
            ]);
        }

        async function init() {
            renderCompanions();

            // Wait a tick to ensure DOM is ready
            await new Promise(r => setTimeout(r, 100));

            // CRITICAL: Load deposits FIRST (other fetches need this for chart)
            await fetchDeposits();

            // Initialize date inputs with useful defaults
            initDateInputs();

            // Now load the rest (these may trigger renderChart which needs DEPOSIT_DATA)
            fetchAllData();
            fetchRPG();
            fetchLifeCoach(); // Life Coach - your mentor to millionaire
            fetchChart();
            fetchEquitySnapshots(); // Charts need snapshots too
            fetchFinancialHistory();
            fetchMarketHistory(); // NEW: Volatility Data
            fetchAnalytics(); // NEW: Performance Analytics
            fetchAllInsights();
            fetchMindset();

            setInterval(fetchAllData, 5000);
            setInterval(fetchRPG, 60000);
            setInterval(fetchLifeCoach, 120000); // Life Coach every 2 minutes
            setInterval(fetchChart, 60000);
            setInterval(fetchDeposits, 30000);
            setInterval(fetchFinancialHistory, 60000);
            setInterval(fetchMarketHistory, 60000);
            setInterval(fetchAnalytics, 60000); // Refresh analytics every minute
            setInterval(fetchAllInsights, 120000);
            setInterval(fetchMindset, 30000);
        }

        init();

        // MINDSET ANTI-FEAR SYSTEM
        // MINDSET ANTI-FEAR SYSTEM - Uses dashboard's existing netGain
        async function fetchMindset() {
            try {
                const section = document.getElementById('mindset-section');
                const msgDiv = document.getElementById('mindset-message');
                const stratDiv = document.getElementById('mindset-strategy');
                
                // Get netGain from the dashboard's existing element
                const netGainEl = document.getElementById('cap-profit');
                if (!netGainEl) return;
                
                const netGainText = netGainEl.innerText.replace('$', '').replace(',', '');
                const netGain = parseFloat(netGainText) || 0;
                
                if (netGain < 0) {
                    section.style.display = 'block';
                    const messages = [
                        "Este es un momento temporal. El bot sigue trabajando.",
                        "Los lotes comprados durante la baja son tu ventaja futura.",
                        "El mercado siempre cicla. Paciencia = Profit.",
                        "CETES no te hace millonario. El bot + paciencia si.",
                        "El flotante negativo = mas tokens a menor precio."
                    ];
                    const randomMsg = messages[Math.floor(Math.random() * messages.length)];
                    msgDiv.innerHTML = '<strong style="color:#e94560;">Net: $' + netGain.toFixed(2) + '</strong> | ' + randomMsg;
                    
                    const strategy = ["NO vendas en panico", "El bot compro barato - eso es BUENO", "Cuando suba, las ganancias seran mayores", "Tu unico trabajo: ESPERAR"];
                    stratDiv.innerHTML = strategy.map(s => 
                        '<span style="background:#2d3a4a;padding:5px 10px;border-radius:5px;font-size:0.8rem;color:#4ade80;">' + s + '</span>'
                    ).join('');
                } else {
                    section.style.display = 'none';
                }
            } catch(e) {
                console.log('Mindset error:', e);
            }
        }
    </script>
    <script>

    

    
    // ========== ACHIEVEMENTS v3 ==========
    console.log("[ACH] Script loaded");

    async function loadAchievements() {
        console.log("[ACH] Fetching...");
        try {
            const res = await fetch("/api/achievements");
            const data = await res.json();
            console.log("[ACH] Got data:", data.success);

            if (!data.success) return;

            var progressEl = document.getElementById("achievements-progress");
            if (progressEl) progressEl.innerText = "Cap " + data.completedChapters + "/" + data.totalChapters;

            var pendingBox = document.getElementById("pending-reward-box");
            if (data.nextToRedeem && pendingBox) {
                pendingBox.style.display = "block";
                window.pendingMilestoneId = data.nextToRedeem.id;
                var nameEl = document.getElementById("pending-reward-name");
                var detailEl = document.getElementById("pending-reward-detail");
                if (nameEl) nameEl.innerText = "Cap " + data.nextToRedeem.chapter + ": " + data.nextToRedeem.name;
                if (detailEl) detailEl.innerText = data.nextToRedeem.lifeReward;
            } else if (pendingBox) {
                pendingBox.style.display = "none";
            }

            // Show IN_PROGRESS mission with progress bar
            var inProgressBox = document.getElementById("in-progress-box");
            if (data.inProgress && inProgressBox) {
                inProgressBox.style.display = "block";
                var ipName = document.getElementById("in-progress-name");
                var ipDetail = document.getElementById("in-progress-detail");
                var ipBar = document.getElementById("in-progress-bar");
                var ipPercent = document.getElementById("in-progress-percent");
                if (ipName) ipName.innerText = "Cap " + data.inProgress.chapter + ": " + data.inProgress.name;
                if (ipDetail) ipDetail.innerText = "$" + Math.round(data.currentEquity).toLocaleString() + " / $" + data.inProgress.equity.toLocaleString() + " USD";
                if (ipBar) ipBar.style.width = data.inProgress.progressPercent + "%";
                if (ipPercent) ipPercent.innerText = data.inProgress.progressPercent + "%";
            } else if (inProgressBox) {
                inProgressBox.style.display = "none";
            }

            var timeline = document.getElementById("milestones-timeline");
            if (timeline && data.achievements) {
                var h = "";
                data.achievements.forEach(function(a) {
                    var bg = "rgba(50,50,50,0.5)", bd = "#333", ic = "üîí";
                    if (a.status === "REDEEMED") { bg = "rgba(0,255,100,0.15)"; bd = "#00ff64"; ic = "‚úÖ"; }
                    else if (a.status === "PENDING_REWARD") { bg = "rgba(255,215,0,0.2)"; bd = "#ffd700"; ic = "üéÅ"; }
                    else if (a.status === "IN_PROGRESS") { bg = "rgba(0,200,255,0.15)"; bd = "#00d4ff"; ic = "‚ö°"; }
                    h += "<div style='background:" + bg + ";border:1px solid " + bd + ";border-radius:8px;padding:10px 15px;text-align:center;min-width:70px;position:relative;overflow:hidden;'>";
                    if (a.status === "IN_PROGRESS" && a.progressPercent > 0) {
                        h += "<div style='position:absolute;bottom:0;left:0;width:" + a.progressPercent + "%;height:3px;background:#00d4ff;'></div>";
                    }
                    h += "<div style='font-size:1.2rem;'>" + ic + "</div>";
                    h += "<div style='font-size:0.65rem;color:#888;'>Cap " + a.chapter + "</div>";
                    h += "<div style='font-size:0.75rem;color:#fff;font-weight:bold;'>$" + (a.equity >= 1000 ? Math.round(a.equity/100)/10 + "K" : a.equity) + "</div>";
                    if (a.status === "IN_PROGRESS") { h += "<div style='font-size:0.55rem;color:#00d4ff;'>" + a.progressPercent + "%</div>"; }
                    h += "</div>";
                });
                timeline.innerHTML = h;
            }

            var nextEl = document.getElementById("next-rewards");
            if (nextEl && data.achievements) {
                var locked = data.achievements.filter(function(x) { return x.status === "LOCKED"; }).slice(0, 3);
                var h2 = "";
                locked.forEach(function(a) {
                    h2 += "<div style='background:rgba(20,20,30,0.6);border:1px solid #444;border-radius:10px;padding:15px;'>";
                    h2 += "<div style='display:flex;justify-content:space-between;margin-bottom:10px;'>";
                    h2 += "<span style='font-size:0.75rem;color:#666;'>Cap " + a.chapter + "</span>";
                    h2 += "<span style='font-size:0.9rem;color:#b8860b;font-weight:bold;'>$" + a.equity.toLocaleString() + "</span></div>";
                    h2 += "<div style='font-size:0.85rem;color:#aaa;margin-bottom:8px;'>" + a.name + "</div>";
                    h2 += "<div style='font-size:0.95rem;color:#00ff64;'>" + a.lifeReward + "</div></div>";
                });
                nextEl.innerHTML = h2;
            }

            // Show redeemed rewards
            var redeemedBox = document.getElementById("redeemed-rewards-box");
            var redeemedList = document.getElementById("redeemed-rewards-list");
            if (redeemedBox && redeemedList && data.achievements) {
                var redeemed = data.achievements.filter(function(x) { return x.status === "REDEEMED"; });
                if (redeemed.length > 0) {
                    redeemedBox.style.display = "block";
                    var rh = "";
                    redeemed.forEach(function(a) {
                        rh += "<div style='display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1);'>";
                        rh += "<div><span style='color:#00ff64;'>‚úÖ Cap " + a.chapter + ":</span> <span style='color:#fff;'>" + a.name + "</span></div>";
                        rh += "<div style='color:#00ff64;font-weight:bold;'>" + a.lifeReward + "</div>";
                        rh += "</div>";
                    });
                    redeemedList.innerHTML = rh;
                } else {
                    redeemedBox.style.display = "none";
                }
            }
            console.log("[ACH] Done!");
        } catch (err) { console.error("[ACH] Error:", err); }
    }

    async function claimReward() {
        if (!window.pendingMilestoneId) return;
        try {
            var res = await fetch("/api/achievements/redeem", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ milestoneId: window.pendingMilestoneId })
            });
            var data = await res.json();
            if (data.success) { alert("üéâ ¬°Life Reward reclamado!"); loadAchievements(); }
        } catch (err) { console.error("[ACH] Claim error:", err); }
    }

    setTimeout(loadAchievements, 2000);
    setInterval(loadAchievements, 60000);

    </script>
</body>

</html>
