<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS ELITE - Dashboard</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link href="styles/rpg-theme.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>

    <div class="loading-overlay" id="loading"
        style="position:fixed; inset:0; background:#050508; display:flex; align-items:center; justify-content:center; z-index:9999; transition:opacity 0.5s;">
        <div class="loader"
            style="width:50px; height:50px; border:3px solid #333; border-top-color:var(--gold-primary); border-radius:50%; animation:spin 1s infinite linear;">
        </div>
    </div>
    <style>
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>

    <div class="container" style="max-width: 1400px; margin: 0 auto;">

        <!-- HERO PROFILE -->
        <div class="elite-card profile-hero">
            <div class="avatar-hex">
                <div class="level-badge" id="player-lvl">LVL 1</div>
                <img src="assets/avatar.png" alt="Commander" class="avatar-img">
            </div>

            <div class="hero-stats">
                <span class="hero-rank" id="player-title">INICIADO</span>
                <h1 class="hero-name">GAROSSA</h1>

                <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                    <div
                        style="flex: 1; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; position: relative;">
                        <div id="xp-fill"
                            style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--gold-primary), var(--purple-aether)); box-shadow: 0 0 10px var(--gold-glow);">
                        </div>
                    </div>
                    <span style="font-size: 0.75rem; color: #888;" id="xp-text">0 / 0 XP</span>
                </div>
            </div>

            <div style="text-align: right;">
                <div
                    style="display: flex; align-items: center; gap: 8px; justify-content: flex-end; margin-bottom: 5px;">
                    <div class="pulse-dot"></div>
                    <span style="color: var(--emerald-life); font-weight: 600; font-size: 0.9rem;">SISTEMA ACTIVO</span>
                </div>
                <div style="font-size: 0.7rem; color: #666;" id="last-update">Sincronizando...</div>
            </div>
        </div>

        <!-- QUEST PLATE -->
        <div class="elite-card quest-plate">
            <div class="quest-glow-icon">üìú</div>
            <div class="quest-details" style="flex: 1;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 id="quest-name">Buscando Misi√≥n...</h3>
                    <span id="quest-status"
                        style="font-size: 0.7rem; padding: 2px 8px; border: 1px solid #444; border-radius: 4px; color: #888;">SYNC</span>
                </div>
                <p id="quest-desc">Analizando flujos del mercado...</p>
                <div id="quest-reward" style="margin-top: 5px; font-size: 0.8rem; color: var(--gold-primary);"></div>
            </div>
        </div>

        <!-- STATS HEX GRID -->
        <div class="stats-hex-grid">
            <div class="stat-cell">
                <span class="stat-label">Total Realizado</span>
                <span class="stat-val gold" id="total-profit">$0.00</span>
            </div>
            <div class="stat-cell">
                <span class="stat-label">Bot√≠n Diario</span>
                <span class="stat-val" id="daily-profit">$0.00</span>
            </div>
            <div class="stat-cell">
                <span class="stat-label">Flotante (PnL)</span>
                <span class="stat-val" id="unrealized-pnl">$0.00</span>
            </div>
            <div class="stat-cell">
                <span class="stat-label">Valor Imperio</span>
                <span class="stat-val cyan" id="global-equity">$0.00</span>
            </div>
            <div class="stat-cell">
                <span class="stat-label">Retorno (ROI)</span>
                <span class="stat-val" id="global-roi">0%</span>
            </div>
            <div class="stat-cell">
                <span class="stat-label">√ìrdenes Activas</span>
                <span class="stat-val" id="active-orders">0</span>
            </div>
        </div>

        <!-- COMPANION GRID -->
        <h2 style="margin-bottom: 25px; color: #fff; font-size: 1.2rem;">üõ°Ô∏è ESCUADR√ìN DE COMBATE</h2>
        <div class="companion-grid" id="bot-grid">
            <!-- INJECTED BY JS -->
        </div>

        <div class="elite-card" style="margin-top: 40px; padding: 20px; min-height: 300px;">
            <h3 style="color: #666; font-size: 0.8rem; margin-bottom: 20px;">MAPA DE CONQUISTA (PROFIT)</h3>
            <div style="height: 300px; position: relative;">
                <canvas id="global-profit-chart"></canvas>
            </div>
        </div>

        <div class="footer">
            NEXUS ELITE OPERATIONS TERMINAL v2.0
        </div>
    </div>

    <script>
        // === CONFIG ===
        const BOTS = [
            { id: 'btc', name: 'IGNIS', role: 'Esp√≠ritu de Fuego', icon: 'üî•', url: '/' },
            { id: 'sol', name: 'VENTUS', role: 'Esp√≠ritu de Aire', icon: 'üå¨Ô∏è', url: '/sol/' },
            { id: 'doge', name: 'FANG', role: 'Esp√≠ritu de Manada', icon: 'üê∫', url: '/doge/' }
        ];

        const ASSETS = {
            'btc': 'assets/spirit-btc.png',
            'sol': 'assets/spirit-sol.png',
            'doge': 'assets/spirit-doge.png'
        };

        // === RENDER ===
        function renderCompanions() {
            const grid = document.getElementById('bot-grid');
            grid.innerHTML = BOTS.map(bot => `
                <div class="companion-card ${bot.id}">
                    <div class="c-banner">
                        <span class="c-regime-badge" id="regime-${bot.id}">ANALIZANDO</span>
                        <div class="pulse-dot" id="dot-${bot.id}" style="background:#555; box-shadow:none; animation:none;"></div>
                    </div>
                    <div class="c-avatar">
                        <img src="${ASSETS[bot.id]}" alt="${bot.name}">
                    </div>
                    
                    <div class="c-body">
                        <div class="c-header">
                            <h2 class="c-name">${bot.name}</h2>
                            <span class="c-role">${bot.role}</span>
                        </div>

                        <div class="c-metrics">
                            <div class="c-metric">
                                <span class="c-val" id="price-${bot.id}">-</span>
                                <div class="c-lbl">Precio Actual</div>
                            </div>
                            <div class="c-metric">
                                <span class="c-val gold" id="profit-${bot.id}">-</span>
                                <div class="c-lbl">Profit Total</div>
                            </div>
                            <div class="c-metric">
                                <span class="c-val" id="roi-${bot.id}">-</span>
                                <div class="c-lbl">ROI Hist√≥rico</div>
                            </div>
                            <div class="c-metric">
                                <span class="c-val" id="winrate-${bot.id}">-</span>
                                <div class="c-lbl">Win Rate</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#888; margin-bottom:4px;">
                                <span>CONFIANZA (IA)</span>
                                <span id="score-val-${bot.id}">50</span>
                            </div>
                            <div class="c-score-bar">
                                <div class="c-score-fill" id="score-bar-${bot.id}" style="width: 50%"></div>
                            </div>
                        </div>

                        <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:#666; border-top:1px solid rgba(255,255,255,0.05); padding-top:10px;">
                            <span id="orders-${bot.id}">0 √ìrdenes</span>
                            <span id="lots-${bot.id}">0 Lots</span>
                        </div>
                        
                        <div id="status-text-${bot.id}" style="margin-top: 10px; font-size: 0.7rem; color: var(--gold-dim); display:none;"></div>

                        <a href="${bot.url}" style="display:block; margin-top:15px; text-align:center; padding:8px; opacity:0; transition:opacity 0.2s;" class="hover-show">
                            <span style="font-size:0.7rem; color:var(--purple-aether);">ACCESO NEURONAL ></span>
                        </a>
                    </div>
                </div>
            `).join('');

            // Hover effect for link
            document.querySelectorAll('.companion-card').forEach(card => {
                card.addEventListener('mouseenter', () => card.querySelector('a').style.opacity = 1);
                card.addEventListener('mouseleave', () => card.querySelector('a').style.opacity = 0);
            });
        }

        // === LOGIC ===
        async function updateDashboard() {
            let tProfit = 0, tDaily = 0, tUnreal = 0, tOrders = 0, tEquity = 0;
            let botsActive = 0;

            for (const bot of BOTS) {
                try {
                    const url = bot.url === '/' ? '/api/status' : `${bot.url}api/status`;
                    const res = await fetch(url);
                    if (res.ok) {
                        const data = await res.json();
                        updateBotUI(bot.id, data);

                        tProfit += data.totalProfit || 0;
                        tDaily += data.dailyProfit || 0;
                        tUnreal += data.unrealizedPnL || 0;
                        tOrders += data.activeOrders || 0;

                        // Equity fallback logic
                        if (bot.id === 'btc' && data.globalEquity) tEquity = data.globalEquity;

                        if (data.status === 'running') botsActive++;
                    }
                } catch (e) { console.warn(bot.id, e); }
            }

            // Equity Source of Truth
            try {
                const eqRes = await fetch('/api/balance');
                if (eqRes.ok) {
                    const eqData = await eqRes.json();
                    if (eqData.totalEquity) tEquity = eqData.totalEquity;
                }
            } catch (e) { }

            // Update Globals
            document.getElementById('total-profit').innerText = `$${tProfit.toFixed(2)}`;
            document.getElementById('daily-profit').innerText = `$${tDaily.toFixed(2)}`;
            document.getElementById('unrealized-pnl').innerText = `$${tUnreal.toFixed(2)}`;
            document.getElementById('unrealized-pnl').className = `stat-val ${tUnreal >= 0 ? '' : 'neg'}`; // Make red if neg
            document.getElementById('global-equity').innerText = `$${tEquity.toFixed(2)}`;
            document.getElementById('active-orders').innerText = tOrders;

            if (tEquity > tProfit) {
                const roi = (tProfit / (tEquity - tProfit)) * 100;
                document.getElementById('global-roi').innerText = `${roi.toFixed(1)}%`;
            }

            document.getElementById('loading').style.opacity = 0;
            setTimeout(() => document.getElementById('loading').style.display = 'none', 500);

            document.getElementById('last-update').innerText = 'ACTUALIZADO: ' + new Date().toLocaleTimeString();
        }

        function updateBotUI(id, data) {
            // Regime
            const regimeEl = document.getElementById(`regime-${id}`);
            regimeEl.innerText = data.marketRegime || 'NEUTRAL';
            regimeEl.style.color = data.marketRegime && data.marketRegime.includes('BULL') ? 'var(--emerald-life)' :
                data.marketRegime && data.marketRegime.includes('BEAR') ? 'var(--ruby-danger)' : '#888';

            // Dot
            const dot = document.getElementById(`dot-${id}`);
            if (data.status === 'running') {
                dot.style.background = 'var(--emerald-life)';
                dot.style.boxShadow = '0 0 10px var(--emerald-life)';
                dot.style.animation = 'pulse 2s infinite';
            } else {
                dot.style.background = 'var(--ruby-danger)';
                dot.style.boxShadow = 'none';
                dot.style.animation = 'none';
            }

            // Metrics
            document.getElementById(`profit-${id}`).innerText = `$${(data.totalProfit || 0).toFixed(2)}`;

            const price = data.currentPrice || 0;
            document.getElementById(`price-${id}`).innerText = price > 1000 ? `$${price.toFixed(0)}` : price > 1 ? `$${price.toFixed(2)}` : `$${price.toFixed(4)}`;

            document.getElementById(`roi-${id}`).innerText = `${(data.roi || 0).toFixed(2)}%`;

            document.getElementById(`winrate-${id}`).innerText = `${(data.winRate || 0).toFixed(0)}%`;

            // Score
            document.getElementById(`score-val-${id}`).innerText = data.score || 50;
            const bar = document.getElementById(`score-bar-${id}`);
            bar.style.width = `${data.score || 50}%`;
            if ((data.score || 50) > 60) bar.classList.add('high');
            else bar.classList.remove('high');

            // Footer
            document.getElementById(`orders-${id}`).innerText = `${data.activeOrders || 0} √ìrd.`;
            document.getElementById(`lots-${id}`).innerText = `${data.inventoryLots || 0} Lots`;

            // Status Text (Blocking)
            const statusTxt = document.getElementById(`status-text-${id}`);
            if (data.blockingReason || data.isPaused) {
                statusTxt.style.display = 'block';
                statusTxt.innerText = `‚ö†Ô∏è ${data.blockingReason || 'PAUSADO'}`;
            } else {
                statusTxt.style.display = 'none';
            }
        }

        async function fetchRPG() {
            try {
                const res = await fetch('/api/rpg');
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('player-lvl').innerText = `LVL ${data.level || 1}`;
                    document.getElementById('player-title').innerText = data.title || 'INICIADO';
                    document.getElementById('xp-text').innerText = `${data.xp} / ${data.nextLevelXp} XP`;
                    document.getElementById('xp-fill').style.width = `${data.xpProgress}%`;

                    if (data.quest) {
                        document.getElementById('quest-name').innerText = data.quest.name;
                        document.getElementById('quest-desc').innerText = data.quest.objective;
                        const st = document.getElementById('quest-status');
                        st.innerText = data.quest.status === 'COMPLETED' ? 'COMPLETADA' : 'EN PROGRESO';
                        st.style.color = data.quest.status === 'COMPLETED' ? 'var(--emerald-life)' : 'var(--gold-primary)';
                        st.style.borderColor = data.quest.status === 'COMPLETED' ? 'var(--emerald-life)' : 'var(--gold-primary)';

                        if (data.quest.reward) document.getElementById('quest-reward').innerText = `üèÜ RECOMPENSA: ${data.quest.reward}`;
                    }
                }
            } catch (e) { }
        }

        async function fetchChart() {
            try {
                const res = await fetch('/api/profit-history');
                if (res.ok) {
                    const data = await res.json();
                    renderChart(data.history || []);
                }
            } catch (e) { }
        }

        function renderChart(history) {
            const ctx = document.getElementById('global-profit-chart').getContext('2d');
            const last30 = history.slice(-30);

            if (window.myChart) window.myChart.destroy();

            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30.map(h => h.date.substring(5)),
                    datasets: [{
                        label: 'Bot√≠n Diario (USD)',
                        data: last30.map(h => h.dailyProfit),
                        borderColor: '#00ff9d',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                            gradient.addColorStop(0, 'rgba(0, 255, 157, 0.4)');
                            gradient.addColorStop(1, 'rgba(0, 255, 157, 0)');
                            return gradient;
                        },
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#666' } },
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#666' } }
                    }
                }
            });
        }

        function init() {
            renderCompanions();
            updateDashboard();
            fetchRPG();
            fetchChart();
            setInterval(updateDashboard, 5000);
            setInterval(fetchRPG, 60000);
            setInterval(fetchChart, 60000);
        }

        init();
    </script>
</body>

</html>