<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS ELITE - Dashboard</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link href="styles/rpg-theme.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>

    <div class="loading-overlay" id="loading"
        style="position:fixed; inset:0; background:#050508; display:flex; align-items:center; justify-content:center; z-index:9999; transition:opacity 0.5s;">
        <div class="loader"
            style="width:50px; height:50px; border:3px solid #333; border-top-color:var(--gold-primary); border-radius:50%; animation:spin 1s infinite linear;">
        </div>
    </div>
    <style>
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>

    <div class="container" style="max-width: 1600px; margin: 0 auto; padding: 20px;">

        <!-- HEADER / PROFILE -->
        <div class="elite-card profile-hero" style="margin-bottom: 30px;">
            <div class="avatar-hex" style="width: 100px; height: 100px;">
                <div class="level-badge" id="player-lvl">LVL 1</div>
                <img src="assets/avatar.png" alt="Commander" class="avatar-img">
            </div>

            <div class="hero-stats" style="padding-left: 20px;">
                <span class="hero-rank" id="player-title">INICIADO</span>
                <h1 class="hero-name" style="font-size: 1.8rem;">GAROSSA</h1>
                <div style="display: flex; align-items: center; gap: 15px; margin-top: 5px; max-width: 400px;">
                    <div
                        style="flex: 1; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden;">
                        <div id="xp-fill" style="width: 0%; height: 100%; background: var(--gold-primary);"></div>
                    </div>
                    <span style="font-size: 0.7rem; color: #888;" id="xp-text">0/0 XP</span>
                </div>

                <!-- Global Status Indicator -->
                <div style="margin-top: 10px; font-size: 0.75rem; color: var(--emerald-life); font-weight: 600;">
                    <span id="global-status-text">ESPERANDO SE√ëAL...</span>
                </div>
            </div>

            <div class="quest-mini-plate"
                style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; min-width: 300px;">
                <div style="font-size: 0.7rem; color: var(--gold-dim); margin-bottom: 5px;">üìú MISI√ìN ACTIVA</div>
                <div id="quest-name" style="color: #fff; font-weight: 600;">Sincronizando...</div>
                <div id="quest-status" style="font-size: 0.65rem; color: #888; margin-top: 5px;">-</div>
                <div id="quest-reward"
                    style="font-size: 0.7rem; color: var(--gold-primary); margin-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 6px;">
                </div>
            </div>
        </div>

        <!-- GLOBAL STATS ROW -->
        <div class="stats-hex-grid"
            style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 30px;">
            <div class="stat-cell">
                <span class="stat-label">Total Realizado</span>
                <span class="stat-val gold" id="total-profit">$0.00</span>
            </div>
            <div class="stat-cell">
                <span class="stat-label">Bot√≠n Diario</span>
                <span class="stat-val" id="daily-profit">$0.00</span>
            </div>
            <div class="stat-cell">
                <span class="stat-label">Flotante</span>
                <span class="stat-val" id="unrealized-pnl">$0.00</span>
            </div>
            <div class="stat-cell">
                <span class="stat-label">Equity Global</span>
                <span class="stat-val cyan" id="global-equity">$0.00</span>
            </div>
            <div class="stat-cell">
                <span class="stat-label">ROI Total</span>
                <span class="stat-val" id="global-roi">0%</span>
            </div>
            <div class="stat-cell">
                <span class="stat-label">√ìrdenes</span>
                <span class="stat-val" id="active-orders">0</span>
            </div>
        </div>

        <!-- COMPANION GRID (FULL SIZE) -->
        <h2
            style="margin-bottom: 25px; color: #fff; font-size: 1.2rem; border-bottom: 1px solid #333; padding-bottom: 10px;">
            üõ°Ô∏è ESP√çRITUS GUARDIANES
        </h2>

        <div class="companion-grid" id="bot-grid" style="gap: 20px;">
            <!-- INJECTED BY JS -->
        </div>

        <!-- CHART -->
        <div class="elite-card" style="margin-top: 40px; padding: 20px;">
            <h3 style="color: #888; font-size: 0.9rem; margin-bottom: 15px;">PROYECCI√ìN DE RIQUEZA (30 D√çAS)</h3>
            <div style="height: 300px; width: 100%; position: relative;">
                <canvas id="global-profit-chart"></canvas>
            </div>
        </div>

        <div class="footer" style="margin-top: 30px; font-size: 0.7rem; color: #444; text-align: center;">
            <div id="last-update">Sincronizando...</div>
        </div>
    </div>

    <script>
        // === CONFIG ===
        const BOTS = [
            { id: 'btc', name: 'IGNIS', role: 'Esp√≠ritu de Fuego (BTC)', icon: 'üî•', url: '/' },
            { id: 'sol', name: 'VENTUS', role: 'Esp√≠ritu de Viento (SOL)', icon: 'üå¨Ô∏è', url: '/sol/' },
            { id: 'doge', name: 'FANG', role: 'Esp√≠ritu de Manada (DOGE)', icon: 'üê∫', url: '/doge/' }
        ];

        const ASSETS = {
            'btc': 'assets/spirit-btc.png',
            'sol': 'assets/spirit-sol.png',
            'doge': 'assets/spirit-doge.png'
        };

        // Debug logger
        function logDebug(msg) {
            console.log('[RPG-DEBUG]', msg);
            const debugEl = document.getElementById('debug-log');
            if (debugEl) {
                debugEl.innerHTML += `<div>${new Date().toLocaleTimeString()} - ${msg}</div>`;
            }
        }

        // === RENDER ===
        function renderCompanions() {
            const grid = document.getElementById('bot-grid');
            if (!grid) return;

            grid.innerHTML = BOTS.map(bot => `
                <div class="elite-card companion-full-card ${bot.id}" id="card-${bot.id}" style="display: flex; flex-direction: column; overflow: hidden; min-height: 500px;">
                    <!-- IMAGE HERO SECTION -->
                    <div style="height: 220px; position: relative; overflow: hidden; background: #000;">
                        <!-- Status Indicator -->
                        <div style="position: absolute; top: 15px; left: 15px; z-index: 10; display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);">
                            <div class="pulse-dot" id="dot-${bot.id}" style="width: 10px; height: 10px;"></div>
                            <span id="status-label-${bot.id}" style="color: #fff; font-weight: bold; font-size: 0.8rem;">INIT...</span>
                        </div>

                         <div style="position: absolute; top: 15px; right: 15px; z-index: 10;">
                             <span class="c-regime-badge" id="regime-${bot.id}" style="background: rgba(0,0,0,0.8); padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; color: #fff; border: 1px solid #333;">-</span>
                         </div>

                        <img src="${ASSETS[bot.id]}" alt="${bot.name}" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.9; mask-image: linear-gradient(to bottom, black 20%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%);">
                        
                        <div style="position: absolute; bottom: 10px; left: 15px;">
                            <h2 style="margin: 0; font-size: 2rem; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.8);">${bot.name}</h2>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8);">${bot.role}</div>
                        </div>
                    </div>

                    <!-- DATA SECTION -->
                    <div style="padding: 20px; flex: 1; display: flex; flex-direction: column; gap: 15px; background: rgba(10,10,15,0.95);">
                        
                        <!-- ROW 1: PRICE & PROFIT -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="background: rgba(255,255,255,0.03); padding: 10px; border-radius: 6px;">
                                <div style="font-size: 0.65rem; color: #666;">PRECIO</div>
                                <div id="price-${bot.id}" style="font-size: 1.1rem; color: #fff;">-</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.03); padding: 10px; border-radius: 6px;">
                                <div style="font-size: 0.65rem; color: #666;">PROFIT TOTAL</div>
                                <div id="profit-${bot.id}" style="font-size: 1.1rem; color: var(--gold-primary);">-</div>
                            </div>
                        </div>

                        <!-- ROW 2: DAILY & ROI -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <div style="font-size: 0.65rem; color: #666;">HOY</div>
                                <div id="daily-${bot.id}" style="font-size: 0.9rem; color: #eee;">-</div>
                            </div>
                            <div>
                                <div style="font-size: 0.65rem; color: #666;">ROI</div>
                                <div id="roi-${bot.id}" style="font-size: 0.9rem; color: #eee;">-</div>
                            </div>
                        </div>
                        
                        <!-- ROW 3: STATS GRID -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; text-align: center; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 15px;">
                            <div>
                                <div style="font-size: 0.6rem; color: #555;">WINRATE</div>
                                <div id="winrate-${bot.id}" style="font-size: 1rem; color: #fff;">-</div>
                                <div id="trades-${bot.id}" style="font-size: 0.6rem; color: #444;">0 trades</div>
                            </div>
                            <div>
                                <div style="font-size: 0.6rem; color: #555;">ORDENES</div>
                                <div id="orders-${bot.id}" style="font-size: 1rem; color: #fff;">-</div>
                                <div id="lots-${bot.id}" style="font-size: 0.6rem; color: #444;">0 lots</div>
                            </div>
                            <div>
                                <div style="font-size: 0.6rem; color: #555;">SCORE</div>
                                <div id="score-${bot.id}" style="font-size: 1rem; color: #fff;">-</div>
                            </div>
                        </div>

                        <!-- LAST TRADE ROW -->
                        <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; font-size: 0.75rem;">
                            <div style="color: #666; margin-bottom: 2px;">√öLTIMO TRADE</div>
                            <div id="last-trade-${bot.id}" style="color: #ccc;">Sin actividad reciente</div>
                        </div>

                        <!-- BLOCKING / STATUS -->
                        <div id="blocking-${bot.id}" style="display: none; background: rgba(255,100,100,0.1); border: 1px solid rgba(255,100,100,0.2); color: var(--ruby-danger); padding: 8px; font-size: 0.7rem; border-radius: 4px;"></div>

                        <!-- CTA -->
                        <div style="margin-top: auto; padding-top: 10px;">
                            <a href="${bot.url}" target="_blank" style="display: block; width: 100%; box-sizing: border-box; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #fff; text-align: center; text-decoration: none; font-size: 0.8rem; border-radius: 6px; transition: background 0.2s;">
                                ACCESO A TERMINAL &rarr;
                            </a>
                        </div>
                        
                        <!-- DEBUG FIELD -->
                        <div id="debug-${bot.id}" style="font-size: 0.6rem; color: #ff2a6d; margin-top: 5px; min-height: 15px;"></div>
                    </div>
                </div>
            `).join('');
        }

        // === LOGIC ===
        async function updateDashboard() {
            let tProfit = 0, tDaily = 0, tUnreal = 0, tOrders = 0, tEquity = 0, tYesterday = 0, tDailyTrades = 0;
            let botsActive = 0;

            for (const bot of BOTS) {
                try {
                    const url = bot.url === '/' ? '/api/status' : `${bot.url}api/status`;
                    const res = await fetch(url);
                    if (res.ok) {
                        const data = await res.json();
                        updateBotUI(bot.id, data);

                        tProfit += data.totalProfit || 0;
                        tDaily += data.dailyProfit || 0;
                        tYesterday += data.yesterdayProfit || 0;
                        tUnreal += data.unrealizedPnL || 0;
                        tOrders += data.activeOrders || 0;
                        tDailyTrades += data.dailyTrades || 0;

                        // Strict check: dashboard.html specific logic: If response is OK, bot is Online.
                        botsActive++;

                        if (bot.id === 'btc' && data.globalEquity) tEquity = data.globalEquity;
                    } else {
                        updateBotOffline(bot.id, `HTTP ${res.status}`);
                    }
                } catch (e) {
                    updateBotOffline(bot.id, 'NET ERR');
                    logDebug(`Error fetching ${bot.id}: ${e.message}`);
                }
            }

            // GLOBAL STATUS INDICATOR
            const globalStatusEl = document.getElementById('global-status-text');
            if (globalStatusEl) {
                globalStatusEl.innerText = `SISTEMA: ${botsActive} / 3 CONSTRUCTOS ONLINE`;
                globalStatusEl.style.color = botsActive === 3 ? 'var(--emerald-life)' : botsActive > 0 ? 'var(--gold-primary)' : 'var(--ruby-danger)';
            }

            try {
                const eqRes = await fetch('/api/balance');
                if (eqRes.ok) {
                    const eqData = await eqRes.json();
                    if (eqData.totalEquity) tEquity = eqData.totalEquity;
                }
            } catch (e) { }

            document.getElementById('total-profit').innerText = `$${tProfit.toFixed(2)}`;

            // Daily Profit: 3-Row Layout (Fixed Duplication & Font Size)
            const dailyEl = document.getElementById('daily-profit');
            dailyEl.style.display = 'flex';
            dailyEl.style.flexDirection = 'column';
            dailyEl.style.alignItems = 'center';
            dailyEl.style.lineHeight = '1.2';

            // REMOVED 'BOT√çN DIARIO' LABEL FROM HERE TO AVOID DUPLICATION
            dailyEl.innerHTML = `
                <span style="font-size: 1.5rem; color: #fff; margin-top: 5px;">$${tDaily.toFixed(2)}</span>
                <span style="font-size: 0.85rem; color: #aaa; margin-top: 4px;">(${tDailyTrades} trades ¬∑ Ayer: $${tYesterday.toFixed(2)})</span>
            `;

            document.getElementById('unrealized-pnl').innerText = `$${tUnreal.toFixed(2)}`;
            document.getElementById('unrealized-pnl').className = `stat-val ${tUnreal >= 0 ? '' : 'neg'}`;
            document.getElementById('global-equity').innerText = `$${tEquity.toFixed(2)}`;
            document.getElementById('active-orders').innerText = tOrders;

            if (tEquity > tProfit) {
                const roi = (tProfit / (tEquity - tProfit)) * 100;
                document.getElementById('global-roi').innerText = `${roi.toFixed(1)}%`;
            }

            document.getElementById('loading').style.opacity = 0;
            setTimeout(() => document.getElementById('loading').style.display = 'none', 500);

            document.getElementById('last-update').innerText = 'ACTUALIZADO: ' + new Date().toLocaleTimeString();
        }

        function updateBotUI(id, data) {
            // Regime
            document.getElementById(`regime-${id}`).innerText = data.marketRegime || 'NEUTRAL';

            // Dot & Status
            const dot = document.getElementById(`dot-${id}`);
            const statusLbl = document.getElementById(`status-label-${id}`);

            // Use broader definition of online to match stable dashboard
            // If data exists, it's effectively online
            dot.style.background = 'var(--emerald-life)';
            dot.style.boxShadow = '0 0 10px var(--emerald-life)';

            if (data.status === 'running') {
                if (data.smartDcaBlocking) {
                    statusLbl.innerText = "BLOCKED";
                    statusLbl.style.color = "var(--gold-primary)";
                } else {
                    statusLbl.innerText = "ONLINE";
                    statusLbl.style.color = "var(--emerald-life)";
                }
            } else {
                statusLbl.innerText = data.status ? data.status.toUpperCase() : "STANDBY";
                statusLbl.style.color = "var(--gold-primary)";
            }
            // Clear debug
            document.getElementById(`debug-${id}`).innerText = "";

            // Metrics
            document.getElementById(`profit-${id}`).innerText = `$${(data.totalProfit || 0).toFixed(2)}`;

            const price = data.currentPrice || 0;
            document.getElementById(`price-${id}`).innerText = price > 1000 ? `$${price.toFixed(0)}` : price > 1 ? `$${price.toFixed(2)}` : `$${price.toFixed(4)}`;

            document.getElementById(`roi-${id}`).innerText = `${(data.roi || 0).toFixed(2)}%`;
            document.getElementById(`daily-${id}`).innerText = `$${(data.dailyProfit || 0).toFixed(2)}`;

            const winRate = data.winRate || 0;
            const wrEl = document.getElementById(`winrate-${id}`);
            wrEl.innerText = `${winRate.toFixed(0)}%`;
            wrEl.style.color = winRate >= 70 ? 'var(--emerald-life)' : winRate >= 50 ? 'var(--gold-primary)' : 'var(--ruby-danger)';

            document.getElementById(`trades-${id}`).innerText = `${data.totalTrades || 0} trades`;

            // Score
            document.getElementById(`score-${id}`).innerText = data.score || 50;

            // Counts
            document.getElementById(`orders-${id}`).innerText = data.activeOrders || 0;
            document.getElementById(`lots-${id}`).innerText = data.inventoryLots || 0;

            // Last Trade Logic
            if (data.lastTrade) {
                const now = Date.now();
                const tradeTime = new Date(data.lastTrade.timestamp).getTime();
                const diffMins = Math.floor((now - tradeTime) / 60000);
                let timeAgo = diffMins < 60 ? `${diffMins}m ago` : `${Math.floor(diffMins / 60)}h ago`;

                const side = data.lastTrade.side.toUpperCase();
                const profit = data.lastTrade.profit ? `(+$${data.lastTrade.profit.toFixed(2)})` : '';
                const color = side === 'SELL' ? 'var(--emerald-life)' : '#fff';

                document.getElementById(`last-trade-${id}`).innerHTML = `<span style="color:${color}; font-weight:bold;">${side}</span> ${profit} <span style="opacity:0.6">¬∑ ${timeAgo}</span>`;
            } else {
                document.getElementById(`last-trade-${id}`).innerText = "Sin actividad reciente";
            }

            // Blocking
            const blockEl = document.getElementById(`blocking-${id}`);
            if (data.blockingReason || data.isPaused) {
                blockEl.style.display = 'block';
                blockEl.innerText = `‚ö†Ô∏è ${data.blockingReason || 'PAUSADO'}`;
            } else {
                blockEl.style.display = 'none';
            }
        }

        function updateBotOffline(id, reason = "OFFLINE") {
            const dot = document.getElementById(`dot-${id}`);
            const statusLbl = document.getElementById(`status-label-${id}`);
            const debugEl = document.getElementById(`debug-${id}`);

            if (dot) dot.style.background = '#555';
            if (statusLbl) {
                statusLbl.innerText = reason;
                statusLbl.style.color = "#888";
            }
            if (debugEl) {
                debugEl.innerText = `Conn fail: ${reason}`;
            }
        }

        async function fetchRPG() {
            try {
                const res = await fetch('/api/rpg');
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('player-lvl').innerText = `LVL ${data.level || 1}`;
                    document.getElementById('player-title').innerText = data.title || 'INICIADO';
                    document.getElementById('xp-text').innerText = `${data.xp} / ${data.nextLevelXp} XP`;
                    document.getElementById('xp-fill').style.width = `${data.xpProgress}%`;

                    if (data.quest) {
                        document.getElementById('quest-name').innerText = data.quest.name;
                        document.getElementById('quest-status').innerText = data.quest.status === 'COMPLETED' ? 'COMPLETADA' : 'EN PROGRESO';
                        document.getElementById('quest-status').style.color = data.quest.status === 'COMPLETED' ? 'var(--emerald-life)' : 'var(--gold-primary)';

                        if (data.quest.reward) {
                            document.getElementById('quest-reward').innerText = `üèÜ RECOMPENSA: ${data.quest.reward}`;
                        }
                    }
                }
            } catch (e) { }
        }

        async function fetchChart() {
            try {
                const res = await fetch('/api/profit-history');
                if (res.ok) {
                    const data = await res.json();
                    if (data.history && data.history.length > 0) {
                        renderChart(data.history);
                    } else {
                        logDebug("Chart data empty");
                    }
                } else {
                    logDebug("Chart fetch failed");
                }
            } catch (e) {
                logDebug("Chart API error: " + e.message);
            }
        }

        function renderChart(history) {
            const canvas = document.getElementById('global-profit-chart');
            if (!canvas) return;

            // Cleanup existing chart properly
            if (window.myChart instanceof Chart) {
                window.myChart.destroy();
            }

            const ctx = canvas.getContext('2d');
            const last30 = history.slice(-30);

            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30.map(h => h.date.substring(5)),
                    datasets: [{
                        label: 'Bot√≠n Diario (USD)',
                        data: last30.map(h => h.dailyProfit),
                        borderColor: '#00ff9d',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                            gradient.addColorStop(0, 'rgba(0, 255, 157, 0.4)');
                            gradient.addColorStop(1, 'rgba(0, 255, 157, 0)');
                            return gradient;
                        },
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#00ff9d'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.9)',
                            titleColor: '#fff',
                            bodyColor: '#00ff9d',
                            callbacks: {
                                label: function (context) {
                                    return 'Profit: $' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#666', font: { size: 10 } }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#666', callback: function (value) { return '$' + value; } }
                        }
                    }
                }
            });
        }

        function init() {
            renderCompanions();
            // Wait a tick to ensure DOM is ready
            setTimeout(() => {
                updateDashboard();
                fetchRPG();
                fetchChart();
            }, 100);

            setInterval(updateDashboard, 5000);
            setInterval(fetchRPG, 60000);
            setInterval(fetchChart, 60000);
        }

        init();
    </script>
    <div id="debug-log"
        style="position: fixed; bottom: 0; right: 0; background: rgba(0,0,0,0.8); color: lime; padding: 10px; font-family: monospace; font-size: 10px; max-height: 200px; overflow-y: scroll; width: 300px; z-index: 9999; pointer-events: none;">
        <div>DEBUG CONSOLE ACTIVE v4.1</div>
    </div>
</body>

</html>